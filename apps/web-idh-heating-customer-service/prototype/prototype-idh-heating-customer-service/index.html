<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IDH智慧供热客服系统</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- 引入QRCode.js库，用于生成二维码 -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="main.css" />
    <style>
      /* 这里只保留必要的内联样式或动态样式 */

      /* 所有静态样式已移至 main.css */
    </style>
  </head>
  <body>
    <div class="container">
      <!-- 顶部系统描述信息 -->
      <div class="header">
        <div class="header-content">
          <h1><i class="fas fa-fire"></i> IDH智慧供热客服系统</h1>
          <p>
            IDH智慧供热客服系统是一款综合性的供热业务管理平台，集成了工单管理、收费管理、数据分析和系统设置四大核心功能模块。支持工单全生命周期管理，包括工单创建、查询、编辑、详情查看及导入导出；提供线下缴费管理、收据打印和缴费统计；通过多维度统计图表实现数据可视化分析；并支持灵活的系统参数设置。系统采用直观的标签页布局，操作便捷，帮助您全面高效地管理供热客服与收费业务，提升服务质量和管理效率。
          </p>
        </div>
        <!-- 系统设置按钮 -->
        <button
          class="top-btn settings-btn"
          id="settingsBtn"
          onclick="switchToSettings()"
          title="系统设置"
        >
          <i class="fas fa-cog"></i>
        </button>

        <!-- 退出登录按钮 -->
        <button
          class="top-btn logout-btn"
          id="logoutBtn"
          onclick="logout()"
          title="退出登录"
        >
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>

      <!-- 标签页导航 -->
      <div class="navbar">
        <ul>
          <li><a href="#" class="active" data-tab="workorder">客服工单</a></li>
          <li><a href="#" data-tab="cash">线下缴费</a></li>
          <li><a href="#" data-tab="analysis">统计分析</a></li>
          <li><a href="#" data-tab="settings">系统设置</a></li>
        </ul>
      </div>

      <!-- 标签页内容容器 -->
      <div class="tab-content-container">
        <!-- 客服工单标签页 -->
        <div id="workorder-tab" class="tab-content active">
          <!-- 统计卡片 -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <i class="fas fa-chart-bar"></i> 工单统计
              </div>
            </div>
            <div class="stats-container">
              <div class="stat-card">
                <div class="stat-icon danger">
                  <i class="fas fa-tasks"></i>
                </div>
                <div class="stat-value">0</div>
                <div class="stat-label">总工单数</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon warning">
                  <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="stat-value">0</div>
                <div class="stat-label">未开始</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon primary">
                  <i class="fas fa-clock"></i>
                </div>
                <div class="stat-value">0</div>
                <div class="stat-label">进行中</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon success">
                  <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-value">0</div>
                <div class="stat-label">已办结</div>
              </div>
            </div>
          </div>

          <!-- 功能区 -->
          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="fas fa-cogs"></i> 功能操作</div>
            </div>

            <!-- 第一行按钮 -->
            <div class="btn-group">
              <button class="btn btn-primary" id="createTicketBtn">
                <i class="fas fa-plus-circle"></i> 新建
              </button>
              <button class="btn btn-danger" id="exportTicketBtn">
                <i class="fas fa-download"></i> 导出
              </button>
            </div>

            <!-- 第二行查询条件 -->
            <div class="card-header">
              <div class="card-title">
                <i class="fas fa-search"></i> 工单查询
              </div>
            </div>

            <div class="search-form">
              <div class="form-group">
                <label for="searchCommunity">小区名称</label>
                <select class="form-control" id="searchCommunity">
                  <option value="">全部</option>
                </select>
              </div>

              <div class="form-group">
                <label for="searchBuilding">楼号</label>
                <select class="form-control" id="searchBuilding">
                  <option value="">全部</option>
                </select>
              </div>

              <div class="form-group">
                <label for="searchUnit">单元</label>
                <select class="form-control" id="searchUnit">
                  <option value="">全部</option>
                </select>
              </div>

              <div class="form-group">
                <label for="searchRoom">房号</label>
                <select class="form-control" id="searchRoom">
                  <option value="">全部</option>
                </select>
              </div>

              <div class="form-group">
                <label for="searchOwner">业主姓名</label>
                <input
                  type="text"
                  class="form-control"
                  id="searchOwner"
                  placeholder="请输入业主姓名"
                />
              </div>

              <div class="form-group">
                <label for="searchPhone">电话</label>
                <input
                  type="text"
                  class="form-control"
                  id="searchPhone"
                  placeholder="请输入电话"
                />
              </div>

              <div class="form-group">
                <label for="searchHeatingSeason">供暖季时间</label>
                <select class="form-control" id="searchHeatingSeason">
                  <option value="">全部</option>
                  <option value="2024-2025">2024-2025</option>
                  <option value="2025-2026">2025-2026</option>
                </select>
              </div>

              <div class="form-group">
                <label for="searchPaymentStatus">缴费状态</label>
                <select class="form-control" id="searchPaymentStatus">
                  <option value="">全部</option>
                  <option value="已缴费">已缴费</option>
                  <option value="欠费">欠费</option>
                </select>
              </div>

              <div class="form-group">
                <label for="searchFeeType">费用类型</label>
                <select class="form-control" id="searchFeeType">
                  <option value="">全部</option>
                  <option value="全费">全费</option>
                  <option value="空置费">空置费</option>
                </select>
              </div>

              <div class="form-group">
                <label for="searchTicketType">工单类型</label>
                <select class="form-control" id="searchTicketType">
                  <option value="">全部</option>
                  <option value="咨询">咨询</option>
                  <option value="缴费">缴费</option>
                  <option value="报修">报修</option>
                  <option value="投诉（客观）">投诉（客观）</option>
                  <option value="投诉（主观）">投诉（主观）</option>
                </select>
              </div>

              <div class="form-group">
                <label for="searchTicketStatus">工单状态</label>
                <select class="form-control" id="searchTicketStatus">
                  <option value="">全部</option>
                  <option value="未开始">未开始</option>
                  <option value="进行中">进行中</option>
                  <option value="已办结">已办结</option>
                  <option value="已撤销">已撤销</option>
                  <option value="已删除">已删除</option>
                  <option value="已关闭">已关闭</option>
                </select>
              </div>

              <div class="form-group">
                <label>&nbsp;</label>
                <button class="btn btn-accent" id="searchBtn">
                  <i class="fas fa-search"></i> 查询
                </button>
              </div>
            </div>
          </div>

          <!-- 工单列表 -->
          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="fas fa-list"></i> 工单列表</div>
            </div>

            <div class="table-container ticket-list-container">
              <table id="ticketTable" class="ticket-list-table">
                <thead class="ticket-list-header">
                  <tr>
                    <th class="ticket-list-header-cell">工单号</th>
                    <th class="ticket-list-header-cell">小区</th>
                    <th class="ticket-list-header-cell">楼号</th>
                    <th class="ticket-list-header-cell">单元</th>
                    <th class="ticket-list-header-cell">房号</th>
                    <th class="ticket-list-header-cell">业主</th>
                    <th class="ticket-list-header-cell">电话</th>
                    <th class="ticket-list-header-cell">缴费状态</th>
                    <th class="ticket-list-header-cell">工单类型</th>
                    <th class="ticket-list-header-cell ticket-desc-col">
                      描述
                    </th>
                    <th class="ticket-list-header-cell">工单状态</th>
                    <th class="ticket-list-header-cell">操作</th>
                  </tr>
                </thead>
                <tbody id="ticketTableBody">
                  <!-- 工单数据将通过JavaScript动态填充 -->
                </tbody>
              </table>
            </div>

            <!-- 分页控件 -->
            <div id="ticketPagination" class="pagination">
              <div class="page-info">
                <span>每页显示：</span>
                <select id="pageSize" class="page-size-select">
                  <option value="10" selected>10</option>
                  <option value="30">30</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
                <span>条</span>
              </div>
              <div class="page-controls">
                <button id="firstPage" class="btn btn-sm btn-primary" disabled>
                  <i class="fas fa-angle-double-left"></i> 首页
                </button>
                <button id="prevPage" class="btn btn-sm btn-primary" disabled>
                  <i class="fas fa-angle-left"></i> 上一页
                </button>
                <span class="page-info"
                  >第 <span id="currentPage">1</span> /
                  <span id="totalPages">1</span> 页</span
                >
                <button id="nextPage" class="btn btn-sm btn-primary">
                  下一页 <i class="fas fa-angle-right"></i>
                </button>
                <button id="lastPage" class="btn btn-sm btn-primary">
                  末页 <i class="fas fa-angle-double-right"></i>
                </button>
              </div>
              <div class="page-info">
                <span>共 <span id="totalRecords">0</span> 条记录</span>
              </div>
            </div>
          </div>
        </div>
        <!-- 线下缴费标签页 -->
        <div id="cash-tab" class="tab-content">
          <!-- 统计数据 -->
          <div class="card">
            <div class="card-header payment-stat-header">
              <div class="card-title">
                <i class="fas fa-chart-bar"></i> 缴费统计
              </div>
            </div>
            <div class="stats-container">
              <div class="stat-card stat-0">
                <div class="stat-icon">
                  <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="stat-info">
                  <h3 id="currentCommunity">未设置</h3>
                  <p>当前小区</p>
                </div>
              </div>
              <div class="stat-card stat-1">
                <div class="stat-icon">
                  <i class="fas fa-home"></i>
                </div>
                <div class="stat-info">
                  <h3 id="totalHouseholds">0</h3>
                  <p>总住户数</p>
                </div>
              </div>
              <div class="stat-card stat-2">
                <div class="stat-icon">
                  <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                  <h3 id="totalPaid">0</h3>
                  <p>已缴费数</p>
                </div>
              </div>
              <div class="stat-card stat-3">
                <div class="stat-icon">
                  <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-info">
                  <h3 id="totalAmount">¥0</h3>
                  <p>收费总额</p>
                </div>
              </div>
              <div class="stat-card stat-4">
                <div class="stat-icon">
                  <i class="fas fa-coins"></i>
                </div>
                <div class="stat-info">
                  <h3 id="changeAmount">¥0</h3>
                  <p>零钱总额</p>
                </div>
              </div>
              <div class="stat-card stat-5">
                <div class="stat-icon">
                  <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-info">
                  <h3 id="todayPaid">0</h3>
                  <p>今日缴费数</p>
                </div>
              </div>
              <div class="stat-card stat-6">
                <div class="stat-icon">
                  <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-info">
                  <h3 id="todayAmount">¥0</h3>
                  <p>今日收费总额</p>
                </div>
              </div>
            </div>
          </div>

          <!-- 银行存现卡片 -->
          <div class="card">
            <div class="card-header payment-stat-header">
              <div class="card-title">
                <i class="fas fa-university"></i> 银行存现
              </div>
            </div>
            <div class="card-body">
              <div class="form-row form-row-3col">
                <div class="form-group">
                  <label for="depositDate">存现日期</label>
                  <input
                    type="date"
                    class="form-control"
                    id="depositDate"
                    value=""
                  />
                </div>
                <div class="form-group">
                  <label for="depositCount">当日缴费数</label>
                  <input
                    type="number"
                    class="form-control"
                    id="depositCount"
                    readonly
                    value="0"
                  />
                </div>
                <div class="form-group">
                  <label for="depositShouldPay">当日应存金额(元)</label>
                  <input
                    type="number"
                    class="form-control"
                    id="depositShouldPay"
                    step="0.01"
                    readonly
                    value="0.00"
                  />
                </div>
              </div>
              <div class="form-row form-row-3col">
                <div class="form-group">
                  <label for="depositActualPay">当日实存金额(元)</label>
                  <input
                    type="number"
                    class="form-control"
                    id="depositActualPay"
                    step="0.01"
                    readonly
                    value="0.00"
                  />
                </div>
                <div class="form-group">
                  <label for="depositLoss">存现损耗(元)</label>
                  <input
                    type="number"
                    class="form-control"
                    id="depositLoss"
                    step="0.01"
                    readonly
                    value="0.00"
                  />
                </div>
                <div class="form-group">
                  <label for="depositStatus">存现状态</label>
                  <input
                    type="text"
                    class="form-control"
                    id="depositStatus"
                    readonly
                    value="未存现"
                  />
                </div>
              </div>
              <div class="form-row form-row-center">
                <button id="depositActionBtn" class="btn btn-primary">
                  <i class="fas fa-save"></i> 确认存现
                </button>
              </div>
            </div>
          </div>

          <!-- 功能操作区 -->
          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="fas fa-cogs"></i> 功能操作</div>
            </div>

            <!-- 第一行：小区选择 + 功能按钮 -->
            <div class="payment-toolbar">
              <!-- 功能按钮部分 -->
              <div class="payment-toolbar-buttons">
                <button class="btn btn-primary" id="newPaymentBtn">
                  <i class="fas fa-plus-circle"></i> 新建
                </button>
                <button class="btn btn-danger" id="exportPaymentBtn">
                  <i class="fas fa-download"></i> 导出
                </button>
              </div>
            </div>

            <!-- 第二行查询条件 -->
            <div class="card-header">
              <div class="card-title">
                <i class="fas fa-search"></i> 收费查询
              </div>
            </div>

            <!-- 高级查询表单 -->
            <div class="search-form">
              <!-- 小区名称 -->
              <div class="form-group">
                <label for="cashSearchCommunity">小区名称</label>
                <select class="form-control" id="cashSearchCommunity">
                  <option value="">全部</option>
                </select>
              </div>
              <!-- 楼号 -->
              <div class="form-group">
                <label for="cashSearchBuilding">楼号</label>
                <select class="form-control" id="cashSearchBuilding">
                  <option value="">全部</option>
                </select>
              </div>
              <!-- 单元 -->
              <div class="form-group">
                <label for="cashSearchUnit">单元</label>
                <select class="form-control" id="cashSearchUnit">
                  <option value="">全部</option>
                </select>
              </div>
              <!-- 房号 -->
              <div class="form-group">
                <label for="cashSearchRoom">房号</label>
                <select class="form-control" id="cashSearchRoom">
                  <option value="">全部</option>
                </select>
              </div>
              <!-- 业主姓名 -->
              <div class="form-group">
                <label for="cashSearchHouseholder">业主姓名</label>
                <input
                  type="text"
                  class="form-control"
                  id="cashSearchHouseholder"
                  placeholder="请输入业主姓名"
                />
              </div>
              <!-- 电话 -->
              <div class="form-group">
                <label for="cashSearchPhone">电话</label>
                <input
                  type="text"
                  class="form-control"
                  id="cashSearchPhone"
                  placeholder="请输入电话"
                />
              </div>
              <!-- 供暖季时间 -->
              <div class="form-group">
                <label for="cashSearchHeatingSeason">供暖季时间</label>
                <select class="form-control" id="cashSearchHeatingSeason">
                  <option value="">全部</option>
                  <option value="2024-2025">2024-2025</option>
                  <option value="2025-2026">2025-2026</option>
                </select>
              </div>
              <!-- 缴费状态 -->
              <div class="form-group">
                <label for="cashSearchPaymentStatus">缴费状态</label>
                <select class="form-control" id="cashSearchPaymentStatus">
                  <option value="">全部</option>
                  <option value="已缴费">已缴费</option>
                  <option value="欠费">欠费</option>
                </select>
              </div>
              <!-- 费用类型 -->
              <div class="form-group">
                <label for="cashSearchFeeType">费用类型</label>
                <select class="form-control" id="cashSearchFeeType">
                  <option value="">全部</option>
                  <option value="全费">全费</option>
                  <option value="空置费">空置费</option>
                </select>
              </div>
              <!-- 支付方式 -->
              <div class="form-group">
                <label for="cashSearchPaymentMethod">支付方式</label>
                <select class="form-control" id="cashSearchPaymentMethod">
                  <option value="">全部</option>
                  <option value="现金">现金</option>
                  <option value="微信支付">微信支付</option>
                  <option value="支付宝">支付宝</option>
                  <option value="银行卡">银行卡</option>
                  <option value="其他">其他</option>
                </select>
              </div>
              <!-- 搜索按钮 -->
              <div class="form-group">
                <label>&nbsp;</label>
                <button id="cashSearchBtn" class="btn btn-accent">
                  <i class="fas fa-search"></i> 查询
                </button>
              </div>
            </div>
          </div>

          <!-- 收费记录列表 -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <i class="fas fa-list"></i> 收费记录列表
              </div>
            </div>

            <div class="table-container">
              <table id="paymentsTable">
                <thead>
                  <tr>
                    <th>收费单号</th>
                    <th>小区</th>
                    <th>楼号</th>
                    <th>单元</th>
                    <th>房号</th>
                    <th>业主</th>
                    <th>电话</th>
                    <th>应缴</th>
                    <th>实收</th>
                    <th>应找</th>
                    <th>实找</th>
                    <th>日期</th>
                    <th>支付方式</th>
                    <th>状态</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="paymentsTableBody">
                  <!-- 数据将通过JavaScript动态加载 -->
                </tbody>
              </table>
            </div>

            <div id="noDataMessage" class="no-data">
              <i class="fas fa-file-invoice-dollar"></i>
              <h3>暂无收费记录</h3>
              <p>请添加第一条供暖费收费记录</p>
            </div>

            <!-- 分页控件 -->
            <div id="paymentPagination" class="pagination">
              <div class="page-info">
                <span>每页显示：</span>
                <select id="paymentPageSize" class="page-size-select">
                  <option value="10" selected>10</option>
                  <option value="30">30</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
                <span>条</span>
              </div>
              <div class="page-controls">
                <button
                  id="paymentFirstPage"
                  class="btn btn-sm btn-primary"
                  disabled
                >
                  <i class="fas fa-angle-double-left"></i> 首页
                </button>
                <button
                  id="paymentPrevPage"
                  class="btn btn-sm btn-primary"
                  disabled
                >
                  <i class="fas fa-angle-left"></i> 上一页
                </button>
                <span class="page-info"
                  >第 <span id="paymentCurrentPage">1</span> /
                  <span id="paymentTotalPages">1</span> 页</span
                >
                <button id="paymentNextPage" class="btn btn-sm btn-primary">
                  下一页 <i class="fas fa-angle-right"></i>
                </button>
                <button id="paymentLastPage" class="btn btn-sm btn-primary">
                  末页 <i class="fas fa-angle-double-right"></i>
                </button>
              </div>
              <div class="page-info">
                <span>共 <span id="paymentTotalRecords">0</span> 条记录</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 统计分析标签页 -->
        <div id="analysis-tab" class="tab-content">
          <!-- 系统概览 -->
          <section id="dashboard">
            <!-- 统计卡片 -->
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <i class="fas fa-chart-bar"></i> 工单统计
                </div>
              </div>
              <!-- 统计数据 -->
              <div class="stats-container">
                <div class="stat-card stat-1">
                  <div class="stat-icon">
                    <i class="fas fa-ticket-alt"></i>
                  </div>
                  <div class="stat-info">
                    <h3 id="totalWorkOrders">0</h3>
                    <p>总工单数</p>
                  </div>
                </div>
                <div class="stat-card stat-2">
                  <div class="stat-icon">
                    <i class="fas fa-calendar-day"></i>
                  </div>
                  <div class="stat-info">
                    <h3 id="todayWorkOrders">0</h3>
                    <p>今日工单</p>
                  </div>
                </div>
                <div class="stat-card stat-3">
                  <div class="stat-icon">
                    <i class="fas fa-hourglass-start"></i>
                  </div>
                  <div class="stat-info">
                    <h3 id="pendingWorkOrders">0</h3>
                    <p>未开始</p>
                  </div>
                </div>
                <div class="stat-card stat-4">
                  <div class="stat-icon">
                    <i class="fas fa-spinner"></i>
                  </div>
                  <div class="stat-info">
                    <h3 id="progressWorkOrders">0</h3>
                    <p>进行中</p>
                  </div>
                </div>
                <div class="stat-card stat-5">
                  <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                  </div>
                  <div class="stat-info">
                    <h3 id="completedWorkOrders">0</h3>
                    <p>已办结</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- 工单区域 -->
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <i class="fas fa-ticket-alt"></i> 工单统计图表
                </div>
              </div>
              <div class="main-content">
                <div class="card">
                  <h2 class="card-title">
                    <i class="fas fa-chart-line"></i> 工单趋势
                  </h2>
                  <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                  </div>
                </div>

                <div class="card">
                  <h2 class="card-title">
                    <i class="fas fa-chart-pie"></i> 工单状态分布
                  </h2>
                  <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                  </div>
                </div>

                <div class="card">
                  <h2 class="card-title">
                    <i class="fas fa-building"></i> 小区工单分布
                  </h2>
                  <div class="chart-container">
                    <canvas id="communityChart"></canvas>
                  </div>
                </div>

                <div class="card">
                  <h2 class="card-title">
                    <i class="fas fa-home"></i> 楼栋工单分布
                  </h2>
                  <div class="chart-container">
                    <canvas id="buildingChart"></canvas>
                  </div>
                </div>

                <div class="card">
                  <h2 class="card-title">
                    <i class="fas fa-clock"></i> 处理时效分析
                  </h2>
                  <div class="chart-container">
                    <canvas id="timeChart"></canvas>
                  </div>
                </div>

                <div class="card">
                  <h2 class="card-title">
                    <i class="fas fa-tags"></i> 工单类型分布
                  </h2>
                  <div class="chart-container">
                    <canvas id="ticketTypeChart"></canvas>
                  </div>
                </div>

                <div class="card">
                  <h2 class="card-title">
                    <i class="fas fa-users"></i> 用户工单排行（前30）
                  </h2>
                  <div class="chart-container">
                    <canvas id="userWorkOrderChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- 收费记录区域 -->
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <i class="fas fa-credit-card"></i> 收费统计图表
                </div>
              </div>
              <div class="main-content">
                <div class="card">
                  <h2 class="card-title">
                    <i class="fas fa-chart-pie"></i> 缴费状态分布
                  </h2>
                  <div class="chart-container">
                    <canvas id="paymentStatusChart"></canvas>
                  </div>
                </div>

                <div class="card">
                  <h2 class="card-title">
                    <i class="fas fa-chart-bar"></i> 每日缴费统计
                  </h2>
                  <div class="chart-container">
                    <canvas id="dailyPaymentChart"></canvas>
                  </div>
                </div>

                <div class="card">
                  <h2 class="card-title">
                    <i class="fas fa-chart-pie"></i> 缴费方式分布
                  </h2>
                  <div class="chart-container">
                    <canvas id="paymentMethodChart"></canvas>
                  </div>
                </div>

                <div class="card">
                  <h2 class="card-title">
                    <i class="fas fa-building"></i> 小区缴费统计
                  </h2>
                  <div class="chart-container">
                    <canvas id="communityPaymentChart"></canvas>
                  </div>
                </div>

                <div class="card">
                  <h2 class="card-title">
                    <i class="fas fa-chart-bar"></i> 缴费金额区间分布
                  </h2>
                  <div class="chart-container">
                    <canvas id="amountRangeChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- 系统设置标签页 -->
        <div id="settings-tab" class="tab-content">
          <!-- 小区设置部分 -->
          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="fas fa-home"></i> 小区设置</div>
            </div>
            <div class="card-body">
              <div class="setting-section">
                <div class="setting-buttons">
                  <div class="setting-buttons-row">
                    <div class="setting-buttons-group">
                      <div class="setting-buttons-item">
                        <span class="community-config">默认小区：</span>
                      </div>
                      <!-- 默认小区设置按钮 -->
                      <button class="btn btn-accent" id="defaultCommunityBtn">
                        <i class="fas fa-home"></i> 默认小区设置
                      </button>
                    </div>
                    <!-- 小区选择部分 -->
                    <label for="communitySelect" class="community-config"
                      >小区配置：</label
                    >
                    <select
                      id="communitySelect"
                      class="form-control community-select"
                      disabled
                    >
                      <option value="">请选择小区</option>
                    </select>
                    <div class="setting-buttons-group">
                      <div class="setting-buttons-item">
                        <span class="community-config">小区零钱：</span>
                        <span id="communityChange" class="uppercase-amount"
                          >¥0.00</span
                        >
                      </div>
                      <button
                        id="initChangeModalBtn"
                        class="btn btn-primary btn-sm"
                      >
                        <i class="fas fa-coins"></i> 初始化零钱
                      </button>
                      <div class="setting-buttons-item">
                        <span class="community-config">小区单价：</span>
                        <span id="communityUnitPrice" class="uppercase-amount"
                          >¥5.80</span
                        >
                      </div>
                      <button
                        id="initUnitPriceModalBtn"
                        class="btn btn-success btn-sm"
                      >
                        <i class="fas fa-dollar-sign"></i> 初始化单价
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 客服工单设置部分 -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <i class="fas fa-tasks"></i> 客服工单设置
              </div>
            </div>
            <div class="card-body">
              <div class="setting-section">
                <div class="setting-buttons">
                  <div class="setting-buttons-row">
                    <div class="setting-buttons-group">
                      <div class="setting-buttons-item">
                        <span class="community-config">用户信息：</span>
                      </div>
                      <button class="btn btn-success" id="importUserBtn">
                        <i class="fas fa-file-import"></i> 用户信息导入
                      </button>
                      <button class="btn btn-danger" id="exportUserBtn">
                        <i class="fas fa-file-export"></i> 用户信息导出
                      </button>
                      <div class="setting-buttons-item">
                        <span class="community-config">工单：</span>
                      </div>
                      <button class="btn btn-success" id="importTicketBtn">
                        <i class="fas fa-upload"></i> 工单导入
                      </button>
                      <div class="setting-buttons-item">
                        <span class="community-config">数据备份：</span>
                      </div>
                      <button class="btn btn-success" id="globalImportBtn">
                        <i class="fas fa-database"></i> 数据恢复
                      </button>
                      <button class="btn btn-danger" id="globalExportBtn">
                        <i class="fas fa-database"></i> 数据备份
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 线下缴费设置部分 -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <i class="fas fa-money-bill-wave"></i> 线下缴费设置
              </div>
            </div>
            <div class="card-body">
              <div class="setting-section">
                <div class="setting-buttons">
                  <button class="btn btn-success" id="importPaymentBtn">
                    <i class="fas fa-file-import"></i> 收费记录导入
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 页脚信息 -->
      <footer>
        <p>
          IDH智慧供热客服系统 © 2025 | 客服热线：400-123-4567 |
          技术支持：tech@hzzxxny.com
        </p>
      </footer>
    </div>

    <!-- 新建工单模态框 -->
    <div class="modal" id="createTicketModal">
      <div class="modal-content">
        <div class="modal-header">
          <h4><i class="fas fa-plus-circle"></i> 新建工单</h4>
          <span class="close">&times;</span>
        </div>

        <form id="ticketForm">
          <div class="form-row">
            <div class="form-group">
              <label for="ticketNumber">工单号</label>
              <input
                type="text"
                class="form-control"
                id="ticketNumber"
                value="GD20241101001"
                readonly
              />
            </div>

            <div class="form-group">
              <label for="createTime">创建时间</label>
              <input
                type="text"
                class="form-control"
                id="createTime"
                readonly
              />
            </div>
          </div>

          <!-- 用户信息区域 -->
          <div class="form-row">
            <div class="form-group">
              <label for="ticketNumber">用户信息</label>
            </div>
          </div>
          <div class="detail-section">
            <div class="form-row form-row-4col">
              <div class="form-group">
                <label for="community">小区名称</label>
                <select class="form-control" id="community" required>
                  <option value="">请选择小区</option>
                </select>
              </div>

              <div class="form-group">
                <label for="building">楼号</label>
                <select class="form-control" id="building" required>
                  <option value="">请选择楼号</option>
                </select>
              </div>

              <div class="form-group">
                <label for="unit">单元</label>
                <select class="form-control" id="unit" required>
                  <option value="">请选择单元</option>
                </select>
              </div>

              <div class="form-group">
                <label for="room">房号</label>
                <select class="form-control" id="room" required>
                  <option value="">请选择房号</option>
                </select>
              </div>
            </div>

            <div class="form-row form-row-4col">
              <div class="form-group">
                <label for="area">面积(㎡)</label>
                <input
                  type="number"
                  class="form-control"
                  id="area"
                  step="0.01"
                  required
                  readonly
                />
              </div>

              <div class="form-group">
                <label for="owner">业主姓名</label>
                <input type="text" class="form-control" id="owner" required />
              </div>

              <div class="form-group">
                <label for="phone">电话</label>
                <input type="tel" class="form-control" id="phone" required />
              </div>
            </div>
          </div>

          <!-- 账单信息区域 -->
          <div class="form-group form-full form-full-mt-20">
            <label>账单信息</label>
            <div class="bills-container">
              <div class="bill-header">
                <div>供暖季</div>
                <div>缴费状态</div>
                <div>费用类型</div>
                <div>应缴(元)</div>
                <div>实缴(元)</div>
                <div>欠费(元)</div>
              </div>
              <div class="bill-row"></div>
            </div>
          </div>

          <!-- 工单信息区域 -->
          <div class="form-row">
            <div class="form-group">
              <label for="ticketNumber">工单信息</label>
            </div>
          </div>
          <div class="detail-section">
            <!-- 第一行：创建人、办理人、缴费状态 -->
            <div class="form-row form-row-3col">
              <div class="form-group">
                <label for="creator">创建人</label>
                <input type="text" class="form-control" id="creator" required />
              </div>

              <div class="form-group">
                <label for="processor">办理人</label>
                <input
                  type="text"
                  class="form-control"
                  id="processor"
                  required
                />
              </div>

              <div class="form-group">
                <label for="paymentStatus">缴费状态</label>
                <select
                  class="form-control"
                  id="paymentStatus"
                  required
                  disabled
                >
                  <option value="已缴费">已缴费</option>
                  <option value="欠费">欠费</option>
                </select>
              </div>
            </div>

            <!-- 第二行：问题描述 -->
            <div class="form-group form-full form-full-mt-20">
              <label for="description">问题描述</label>
              <textarea
                class="form-control"
                id="description"
                rows="6"
                required
              ></textarea>
            </div>

            <!-- 第三行：工单类型、工单状态 -->
            <div class="form-row form-row-mt-20">
              <div class="form-group">
                <label for="ticketType">工单类型</label>
                <select class="form-control" id="ticketType" required>
                  <option value="咨询">咨询</option>
                  <option value="缴费">缴费</option>
                  <option value="报修">报修</option>
                  <option value="投诉（客观）">投诉（客观）</option>
                  <option value="投诉（主观）">投诉（主观）</option>
                </select>
              </div>
              <div class="form-group">
                <label for="ticketStatus">工单状态</label>
                <select class="form-control" id="ticketStatus" required>
                  <option value="未开始">未开始</option>
                  <option value="进行中">进行中</option>
                  <option value="已办结">已办结</option>
                  <option value="已撤销">已撤销</option>
                  <option value="已删除">已删除</option>
                  <option value="已关闭">已关闭</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-row form-row-center">
            <button type="submit" class="btn btn-primary">保存</button>
            <button type="button" class="btn btn-danger" id="cancelTicketBtn">
              取消
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 新建收费模态框 -->
    <div class="modal" id="createPaymentModal">
      <div class="modal-content">
        <div class="modal-header">
          <h4><i class="fas fa-plus-circle"></i> 新建收费</h4>
          <span class="close">&times;</span>
        </div>

        <form id="paymentCreateForm">
          <div class="form-row form-row-3col">
            <div class="form-group">
              <label for="paymentNumber">收费单号</label>
              <input
                type="text"
                class="form-control"
                id="paymentNumber"
                readonly
              />
            </div>

            <div class="form-group">
              <label for="receiptNumber">收据编号</label>
              <input
                type="text"
                class="form-control"
                id="receiptNumber"
                placeholder="请输入收据编号"
                required
              />
            </div>

            <div class="form-group">
              <label for="paymentCreateTime">创建时间</label>
              <input
                type="text"
                class="form-control"
                id="paymentCreateTime"
                readonly
              />
            </div>
          </div>

          <!-- 用户信息区域 -->
          <div class="form-row">
            <div class="form-group">
              <label for="paymentNumber">用户信息</label>
            </div>
          </div>
          <div class="detail-section">
            <div class="form-row form-row-4col">
              <div class="form-group">
                <label for="paymentCommunity">小区名称</label>
                <select class="form-control" id="paymentCommunity" required>
                  <option value="">请选择小区</option>
                </select>
              </div>

              <div class="form-group">
                <label for="paymentBuilding">楼号</label>
                <select class="form-control" id="paymentBuilding" required>
                  <option value="">请选择楼号</option>
                </select>
              </div>

              <div class="form-group">
                <label for="paymentUnit">单元</label>
                <select class="form-control" id="paymentUnit" required>
                  <option value="">请选择单元</option>
                </select>
              </div>

              <div class="form-group">
                <label for="paymentRoom">房号</label>
                <select class="form-control" id="paymentRoom" required>
                  <option value="">请选择房号</option>
                </select>
              </div>
            </div>

            <div class="form-row form-row-4col">
              <div class="form-group">
                <label for="paymentArea">供暖面积(㎡)</label>
                <input
                  type="number"
                  class="form-control"
                  id="paymentArea"
                  step="0.01"
                  required
                  readonly
                />
              </div>

              <div class="form-group">
                <label for="paymentOwner">业主姓名</label>
                <input
                  type="text"
                  class="form-control"
                  id="paymentOwner"
                  required
                />
              </div>

              <div class="form-group">
                <label for="paymentPhone">电话</label>
                <input
                  type="tel"
                  class="form-control"
                  id="paymentPhone"
                  required
                />
              </div>
            </div>
          </div>

          <!-- 账单信息区域 -->
          <div class="form-group form-full form-full-mt-20">
            <label>账单信息</label>
            <div class="bills-container">
              <div class="bill-header bill-header-nowrap">
                <div>选择</div>
                <div>供暖季</div>
                <div>缴费状态</div>
                <div>费用类型</div>
                <div>应缴(元)</div>
                <div>实缴(元)</div>
                <div>欠费(元)</div>
              </div>
              <div id="paymentBillRow" class="bill-row bill-row-nowrap"></div>
            </div>
          </div>

          <!-- 收费信息区域 -->
          <div class="form-row">
            <div class="form-group">
              <label for="paymentNumber">收费信息</label>
            </div>
          </div>
          <div class="detail-section">
            <!-- 第一行：应缴金额、实收金额、实缴金额 -->
            <div class="form-row form-row-3col">
              <div class="form-group">
                <label for="paymentShouldPay">应缴金额(元)</label>
                <input
                  type="number"
                  class="form-control"
                  id="paymentShouldPay"
                  step="0.01"
                  readonly
                />
                <div class="uppercase-container">
                  <label class="uppercase-label">大写金额：</label>
                  <span id="paymentShouldPayUppercase" class="uppercase-amount"
                    >零元整</span
                  >
                </div>
              </div>

              <div class="form-group">
                <label for="paymentActualPay">实收金额(元)</label>
                <input
                  type="number"
                  class="form-control"
                  id="paymentActualPay"
                  step="0.01"
                  required
                />
              </div>

              <div class="form-group">
                <label for="paymentPaid">实缴金额(元)</label>
                <input
                  type="number"
                  class="form-control"
                  id="paymentPaid"
                  step="0.01"
                  readonly
                />
              </div>
            </div>

            <!-- 第二行：应找、实找、找零损耗 -->
            <div class="form-row form-row-3col">
              <div class="form-group">
                <label for="paymentChange">应找(元)</label>
                <input
                  type="number"
                  class="form-control"
                  id="paymentChange"
                  step="0.01"
                  readonly
                />
              </div>

              <div class="form-group">
                <label for="paymentActualChange">实找(元)</label>
                <input
                  type="number"
                  class="form-control"
                  id="paymentActualChange"
                  step="0.01"
                  readonly
                />
              </div>

              <div class="form-group">
                <label for="paymentChangeLoss">找零损耗(元)</label>
                <input
                  type="number"
                  class="form-control"
                  id="paymentChangeLoss"
                  step="0.01"
                  readonly
                />
              </div>
            </div>

            <!-- 第三行：单价、收费日期、供暖季 -->
            <div class="form-row form-row-3col">
              <div class="form-group">
                <label for="paymentUnitPrice">单价(元/㎡)</label>
                <input
                  type="number"
                  class="form-control"
                  id="paymentUnitPrice"
                  step="0.01"
                  value="5.80"
                  required
                  readonly
                />
              </div>

              <div class="form-group">
                <label for="paymentDate">收费日期</label>
                <input
                  type="date"
                  class="form-control"
                  id="paymentDate"
                  required
                />
              </div>

              <div class="form-group">
                <label for="paymentHeatingSeason">供暖季</label>
                <input
                  type="text"
                  class="form-control"
                  id="paymentHeatingSeason"
                  readonly
                />
              </div>
            </div>

            <!-- 第四行：支付方式、创建人、办理人 -->
            <div class="form-row form-row-3col">
              <div class="form-group">
                <label for="paymentMethod">支付方式</label>
                <select class="form-control" id="paymentMethod" required>
                  <option value="现金">现金</option>
                  <option value="微信支付">微信支付</option>
                  <option value="支付宝">支付宝</option>
                  <option value="银行卡">银行卡</option>
                  <option value="其他">其他</option>
                </select>
              </div>

              <div class="form-group">
                <label for="paymentCreator">创建人</label>
                <input
                  type="text"
                  class="form-control"
                  id="paymentCreator"
                  required
                />
              </div>

              <div class="form-group">
                <label for="paymentProcessor">办理人</label>
                <input
                  type="text"
                  class="form-control"
                  id="paymentProcessor"
                  required
                />
              </div>
            </div>

            <!-- 二维码显示区域 -->
            <div
              class="form-row form-full"
              id="paymentQrCodeSection"
              style="display: none; margin-top: 20px"
            >
              <div class="form-group">
                <label id="paymentQrCodeLabel">微信支付二维码</label>
                <div
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                    background-color: #f8f9fa;
                    border-radius: 8px;
                  "
                >
                  <div
                    id="paymentQrCode"
                    style="width: 200px; height: 200px"
                  ></div>
                </div>
                <div
                  style="
                    margin-top: 10px;
                    font-weight: bold;
                    color: #666;
                    text-align: center;
                  "
                >
                  <span id="paymentQrCodeHint"
                    >请使用微信/支付宝扫描二维码支付</span
                  >
                </div>
                <div
                  style="
                    margin-top: 5px;
                    font-size: 1.2em;
                    font-weight: bold;
                    color: #e74c3c;
                    text-align: center;
                  "
                >
                  <span id="paymentQrCodeAmount">¥ 0.00</span>
                </div>
              </div>
            </div>

            <!-- 第五行：备注 -->
            <div class="form-group form-full">
              <label for="paymentRemarks">备注</label>
              <textarea
                class="form-control"
                id="paymentRemarks"
                rows="3"
                placeholder="请输入备注信息"
              ></textarea>
            </div>
          </div>

          <div class="form-row form-row-center">
            <button type="submit" class="btn btn-primary">保存</button>
            <button type="button" class="btn btn-danger" id="cancelPaymentBtn">
              取消
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 收据打印模态框 -->
    <div id="receiptModal" class="modal">
      <div class="modal-content">
        <div class="card">
          <h2 class="card-title"><i class="fas fa-receipt"></i> 收据预览</h2>
          <div class="receipt-preview" id="receiptContent">
            <!-- 收据内容将通过JavaScript动态生成 -->
          </div>
        </div>
        <div class="print-actions no-print">
          <button id="printReceipt" class="btn btn-primary">
            <i class="fas fa-print"></i> 打印
          </button>
          <button id="closeReceipt" class="btn btn-danger">
            <i class="fas fa-times"></i> 关闭
          </button>
        </div>
      </div>
    </div>

    <!-- 默认小区设置模态框 -->
    <div class="modal" id="defaultCommunityModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-home"></i> 默认小区设置</h2>
          <span class="close">&times;</span>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label for="defaultCommunitySelect">选择默认小区：</label>
            <select id="defaultCommunitySelect" class="form-control">
              <option value="">请选择小区</option>
              <!-- 小区选项将通过JavaScript动态填充 -->
            </select>
          </div>
          <div class="form-actions-right">
            <button id="cancelDefaultCommunityBtn" class="btn btn-secondary">
              取消
            </button>
            <button id="saveDefaultCommunityBtn" class="btn btn-primary">
              保存
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 初始化零钱模态框 -->
    <div id="changeModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="form-title">初始化小区零钱</h2>
          <span class="close close-btn-large">&times;</span>
        </div>
        <div class="modal-body">
          <div class="form-group form-group-mb-15">
            <label for="changeAmount" class="form-label-bold"
              >初始零钱金额：</label
            >
            <input
              type="number"
              id="changeAmountInput"
              class="form-control"
              step="0.01"
              min="0"
              value="0.00"
            />
          </div>
          <div class="form-actions-right">
            <button id="cancelChangeBtn" class="btn btn-secondary">取消</button>
            <button id="saveChangeBtn" class="btn btn-primary">保存</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 初始化小区单价模态框 -->
    <div id="unitPriceModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="form-title">初始化小区单价</h2>
          <span class="close close-btn-large">&times;</span>
        </div>
        <div class="modal-body">
          <div class="form-group form-group-mb-15">
            <label for="unitPriceAmount" class="form-label-bold"
              >小区单价(元/㎡)：</label
            >
            <input
              type="number"
              id="unitPriceAmountInput"
              class="form-control"
              step="0.01"
              min="0"
              value="5.80"
            />
          </div>
          <div class="form-actions-right">
            <button id="cancelUnitPriceBtn" class="btn btn-secondary">
              取消
            </button>
            <button id="saveUnitPriceBtn" class="btn btn-primary">保存</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 数据存储键名
      const STORAGE_KEYS = {
        USERS: 'idh_heating_users',
        TICKETS: 'idh_heating_tickets',
      };

      // 更新工单统计信息
      function updateTicketStats() {
        const tickets = getTickets();

        // 统计各种状态的工单数量
        const total = tickets.length;
        const pending = tickets.filter((t) => t.status === '未开始').length;
        const inProgress = tickets.filter((t) => t.status === '进行中').length;
        const completed = tickets.filter((t) => t.status === '已办结').length;

        // 更新统计卡片
        document.querySelectorAll('.stat-card .stat-value')[0].textContent =
          total;
        document.querySelectorAll('.stat-card .stat-value')[1].textContent =
          pending;
        document.querySelectorAll('.stat-card .stat-value')[2].textContent =
          inProgress;
        document.querySelectorAll('.stat-card .stat-value')[3].textContent =
          completed;
      }

      // 初始化页面
      document.addEventListener('DOMContentLoaded', function () {
        // 设置当前时间
        const now = new Date();
        document.getElementById('createTime').value = now.toLocaleString();

        // 获取当前登录用户信息
        const currentUser = sessionStorage.getItem('currentUser');
        const username = currentUser
          ? JSON.parse(currentUser).username
          : '系统管理员';

        // 设置创建人和办理人为当前登录用户
        if (document.getElementById('creator')) {
          document.getElementById('creator').value = username;
        }
        if (document.getElementById('processor')) {
          document.getElementById('processor').value = username;
        }

        // 生成唯一工单号
        generateTicketNumber();

        // 加载工单数据
        loadTickets();

        // 更新工单统计
        updateTicketStats();

        // 绑定事件监听器
        bindEventListeners();

        // 初始化查询下拉框选项
        updateSearchOptions();

        // 应用默认小区设置
        applyDefaultCommunity();

        // 绑定标签页切换事件
        bindTabEventListeners();

        // 初始化统计分析模块
        initAnalysisModule();

        // 初始化银行存现功能
        initBankDepositModule();
      });

      // 绑定标签页切换事件
      function bindTabEventListeners() {
        // 获取所有标签页链接
        const tabLinks = document.querySelectorAll('.navbar a[data-tab]');

        tabLinks.forEach((link) => {
          link.addEventListener('click', function (e) {
            e.preventDefault();

            // 获取目标标签页
            const targetTab = this.getAttribute('data-tab');

            // 移除所有活跃状态
            document.querySelectorAll('.navbar a').forEach((item) => {
              item.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach((tab) => {
              tab.classList.remove('active');
            });

            // 设置当前活跃状态
            this.classList.add('active');
            const activeTab = document.getElementById(`${targetTab}-tab`);
            activeTab.classList.add('active');

            // 更新账单容器表头样式
            updateBillContainerHeaders();
          });
        });
      }

      // 更新所有账单容器的表头样式
      function updateBillContainerHeaders() {
        // 获取所有账单容器
        const allBillContainers = document.querySelectorAll('.bills-container');

        allBillContainers.forEach((container) => {
          // 检查当前容器所属的标签页
          const tabContent = container.closest('.tab-content');
          const billHeader = container.querySelector('.bill-header');

          if (!tabContent || !billHeader) return;

          if (tabContent.id === 'cash-tab') {
            // 线下缴费标签页 - 7列，带复选框
            if (billHeader.children.length !== 7) {
              billHeader.innerHTML = `
                            <div class="checkbox-column"></div>
                            <div>供暖季</div>
                            <div>缴费状态</div>
                            <div>费用类型</div>
                            <div>应缴(元)</div>
                            <div>实缴(元)</div>
                            <div>欠费(元)</div>
                        `;
            }
          } else {
            // 其他标签页 - 6列，不带复选框
            if (billHeader.children.length !== 6) {
              billHeader.innerHTML = `
                            <div>供暖季</div>
                            <div>缴费状态</div>
                            <div>费用类型</div>
                            <div>应缴(元)</div>
                            <div>实缴(元)</div>
                            <div>欠费(元)</div>
                        `;
            }
          }
        });
      }

      // 生成唯一工单号
      function generateTicketNumber() {
        const now = new Date();
        const dateStr =
          now.getFullYear().toString() +
          (now.getMonth() + 1).toString().padStart(2, '0') +
          now.getDate().toString().padStart(2, '0');

        // 获取现有工单数量
        const tickets = getTickets();
        const ticketCount = tickets.length + 1;
        const serial = ticketCount.toString().padStart(3, '0');

        document.getElementById('ticketNumber').value = `GD${dateStr}${serial}`;
      }

      // 从LocalStorage获取数据
      function getFromStorage(key) {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : [];
      }

      // 保存数据到LocalStorage
      function saveToStorage(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
      }

      // 导出小区用户信息
      function exportUsers() {
        try {
          // 获取当前查询表单中的小区名称
          const communitySelect = document.getElementById('searchCommunity');
          const selectedCommunity = communitySelect
            ? communitySelect.value
            : '';

          // 从localStorage获取用户信息
          const allUsers = getUsers();

          // 根据选中的小区筛选用户信息
          const filteredUsers = selectedCommunity
            ? allUsers.filter((user) => user.community === selectedCommunity)
            : allUsers;

          if (filteredUsers.length === 0) {
            alert('没有符合条件的小区用户信息可以导出！');
            return;
          }

          // 构建文件名前缀
          const communityPrefix = selectedCommunity
            ? `${selectedCommunity}_`
            : '';

          // 将用户信息转换为JSON字符串，带缩进格式
          const jsonData = JSON.stringify(filteredUsers, null, 2);

          // 创建Blob对象
          const blob = new Blob([jsonData], { type: 'application/json' });

          // 创建下载链接
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          // 使用东八区时间生成文件名
          const localDate = new Date();
          const year = localDate.getFullYear();
          const month = String(localDate.getMonth() + 1).padStart(2, '0');
          const day = String(localDate.getDate()).padStart(2, '0');
          const localDateStr = `${year}-${month}-${day}`;
          a.download = `${communityPrefix}小区用户信息_${localDateStr}.json`;

          // 触发下载
          document.body.appendChild(a);
          a.click();

          // 清理
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          alert(
            '小区用户信息导出成功！共导出 ' +
              filteredUsers.length +
              ' 条记录。',
          );
        } catch (error) {
          alert('导出失败：' + error.message);
        }
      }

      // 获取小区用户信息
      function getUsers() {
        return getFromStorage(STORAGE_KEYS.USERS);
      }

      // 保存小区用户信息
      function saveUsers(users) {
        saveToStorage(STORAGE_KEYS.USERS, users);
      }

      // 全局导出所有数据
      function globalExport() {
        try {
          // 获取localStorage中的所有数据
          const allData = {};
          let parseError = null;
          let parseErrorKey = '';

          // 遍历localStorage，逐个解析数据，避免单个错误导致整个导出失败
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            // 只导出以idh_开头的key，排除rememberedUser数据
            if (
              key === 'rememberedUser' ||
              key === 'idh_remembered_user' ||
              !key.startsWith('idh_')
            ) {
              continue;
            }
            try {
              const value = localStorage.getItem(key);
              // 只有当值不是空字符串且是对象/数组格式时才尝试解析
              if (value && (value.startsWith('{') || value.startsWith('['))) {
                allData[key] = JSON.parse(value);
              } else {
                // 直接使用原始值（适用于字符串类型数据）
                allData[key] = value;
              }
            } catch (e) {
              parseError = e;
              parseErrorKey = key;
              // 记录错误但继续导出其他数据
              console.error(`解析localStorage数据项 ${key} 失败：`, e);
              // 使用原始字符串值代替解析失败的数据
              allData[key] = localStorage.getItem(key);
            }
          }

          if (Object.keys(allData).length === 0) {
            alert('没有数据可以导出！');
            return;
          }

          // 将所有数据转换为JSON字符串
          let jsonData;
          try {
            jsonData = JSON.stringify(allData, null, 2);
          } catch (e) {
            // 尝试使用replacer函数处理无法序列化的值
            jsonData = JSON.stringify(
              allData,
              (key, value) => {
                if (typeof value === 'undefined') {
                  return 'undefined';
                }
                if (typeof value === 'function') {
                  return value.toString();
                }
                if (value instanceof Error) {
                  return value.message;
                }
                return value;
              },
              2,
            );
          }

          // 创建Blob对象
          const blob = new Blob([jsonData], { type: 'application/json' });

          // 创建下载链接
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          // 使用东八区时间生成文件名，解决UTC时间与本地时间不一致的问题
          const localDate = new Date();
          const year = localDate.getFullYear();
          const month = String(localDate.getMonth() + 1).padStart(2, '0');
          const day = String(localDate.getDate()).padStart(2, '0');
          const localDateStr = `${year}-${month}-${day}`;
          a.download = `IDH智慧供热客服系统_数据备份_${localDateStr}.json`;

          // 触发下载
          document.body.appendChild(a);
          a.click();

          // 清理
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 100);

          // 显示导出结果，包含可能的警告
          let message = `数据备份成功！共导出 ${Object.keys(allData).length} 个数据项。`;
          if (parseError) {
            message += `\n\n警告：数据项 "${parseErrorKey}" 解析失败，已使用原始字符串值代替。`;
          }
          alert(message);
        } catch (error) {
          console.error('数据备份失败：', error);
          // 显示更详细的错误信息
          alert(
            `数据备份失败：${error.message}\n\n详细错误信息：${error.stack}`,
          );
        }
      }

      // 全局导入所有数据
      function globalImport() {
        try {
          // 创建文件选择器
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';

          // 监听文件选择事件
          input.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            // 读取文件内容
            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                // 解析JSON数据
                const allData = JSON.parse(e.target.result);

                // 验证数据格式
                if (typeof allData !== 'object' || allData === null) {
                  throw new Error('JSON文件格式不正确，必须是对象类型！');
                }

                // 备份当前localStorage数据
                const backupData = {};
                for (let i = 0; i < localStorage.length; i++) {
                  const key = localStorage.key(i);
                  backupData[key] = localStorage.getItem(key);
                }

                // 导入所有数据到localStorage（只覆盖重名key，保留原有数据）
                let importCount = 0;
                let setErrorCount = 0;

                for (const [key, value] of Object.entries(allData)) {
                  try {
                    // 处理原始字符串值（可能是之前解析失败的数据）
                    let finalValue = value;
                    if (typeof value === 'string') {
                      // 尝试解析字符串值
                      try {
                        finalValue = JSON.parse(value);
                      } catch (parseError) {
                        // 如果解析失败，使用原始字符串
                      }
                    }

                    // 根据值的类型决定如何保存到localStorage
                    if (
                      (typeof finalValue === 'object' && finalValue !== null) ||
                      typeof finalValue === 'number' ||
                      typeof finalValue === 'boolean'
                    ) {
                      // 对于对象、数组、数字和布尔值，使用JSON.stringify
                      localStorage.setItem(key, JSON.stringify(finalValue));
                    } else {
                      // 对于字符串类型，直接保存
                      localStorage.setItem(key, finalValue);
                    }
                    importCount++;
                  } catch (setError) {
                    console.error(
                      `设置localStorage数据项 ${key} 失败：`,
                      setError,
                    );
                    setErrorCount++;
                  }
                }

                // 显示导入结果
                let message = `数据恢复成功！共导入 ${importCount} 个数据项。`;
                if (setErrorCount > 0) {
                  message += `\n\n警告：有 ${setErrorCount} 个数据项导入失败，请查看控制台日志。`;
                }
                message += `\n\n页面将刷新以应用新数据。`;

                alert(message);

                // 刷新页面
                window.location.reload();
              } catch (error) {
                console.error('解析JSON文件失败：', error);

                // 导入失败，恢复备份数据
                localStorage.clear();
                for (const [key, value] of Object.entries(backupData)) {
                  localStorage.setItem(key, value);
                }

                alert(
                  `解析JSON文件失败：${error.message}\n\n详细错误信息：${error.stack}\n\n请确保文件格式正确！\n\n已恢复原始数据。`,
                );
              }
            };

            // 读取文件
            reader.readAsText(file);
          });

          // 触发文件选择
          input.click();
        } catch (error) {
          console.error('数据恢复失败：', error);
          alert(
            `数据恢复失败：${error.message}\n\n详细错误信息：${error.stack}`,
          );
        }
      }

      // 获取工单信息
      function getTickets() {
        return getFromStorage(STORAGE_KEYS.TICKETS);
      }

      // 保存工单信息
      function saveTickets(tickets) {
        saveToStorage(STORAGE_KEYS.TICKETS, tickets);
      }

      // 分页状态变量
      let currentTicketPage = 1;
      let ticketPageSize = 10;
      let totalTicketPages = 1;
      let totalTicketRecords = 0;
      // 当前查询条件
      let currentTicketFilter = {};

      // 加载工单列表
      function loadTickets(
        filter = {},
        page = currentTicketPage,
        pageSize = ticketPageSize,
      ) {
        // 如果没有提供筛选条件，使用当前保存的筛选条件
        if (
          Object.keys(filter).length === 0 &&
          Object.keys(currentTicketFilter).length > 0
        ) {
          filter = currentTicketFilter;
        }
        let tickets = getTickets();

        // 保存当前分页状态
        currentTicketPage = page;
        ticketPageSize = pageSize;

        // 应用筛选条件
        if (Object.keys(filter).length > 0) {
          // 首先处理业主姓名和电话查询条件，关联到小区用户信息中查询
          let userFilteredTickets = tickets;

          // 获取所有小区用户信息
          const allUsers = getUsers();

          // 如果有业主姓名或电话查询条件，先从小区用户信息中获取匹配的用户
          if (filter.owner || filter.phone) {
            // 筛选出匹配的用户
            const matchedUsers = allUsers.filter((user) => {
              let userMatch = true;

              if (
                filter.owner &&
                !String(user.owner || '').includes(filter.owner)
              ) {
                userMatch = false;
              }
              if (
                filter.phone &&
                !String(user.phone || '').includes(filter.phone)
              ) {
                userMatch = false;
              }

              return userMatch;
            });

            // 如果找到匹配的用户，根据用户的地址信息过滤工单
            if (matchedUsers.length > 0) {
              userFilteredTickets = tickets.filter((ticket) => {
                // 检查工单的地址信息是否与任何匹配的用户地址匹配
                return matchedUsers.some(
                  (user) =>
                    ticket.community === user.community &&
                    ticket.building === user.building &&
                    ticket.unit === user.unit &&
                    ticket.room === user.room,
                );
              });
            } else {
              // 如果没有匹配的用户，返回空结果
              userFilteredTickets = [];
            }
          }

          // 对用户过滤后的工单应用其他筛选条件
          tickets = userFilteredTickets.filter((ticket) => {
            let match = true;

            // 将工单字段转换为字符串，避免undefined或null比较问题
            const ticketCommunity = String(ticket.community || '');
            const ticketBuilding = String(ticket.building || '');
            const ticketUnit = String(ticket.unit || '');
            const ticketRoom = String(ticket.room || '');
            const ticketPaymentStatus = String(ticket.paymentStatus || '');
            const ticketType = String(ticket.ticketType || '');
            const ticketStatus = String(ticket.status || '');

            if (filter.community && ticketCommunity !== filter.community) {
              match = false;
            }
            if (filter.building && ticketBuilding !== filter.building) {
              match = false;
            }
            if (filter.unit && ticketUnit !== filter.unit) {
              match = false;
            }
            if (filter.room && ticketRoom !== filter.room) {
              match = false;
            }
            if (
              filter.paymentStatus &&
              ticketPaymentStatus !== filter.paymentStatus
            ) {
              match = false;
            }
            if (filter.ticketType && ticketType !== filter.ticketType) {
              match = false;
            }
            if (filter.status && ticketStatus !== filter.status) {
              match = false;
            }

            return match;
          });
        } else {
          // 默认过滤：没有明确指定状态时，过滤掉已删除、已撤销、已关闭的工单
          tickets = tickets.filter((ticket) => {
            const status = ticket.status || '';
            return !['已删除', '已撤销', '已关闭'].includes(status);
          });
        }

        // 无论是否有筛选条件，如果没有明确指定状态，都需要过滤掉已删除、已撤销、已关闭的工单
        // 除非明确指定了状态筛选条件
        if (!filter.status) {
          tickets = tickets.filter((ticket) => {
            const status = ticket.status || '';
            return !['已删除', '已撤销', '已关闭'].includes(status);
          });
        }

        // 按创建时间倒序排序
        tickets.sort((a, b) => {
          const dateA = a.createTime ? new Date(a.createTime) : new Date(0);
          const dateB = b.createTime ? new Date(b.createTime) : new Date(0);
          return dateB - dateA;
        });

        // 保存过滤后的总记录数
        totalTicketRecords = tickets.length;

        // 应用分页
        const startIndex = (page - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const paginatedTickets = tickets.slice(startIndex, endIndex);

        // 计算总页数
        totalTicketPages = Math.ceil(tickets.length / pageSize);

        const tableBody = document.getElementById('ticketTableBody');
        tableBody.innerHTML = '';

        // 获取小区用户信息
        const users = getUsers();

        paginatedTickets.forEach((ticket) => {
          const row = document.createElement('tr');

          // 根据状态设置样式类
          let statusClass = '';
          switch (ticket.status) {
            case '未开始':
              statusClass = 'status-pending';
              break;
            case '进行中':
              statusClass = 'status-in-progress';
              break;
            case '已办结':
              statusClass = 'status-completed';
              break;
            case '已撤销':
            case '已关闭':
              statusClass = 'status-gray';
              break;
            case '已删除':
              statusClass = 'status-cancelled';
              break;
          }

          // 从小区用户信息中获取最新的用户数据
          const user = users.find(
            (u) =>
              u.community === ticket.community &&
              u.building === ticket.building &&
              u.unit === ticket.unit &&
              u.room === ticket.room,
          );

          // 使用最新的用户信息，如果没有找到则使用工单中存储的信息
          const owner = user ? user.owner : ticket.owner;
          const phone = user ? user.phone : ticket.phone;

          // 使用工单类型，如果没有则默认为"咨询"
          const ticketType = ticket.ticketType || '咨询';

          row.innerHTML = `
                    <td>${ticket.id}</td>
                    <td>${ticket.community}</td>
                    <td>${ticket.building}</td>
                    <td>${ticket.unit}</td>
                    <td>${ticket.room}</td>
                    <td>${owner}</td>
                    <td>${phone}</td>
                    <td>${ticket.paymentStatus}</td>
                    <td>${ticketType}</td>
                    <td class="ticket-desc-col">${ticket.description}</td>
                    <td><span class="status-badge ${statusClass}">${ticket.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-success btn-sm detail-btn" data-id="${ticket.id}" title="详情">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <button class="btn btn-warning btn-sm edit-btn" data-id="${ticket.id}" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                `;

          tableBody.appendChild(row);
        });

        // 重新绑定编辑和详情按钮事件
        bindActionButtonEvents();

        // 更新分页UI
        updateTicketPaginationUI();
      }

      // 更新工单分页UI
      function updateTicketPaginationUI() {
        // 更新页面信息
        document.getElementById('currentPage').textContent = currentTicketPage;
        document.getElementById('totalPages').textContent = totalTicketPages;
        document.getElementById('totalRecords').textContent =
          totalTicketRecords;

        // 更新每页显示数量
        document.getElementById('pageSize').value = ticketPageSize;

        // 更新按钮状态
        document.getElementById('firstPage').disabled = currentTicketPage === 1;
        document.getElementById('prevPage').disabled = currentTicketPage === 1;
        document.getElementById('nextPage').disabled =
          currentTicketPage === totalTicketPages;
        document.getElementById('lastPage').disabled =
          currentTicketPage === totalTicketPages;
      }

      // 绑定操作按钮事件
      function bindActionButtonEvents() {
        // 编辑按钮事件
        document.querySelectorAll('.edit-btn').forEach((btn) => {
          btn.addEventListener('click', function () {
            const ticketId = this.getAttribute('data-id');
            editTicket(ticketId);
          });
        });

        // 详情按钮事件
        document.querySelectorAll('.detail-btn').forEach((btn) => {
          btn.addEventListener('click', function () {
            const ticketId = this.getAttribute('data-id');
            viewTicketDetail(ticketId);
          });
        });
      }

      // 初始化新建工单表单
      function initTicketForm() {
        const users = getUsers();

        // 初始化小区名称下拉框
        const communitySelect = document.getElementById('community');
        communitySelect.innerHTML = '<option value="">请选择小区</option>';

        const communities = [...new Set(users.map((user) => user.community))];
        communitySelect.innerHTML += communities
          .map(
            (community) => `<option value="${community}">${community}</option>`,
          )
          .join('');

        // 清空其他下拉框
        document.getElementById('building').innerHTML =
          '<option value="">请选择楼号</option>';
        document.getElementById('unit').innerHTML =
          '<option value="">请选择单元</option>';
        document.getElementById('room').innerHTML =
          '<option value="">请选择房号</option>';

        // 绑定级联事件
        bindTicketFormCascadeEvents();

        // 应用默认小区设置
        applyDefaultCommunity();
      }

      // 绑定新建工单表单的级联事件
      function bindTicketFormCascadeEvents() {
        const users = getUsers();

        // 小区名称变化事件
        document
          .getElementById('community')
          .addEventListener('change', function () {
            const community = this.value;
            const buildingSelect = document.getElementById('building');

            // 清空并重置后续下拉框
            buildingSelect.innerHTML = '<option value="">请选择楼号</option>';
            document.getElementById('unit').innerHTML =
              '<option value="">请选择单元</option>';
            document.getElementById('room').innerHTML =
              '<option value="">请选择房号</option>';

            // 清空用户信息
            document.getElementById('area').value = '';
            document.getElementById('owner').value = '';
            document.getElementById('phone').value = '';

            if (community) {
              // 过滤该小区的楼号
              const buildings = [
                ...new Set(
                  users
                    .filter((user) => user.community === community)
                    .map((user) => user.building),
                ),
              ];
              buildingSelect.innerHTML += buildings
                .map(
                  (building) =>
                    `<option value="${building}">${building}</option>`,
                )
                .join('');
            }
          });

        // 楼号变化事件
        document
          .getElementById('building')
          .addEventListener('change', function () {
            const community = document.getElementById('community').value;
            const building = this.value;
            const unitSelect = document.getElementById('unit');

            // 清空并重置后续下拉框
            unitSelect.innerHTML = '<option value="">请选择单元</option>';
            document.getElementById('room').innerHTML =
              '<option value="">请选择房号</option>';

            // 清空用户信息
            document.getElementById('area').value = '';
            document.getElementById('owner').value = '';
            document.getElementById('phone').value = '';

            if (community && building) {
              // 过滤该小区该楼的单元
              const units = [
                ...new Set(
                  users
                    .filter(
                      (user) =>
                        user.community === community &&
                        user.building === building,
                    )
                    .map((user) => user.unit),
                ),
              ];
              unitSelect.innerHTML += units
                .map((unit) => `<option value="${unit}">${unit}</option>`)
                .join('');
            }
          });

        // 单元变化事件
        document.getElementById('unit').addEventListener('change', function () {
          const community = document.getElementById('community').value;
          const building = document.getElementById('building').value;
          const unit = this.value;
          const roomSelect = document.getElementById('room');

          // 清空房号下拉框
          roomSelect.innerHTML = '<option value="">请选择房号</option>';

          // 清空用户信息
          document.getElementById('area').value = '';
          document.getElementById('owner').value = '';
          document.getElementById('phone').value = '';

          if (community && building && unit) {
            // 过滤该小区该楼该单元的房号
            const rooms = [
              ...new Set(
                users
                  .filter(
                    (user) =>
                      user.community === community &&
                      user.building === building &&
                      user.unit === unit,
                  )
                  .map((user) => user.room),
              ),
            ];
            roomSelect.innerHTML += rooms
              .map((room) => `<option value="${room}">${room}</option>`)
              .join('');
          }
        });

        // 房号变化事件
        document.getElementById('room').addEventListener('change', function () {
          const community = document.getElementById('community').value;
          const building = document.getElementById('building').value;
          const unit = document.getElementById('unit').value;
          const room = this.value;

          if (community && building && unit && room) {
            // 查找对应的用户信息
            const users = getUsers();
            const user = users.find(
              (u) =>
                u.community === community &&
                u.building === building &&
                u.unit === unit &&
                u.room === room,
            );

            if (user) {
              // 自动填充用户信息
              document.getElementById('area').value = user.area;
              document.getElementById('owner').value = user.owner;
              document.getElementById('phone').value = user.phone;

              // 自动填充账单信息
              fillBillInfo(user.bills);
            }
          }
        });
      }

      // 填充账单信息
      function fillBillInfo(bills) {
        // 确保只修改当前激活的客服工单标签页中的账单容器
        // 首先获取所有账单容器
        const allBillContainers = document.querySelectorAll('.bills-container');

        // 查找当前激活标签页中的账单容器
        let billsContainer;
        const activeTab = document.querySelector('.tab-content.active');
        if (activeTab) {
          billsContainer = activeTab.querySelector('.bills-container');
        }

        // 如果没有找到，使用默认的账单容器
        if (!billsContainer) {
          billsContainer = allBillContainers[0];
        }

        // 恢复客服工单模块的表头结构（6列，不带复选框）
        const billHeader = billsContainer.querySelector('.bill-header');
        if (billHeader) {
          billHeader.innerHTML = `
                    <div>供暖季</div>
                    <div>缴费状态</div>
                    <div>费用类型</div>
                    <div>应缴(元)</div>
                    <div>实缴(元)</div>
                    <div>欠费(元)</div>
                `;
        }

        // 清空现有账单行，保留表头
        const existingRows = billsContainer.querySelectorAll('.bill-row');
        existingRows.forEach((row) => row.remove());

        // 添加账单行
        bills.forEach((bill) => {
          const billRow = document.createElement('div');
          billRow.className = 'bill-row';
          billRow.innerHTML = `
                    <div>
                        <select class="form-control" disabled>
                            <option value="${bill.heatingSeason}">${bill.heatingSeason}</option>
                        </select>
                    </div>
                    <div>
                        <select class="form-control bill-payment-status">
                            <option value="已缴费" ${bill.paymentStatus === '已缴费' ? 'selected' : ''}>已缴费</option>
                            <option value="欠费" ${bill.paymentStatus === '欠费' ? 'selected' : ''}>欠费</option>
                        </select>
                    </div>
                    <div>
                        <select class="form-control">
                            <option value="全费" ${bill.feeType === '全费' ? 'selected' : ''}>全费</option>
                            <option value="空置费" ${bill.feeType === '空置费' ? 'selected' : ''}>空置费</option>
                        </select>
                    </div>
                    <div><input type="number" class="form-control" step="0.01" value="${bill.shouldPay}"></div>
                    <div><input type="number" class="form-control" step="0.01" value="${bill.paid || 0}"></div>
                    <div><input type="number" class="form-control" step="0.01" value="${bill.arrears}"></div>
                `;
          billsContainer.appendChild(billRow);
        });

        // 级联更新缴费状态字段
        function updateTicketPaymentStatus() {
          // 获取所有账单行的缴费状态选择框
          const paymentStatusSelects = billsContainer.querySelectorAll(
            '.bill-payment-status',
          );
          const paymentStatusValues = Array.from(paymentStatusSelects).map(
            (select) => select.value,
          );

          // 如果有账单，根据所有账单的缴费状态来更新工单缴费状态
          if (paymentStatusValues.length > 0) {
            // 检查是否有任何一条账单为欠费
            const hasArrears = paymentStatusValues.some(
              (status) => status === '欠费',
            );
            const ticketPaymentStatusSelect =
              document.getElementById('paymentStatus');

            if (ticketPaymentStatusSelect) {
              // 如果有任何一条账单为欠费，则工单缴费状态为欠费
              // 只有当全部账单为已缴费时，工单缴费状态才为已缴费
              ticketPaymentStatusSelect.value = hasArrears ? '欠费' : '已缴费';
            }
          }
        }

        // 初始更新
        updateTicketPaymentStatus();

        // 添加事件监听器，当账单缴费状态变化时更新工单缴费状态
        const paymentStatusSelects = billsContainer.querySelectorAll(
          '.bill-payment-status',
        );
        paymentStatusSelects.forEach((select) => {
          select.addEventListener('change', updateTicketPaymentStatus);
        });
      }

      // 绑定事件监听器
      function bindEventListeners() {
        // 分页事件监听

        // 首页按钮
        document
          .getElementById('firstPage')
          .addEventListener('click', function () {
            loadTickets(currentTicketFilter, 1, ticketPageSize);
          });

        // 默认小区设置按钮事件
        document
          .getElementById('defaultCommunityBtn')
          .addEventListener('click', function () {
            openDefaultCommunityModal();
          });

        // 默认小区设置模态框关闭按钮事件
        document
          .querySelector('#defaultCommunityModal .close')
          .addEventListener('click', function () {
            closeDefaultCommunityModal();
          });

        // 默认小区设置取消按钮事件
        document
          .getElementById('cancelDefaultCommunityBtn')
          .addEventListener('click', function () {
            closeDefaultCommunityModal();
          });

        // 默认小区设置保存按钮事件
        document
          .getElementById('saveDefaultCommunityBtn')
          .addEventListener('click', function () {
            saveDefaultCommunity();
          });

        // 全局导出按钮事件
        document
          .getElementById('globalExportBtn')
          .addEventListener('click', function () {
            globalExport();
          });

        // 全局导入按钮事件
        document
          .getElementById('globalImportBtn')
          .addEventListener('click', function () {
            globalImport();
          });

        // 上一页按钮
        document
          .getElementById('prevPage')
          .addEventListener('click', function () {
            if (currentTicketPage > 1) {
              loadTickets(
                currentTicketFilter,
                currentTicketPage - 1,
                ticketPageSize,
              );
            }
          });

        // 下一页按钮
        document
          .getElementById('nextPage')
          .addEventListener('click', function () {
            if (currentTicketPage < totalTicketPages) {
              loadTickets(
                currentTicketFilter,
                currentTicketPage + 1,
                ticketPageSize,
              );
            }
          });

        // 末页按钮
        document
          .getElementById('lastPage')
          .addEventListener('click', function () {
            loadTickets(currentTicketFilter, totalTicketPages, ticketPageSize);
          });

        // 每页显示数量变化
        document
          .getElementById('pageSize')
          .addEventListener('change', function () {
            ticketPageSize = parseInt(this.value);
            loadTickets(currentTicketFilter, 1, ticketPageSize); // 重置到第一页
          });

        // 新建工单按钮
        document
          .getElementById('createTicketBtn')
          .addEventListener('click', function () {
            document.getElementById('createTicketModal').style.display = 'flex';

            // 修改模态框标题为"新建工单"
            const modalTitle = document.querySelector('#createTicketModal h4');
            modalTitle.innerHTML =
              '<i class="fas fa-plus-circle"></i> 新建工单';

            // 重置表单
            document.getElementById('ticketForm').reset();

            // 重新生成工单号和时间
            generateTicketNumber();
            document.getElementById('createTime').value =
              new Date().toLocaleString();

            // 设置创建人和办理人为当前登录用户
            const currentUser = sessionStorage.getItem('currentUser');
            const username = currentUser
              ? JSON.parse(currentUser).username
              : '系统管理员';
            document.getElementById('creator').value = username;
            document.getElementById('processor').value = username;

            // 设置字段为可编辑
            document.getElementById('community').disabled = false;
            document.getElementById('building').disabled = false;
            document.getElementById('unit').disabled = false;
            document.getElementById('room').disabled = false;
            document.getElementById('area').disabled = false;

            // 初始化工单表单
            initTicketForm();
          });

        // 关闭模态框
        document
          .querySelectorAll('.close, #cancelTicketBtn')
          .forEach((element) => {
            element.addEventListener('click', function () {
              document.getElementById('createTicketModal').style.display =
                'none';
              // 重置表单
              document.getElementById('ticketForm').reset();
              // 设置字段为可编辑
              document.getElementById('community').disabled = false;
              document.getElementById('building').disabled = false;
              document.getElementById('unit').disabled = false;
              document.getElementById('room').disabled = false;
              document.getElementById('area').disabled = false;
            });
          });

        // 工单表单提交
        document
          .getElementById('ticketForm')
          .addEventListener('submit', function (e) {
            e.preventDefault();

            // 获取表单数据
            const ticketData = {
              id: document.getElementById('ticketNumber').value,
              createTime: document.getElementById('createTime').value,
              community: document.getElementById('community').value,
              building: document.getElementById('building').value,
              unit: document.getElementById('unit').value,
              room: document.getElementById('room').value,
              area: document.getElementById('area').value,
              owner: document.getElementById('owner').value,
              phone: document.getElementById('phone').value,
              creator: document.getElementById('creator').value,
              processor: document.getElementById('processor').value,
              description: document.getElementById('description').value,
              ticketType: document.getElementById('ticketType').value,
              status: document.getElementById('ticketStatus').value,
              // 从表单中获取缴费状态
              paymentStatus: document.getElementById('paymentStatus').value,
            };

            // 保存工单
            const tickets = getTickets();
            const existingIndex = tickets.findIndex(
              (t) => t.id === ticketData.id,
            );

            if (existingIndex >= 0) {
              // 更新现有工单
              tickets[existingIndex] = ticketData;
              saveTickets(tickets);
              alert('工单更新成功！');
            } else {
              // 添加新工单
              tickets.push(ticketData);
              saveTickets(tickets);
              alert('工单创建成功！');
            }

            // 保存账单信息到小区用户信息中
            const community = ticketData.community;
            const building = ticketData.building;
            const unit = ticketData.unit;
            const room = ticketData.room;

            // 获取当前表单中的账单信息
            const billsContainer = document.querySelector('.bills-container');
            const billRows = billsContainer.querySelectorAll('.bill-row');
            const updatedBills = Array.from(billRows).map((row) => {
              const selects = row.querySelectorAll('select');
              const inputs = row.querySelectorAll('input');

              return {
                heatingSeason: selects[0].value,
                paymentStatus: selects[1].value,
                feeType: selects[2].value,
                shouldPay: parseFloat(inputs[0].value) || 0,
                paid: parseFloat(inputs[1].value) || 0,
                arrears: parseFloat(inputs[2].value) || 0,
              };
            });

            // 更新用户信息中的账单和基本信息
            const users = getUsers();
            const userIndex = users.findIndex(
              (u) =>
                u.community === community &&
                u.building === building &&
                u.unit === unit &&
                u.room === room,
            );

            if (userIndex >= 0) {
              // 更新现有用户的信息
              users[userIndex].owner = ticketData.owner; // 更新业主姓名
              users[userIndex].phone = ticketData.phone; // 更新电话
              users[userIndex].bills = updatedBills; // 更新账单信息
              saveUsers(users);
            } else {
              // 如果用户不存在，创建新用户
              const newUser = {
                community: community,
                building: building,
                unit: unit,
                room: room,
                area: ticketData.area,
                owner: ticketData.owner,
                phone: ticketData.phone,
                bills: updatedBills,
              };
              users.push(newUser);
              saveUsers(users);
            }

            // 更新工单列表
            loadTickets();

            // 更新工单统计
            updateTicketStats();

            // 关闭模态框
            document.getElementById('createTicketModal').style.display = 'none';
            document.getElementById('ticketForm').reset();
          });

        // 小区用户信息导入
        document
          .getElementById('importUserBtn')
          .addEventListener('click', function () {
            importUsers();
          });

        // 小区用户信息导出
        document
          .getElementById('exportUserBtn')
          .addEventListener('click', function () {
            exportUsers();
          });

        // 工单导入
        document
          .getElementById('importTicketBtn')
          .addEventListener('click', function () {
            importTickets();
          });

        // 线下缴费导入
        document
          .getElementById('importPaymentBtn')
          .addEventListener('click', function () {
            importPayments();
          });

        // 线下缴费导出
        document
          .getElementById('exportPaymentBtn')
          .addEventListener('click', function () {
            exportPayments();
          });

        // 查询按钮
        document
          .getElementById('searchBtn')
          .addEventListener('click', function () {
            const filter = {
              community: document.getElementById('searchCommunity').value,
              building: document.getElementById('searchBuilding').value,
              unit: document.getElementById('searchUnit').value,
              room: document.getElementById('searchRoom').value,
              owner: document.getElementById('searchOwner').value,
              phone: document.getElementById('searchPhone').value,
              paymentStatus: document.getElementById('searchPaymentStatus')
                .value,
              ticketType: document.getElementById('searchTicketType').value,
              status: document.getElementById('searchTicketStatus').value,
            };
            // 保存当前查询条件
            currentTicketFilter = filter;
            loadTickets(filter, 1, ticketPageSize); // 查询时重置到第一页
          });

        // 新建收费按钮
        document
          .getElementById('newPaymentBtn')
          .addEventListener('click', function () {
            const modal = document.getElementById('createPaymentModal');
            const modalTitle = modal.querySelector('.modal-header h4');
            const paymentForm = document.getElementById('paymentCreateForm');

            // 设置窗口标题为"新建收费"
            modalTitle.innerHTML =
              '<i class="fas fa-plus-circle"></i> 新建收费';

            // 显示模态框
            modal.style.display = 'flex';

            // 重置表单
            document.getElementById('paymentCreateForm').reset();

            // 特殊处理下拉框
            const selectFields = [
              'paymentCommunity',
              'paymentBuilding',
              'paymentUnit',
              'paymentRoom',
              'paymentMethod',
            ];
            selectFields.forEach((fieldId) => {
              const field = document.getElementById(fieldId);
              if (field) {
                field.removeAttribute('disabled');
              }
            });

            // 生成收费单号和时间
            document.getElementById('paymentNumber').value =
              generatePaymentNumber();
            document.getElementById('paymentCreateTime').value =
              new Date().toLocaleString();

            // 设置默认日期为今天
            document.getElementById('paymentDate').valueAsDate = new Date();

            // 设置创建人和办理人为当前登录用户
            const currentUser = sessionStorage.getItem('currentUser');
            const username = currentUser
              ? JSON.parse(currentUser).username
              : '系统管理员';
            document.getElementById('paymentCreator').value = username;
            document.getElementById('paymentProcessor').value = username;

            // 初始收费表单
            initPaymentForm();

            // 从小区单价读取并设置到表单中
            const selectedCommunity =
              document.getElementById('communitySelect').value;
            let unitPrice = 5.8;
            if (selectedCommunity) {
              // 从独立的存储中获取小区单价
              const communityUnitPrices =
                JSON.parse(
                  localStorage.getItem('idh_heating_community_unit_prices'),
                ) || {};
              unitPrice =
                parseFloat(communityUnitPrices[selectedCommunity]) || 5.8;
            }
            document.getElementById('paymentUnitPrice').value =
              unitPrice.toFixed(2);

            // 计算应缴金额
            calculatePaymentAmount();
          });

        // 支付方式变化时生成二维码
        document
          .getElementById('paymentMethod')
          .addEventListener('change', function () {
            const paymentMethod = this.value;
            const shouldPay = document.getElementById('paymentShouldPay').value;
            const actualPay = document.getElementById('paymentActualPay');

            // 根据支付方式自动填充实收金额
            if (
              paymentMethod === '微信支付' ||
              paymentMethod === '支付宝' ||
              paymentMethod === '银行卡'
            ) {
              // 电子支付方式，自动填充为应缴金额
              actualPay.value = shouldPay;
            } else if (paymentMethod === '现金' || paymentMethod === '其他') {
              // 现金或其他支付方式，清空实收金额
              actualPay.value = '';
            }

            generatePaymentQrCode();

            // 计算应找、实找和找零损耗
            calculatePaymentAmount();
          });

        // 实收金额变化时更新二维码金额和计算找零
        document
          .getElementById('paymentActualPay')
          .addEventListener('input', function () {
            generatePaymentQrCode();
            // 计算应找、实找和找零损耗
            calculatePaymentAmount();
          });

        // 关闭收费模态框
        document
          .querySelectorAll('#createPaymentModal .close, #cancelPaymentBtn')
          .forEach((element) => {
            element.addEventListener('click', function () {
              document.getElementById('createPaymentModal').style.display =
                'none';
              // 重置表单状态
              window.resetPaymentForm();
              // 隐藏二维码
              document.getElementById('paymentQrCodeSection').style.display =
                'none';
            });
          });

        // 生成支付二维码 - 暴露到全局作用域
        window.generatePaymentQrCode = function () {
          const paymentMethod = document.getElementById('paymentMethod').value;
          const amount = document.getElementById('paymentActualPay').value;
          const qrCodeSection = document.getElementById('paymentQrCodeSection');
          const qrCodeLabel = document.getElementById('paymentQrCodeLabel');
          const qrCodeContainer = document.getElementById('paymentQrCode');
          const qrCodeAmount = document.getElementById('paymentQrCodeAmount');
          const qrCodeHint = document.getElementById('paymentQrCodeHint');

          // 如果是微信支付或支付宝，显示二维码
          if (paymentMethod === '微信支付' || paymentMethod === '支付宝') {
            // 设置标签和金额
            qrCodeLabel.textContent = `${paymentMethod}二维码`;
            qrCodeAmount.textContent = `¥ ${amount || '0.00'}`;

            // 设置提示信息
            if (paymentMethod === '微信支付') {
              qrCodeHint.textContent = '请使用微信扫描二维码支付';
            } else if (paymentMethod === '支付宝') {
              qrCodeHint.textContent = '请使用支付宝扫描二维码支付';
            }

            // 生成二维码内容
            let qrCodeContent = '';
            if (paymentMethod === '微信支付') {
              // 微信支付二维码格式示例
              qrCodeContent = `wxp://payexample?amount=${amount}&desc=供暖费`;
            } else if (paymentMethod === '支付宝') {
              // 支付宝支付二维码格式示例
              qrCodeContent = `alipay://example?amount=${amount}&desc=供暖费`;
            }

            // 清空容器
            qrCodeContainer.innerHTML = '';

            // 使用QRCode.js生成二维码
            new QRCode(qrCodeContainer, {
              text: qrCodeContent,
              width: 200,
              height: 200,
              colorDark: '#000000',
              colorLight: '#ffffff',
              correctLevel: QRCode.CorrectLevel.L,
            });

            // 显示二维码区域
            qrCodeSection.style.display = 'block';
          } else {
            // 其他支付方式，隐藏二维码
            qrCodeSection.style.display = 'none';
          }
        };

        // 收费表单提交事件
        document
          .getElementById('paymentCreateForm')
          .addEventListener('submit', function (e) {
            e.preventDefault();

            // 获取选中的账单信息
            const checkedCheckboxes = document.querySelectorAll(
              '.bill-checkbox:checked',
            );
            if (checkedCheckboxes.length === 0) {
              alert('请至少选择一条账单进行缴费！');
              return;
            }

            // 从选中的账单中获取供暖季和费用类型信息
            const firstBill = checkedCheckboxes[0];
            const heatingSeason = firstBill.dataset.heatingSeason;
            const feeType = firstBill.dataset.feeType;

            // 获取表单数据
            const paymentData = {
              id: document.getElementById('paymentNumber').value,
              receiptNumber: document.getElementById('receiptNumber').value,
              community: document.getElementById('paymentCommunity').value,
              building: document.getElementById('paymentBuilding').value,
              unit: document.getElementById('paymentUnit').value,
              room: document.getElementById('paymentRoom').value,
              area: parseFloat(document.getElementById('paymentArea').value),
              owner: document.getElementById('paymentOwner').value,
              phone: document.getElementById('paymentPhone').value,
              heatingSeason: heatingSeason,
              feeType: feeType,
              unitPrice: parseFloat(
                document.getElementById('paymentUnitPrice').value,
              ),
              shouldPay: parseFloat(
                document.getElementById('paymentShouldPay').value,
              ),
              actualPay: parseFloat(
                document.getElementById('paymentActualPay').value,
              ),
              paid: parseFloat(document.getElementById('paymentPaid').value),
              change: parseFloat(
                document.getElementById('paymentChange').value,
              ),
              actualChange: parseFloat(
                document.getElementById('paymentActualChange').value,
              ),
              changeLoss: parseFloat(
                document.getElementById('paymentChangeLoss').value,
              ),
              paymentDate: document.getElementById('paymentDate').value,
              paymentMethod: document.getElementById('paymentMethod').value,
              creator: document.getElementById('paymentCreator').value,
              processor: document.getElementById('paymentProcessor').value,
              remarks: document.getElementById('paymentRemarks').value,
              createTime: document.getElementById('paymentCreateTime').value,
              status: 'paid',
              createdAt: new Date().toISOString(),
            };

            // 获取编辑标志
            const editFlag = document.getElementById('editPaymentFlag');
            const originalId =
              document.getElementById('originalPaymentId')?.value;
            const isEditMode = editFlag && editFlag.value === 'true';

            // 保存收费记录
            const payments =
              JSON.parse(localStorage.getItem('idh_heating_payments')) || [];

            if (isEditMode) {
              // 编辑模式：更新允许编辑的字段
              const existingIndex = payments.findIndex(
                (p) => p.id === originalId,
              );
              if (existingIndex !== -1) {
                // 获取原记录
                const originalPayment = payments[existingIndex];

                // 更新允许编辑的字段
                originalPayment.receiptNumber =
                  document.getElementById('receiptNumber').value;
                originalPayment.paymentDate =
                  document.getElementById('paymentDate').value;
                originalPayment.processor =
                  document.getElementById('paymentProcessor').value;

                // 更新实找、找零和找零损耗等字段
                originalPayment.change = parseFloat(
                  document.getElementById('paymentChange').value,
                );
                originalPayment.actualChange = parseFloat(
                  document.getElementById('paymentActualChange').value,
                );
                originalPayment.changeLoss = parseFloat(
                  document.getElementById('paymentChangeLoss').value,
                );

                // 保存更新后的记录
                payments[existingIndex] = originalPayment;
              }

              // 同步更新小区用户信息中的业主姓名和电话
              const users =
                JSON.parse(localStorage.getItem('idh_heating_users')) || [];
              const userIndex = users.findIndex(
                (u) =>
                  u.community === paymentData.community &&
                  u.building === paymentData.building &&
                  u.unit === paymentData.unit &&
                  u.room === paymentData.room,
              );

              if (userIndex >= 0) {
                // 更新用户信息
                users[userIndex].owner = paymentData.owner;
                users[userIndex].phone = paymentData.phone;
                localStorage.setItem(
                  'idh_heating_users',
                  JSON.stringify(users),
                );
              }
            } else {
              // 新建模式：添加新记录
              payments.push(paymentData);

              // 同步更新小区用户信息中的业主姓名和电话
              const users =
                JSON.parse(localStorage.getItem('idh_heating_users')) || [];
              const userIndex = users.findIndex(
                (u) =>
                  u.community === paymentData.community &&
                  u.building === paymentData.building &&
                  u.unit === paymentData.unit &&
                  u.room === paymentData.room,
              );

              if (userIndex >= 0) {
                // 更新用户信息
                users[userIndex].owner = paymentData.owner;
                users[userIndex].phone = paymentData.phone;
                localStorage.setItem(
                  'idh_heating_users',
                  JSON.stringify(users),
                );
              }

              // 更新用户账单信息
              updateUserBillsAfterPayment();

              // 创建客服工单
              const workOrder = {
                id: `GD${new Date().toISOString().slice(0, 10).replace(/-/g, '')}${Math.floor(
                  Math.random() * 1000,
                )
                  .toString()
                  .padStart(3, '0')}`,
                createTime: new Date().toLocaleString(),
                community: paymentData.community,
                building: paymentData.building,
                unit: paymentData.unit,
                room: paymentData.room,
                area: paymentData.area,
                owner: paymentData.owner,
                phone: paymentData.phone,
                creator: paymentData.creator,
                processor: paymentData.processor,
                description: `收费记录：${paymentData.remarks || '无备注'}`,
                ticketType: '缴费',
                status: '未开始',
                paymentStatus: '已缴费',
                // 添加收费相关扩展信息
                paymentId: paymentData.id,
                paymentAmount: paymentData.paid,
                paymentDate: paymentData.paymentDate,
                paymentMethod: paymentData.paymentMethod,
              };

              // 保存工单到localStorage
              const existingTickets =
                JSON.parse(localStorage.getItem('idh_heating_tickets')) || [];
              existingTickets.push(workOrder);
              localStorage.setItem(
                'idh_heating_tickets',
                JSON.stringify(existingTickets),
              );
            }

            // 保存收费记录
            localStorage.setItem(
              'idh_heating_payments',
              JSON.stringify(payments),
            );

            // 更新零钱余额：零钱余额 = 零钱余额 + 找零损耗
            const selectedCommunity =
              document.getElementById('paymentCommunity').value;
            const changeLoss =
              parseFloat(document.getElementById('paymentChangeLoss').value) ||
              0;

            // 从localStorage获取当前的零钱余额
            const communityChange =
              JSON.parse(
                localStorage.getItem('idh_heating_community_change'),
              ) || {};
            const currentChange =
              parseFloat(communityChange[selectedCommunity]) || 0;

            // 计算新的零钱余额
            const newChange = currentChange + changeLoss;

            // 保存更新后的零钱余额
            communityChange[selectedCommunity] = newChange;
            localStorage.setItem(
              'idh_heating_community_change',
              JSON.stringify(communityChange),
            );

            // 关闭模态框
            document.getElementById('createPaymentModal').style.display =
              'none';
            document.getElementById('paymentCreateForm').reset();

            // 重置编辑标志
            if (editFlag) {
              editFlag.value = 'false';
            }

            // 显示成功信息
            if (isEditMode) {
              alert('收费记录编辑成功！');
            } else {
              alert('收费记录创建成功！同时已自动生成客服工单。');
              // 更新工单统计数据
              updateTicketStats();
            }

            // 更新收费记录统计数据
            updateStats();

            // 重新渲染收费记录表格
            renderPaymentsTable();

            // 重新渲染工单列表
            loadTickets();
          });

        // 更新用户账单信息
        function updateUserBillsAfterPayment() {
          const community = document.getElementById('paymentCommunity').value;
          const building = document.getElementById('paymentBuilding').value;
          const unit = document.getElementById('paymentUnit').value;
          const room = document.getElementById('paymentRoom').value;
          const actualPay =
            parseFloat(document.getElementById('paymentActualPay').value) || 0;

          // 获取用户信息
          const users =
            JSON.parse(localStorage.getItem('idh_heating_users')) || [];
          const userIndex = users.findIndex(
            (u) =>
              u.community === community &&
              u.building === building &&
              u.unit === unit &&
              u.room === room,
          );

          if (userIndex === -1) return;

          // 获取选中的账单并更新
          const checkedCheckboxes = document.querySelectorAll(
            '.bill-checkbox:checked:not(:disabled)',
          );
          let remainingAmount = actualPay;

          checkedCheckboxes.forEach((checkbox) => {
            const heatingSeason = checkbox.dataset.heatingSeason;
            const feeType = checkbox.dataset.feeType;
            const shouldPay = parseFloat(checkbox.dataset.shouldPay) || 0;

            // 查找对应的账单
            const billIndex = users[userIndex].bills.findIndex(
              (bill) =>
                bill.heatingSeason === heatingSeason &&
                bill.feeType === feeType,
            );

            if (billIndex !== -1) {
              // 更新账单信息
              const bill = users[userIndex].bills[billIndex];
              const paymentForThisBill = Math.min(
                remainingAmount,
                bill.arrears,
              );

              bill.paid = (bill.paid || 0) + paymentForThisBill;
              bill.arrears = Math.max(0, bill.arrears - paymentForThisBill);

              if (bill.arrears === 0) {
                bill.paymentStatus = '已缴费';
              }

              remainingAmount -= paymentForThisBill;
              if (remainingAmount <= 0) return false; // 金额已用完，停止处理
            }
          });

          // 保存更新后的用户信息
          localStorage.setItem('idh_heating_users', JSON.stringify(users));
        }
      }

      // 生成收费单号
      function generatePaymentNumber() {
        const now = new Date();
        const dateStr =
          now.getFullYear().toString() +
          (now.getMonth() + 1).toString().padStart(2, '0') +
          now.getDate().toString().padStart(2, '0');

        // 获取现有收费记录数量
        const payments =
          JSON.parse(localStorage.getItem('idh_heating_payments')) || [];
        const paymentCount = payments.length + 1;
        const serial = paymentCount.toString().padStart(3, '0');

        return `SF${dateStr}${serial}`;
      }

      // 初始收费表单
      function initPaymentForm() {
        const users =
          JSON.parse(localStorage.getItem('idh_heating_users')) || [];

        // 初始化小区名称下拉框
        const communitySelect = document.getElementById('paymentCommunity');
        communitySelect.innerHTML = '<option value="">请选择小区</option>';

        const communities = [...new Set(users.map((user) => user.community))];
        communitySelect.innerHTML += communities
          .map(
            (community) => `<option value="${community}">${community}</option>`,
          )
          .join('');

        // 清空其他下拉框
        document.getElementById('paymentBuilding').innerHTML =
          '<option value="">请选择楼号</option>';
        document.getElementById('paymentUnit').innerHTML =
          '<option value="">请选择单元</option>';
        document.getElementById('paymentRoom').innerHTML =
          '<option value="">请选择房号</option>';

        // 绑定级联事件
        bindPaymentFormCascadeEvents();

        // 应用默认小区设置
        applyDefaultCommunity();
      }

      // 填充收费模块账单信息 - 定义在全局作用域，确保页面加载时立即被定义
      window.fillPaymentBillInfo = function (user) {
        const billsContainer =
          document.getElementById('paymentBillRow').parentElement;
        const existingRows = billsContainer.querySelectorAll('.bill-row');

        // 保留初始行，移除其他行
        existingRows.forEach((row, index) => {
          if (row.id !== 'paymentBillRow') {
            row.remove();
          }
        });

        const initialRow = document.getElementById('paymentBillRow');

        if (!user || !user.bills || user.bills.length === 0) {
          // 如果没有用户信息或账单信息，清空初始行
          initialRow.innerHTML = `
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                `;
          return;
        }

        // 确保表头有复选框列 - 只修改收费模块的表头
        const billHeader = billsContainer.querySelector('.bill-header');
        // 检查表头是否已经有7列（包括复选框列）
        if (billHeader.children.length !== 7) {
          // 如果没有复选框列，重新创建表头
          billHeader.innerHTML = `
                    <div class="checkbox-column"></div>
                    <div>供暖季</div>
                    <div>缴费状态</div>
                    <div>费用类型</div>
                    <div>应缴(元)</div>
                    <div>实缴(元)</div>
                    <div>欠费(元)</div>
                `;
        }

        // 清空初始行
        initialRow.innerHTML = '';

        // 添加所有账单行
        user.bills.forEach((bill) => {
          const billRow = document.createElement('div');
          billRow.className = 'bill-row bill-row-nowrap';
          billRow.innerHTML = `
                    <div class="checkbox-column">
                        <input type="checkbox" class="bill-checkbox" 
                               data-bill-id="${bill.heatingSeason}-${bill.feeType}" 
                               data-should-pay="${bill.shouldPay}" 
                               data-heating-season="${bill.heatingSeason}" 
                               data-fee-type="${bill.feeType}" 
                               ${bill.paymentStatus === '已缴费' ? 'disabled' : ''}>
                    </div>
                    <div>${bill.heatingSeason}</div>
                    <div><span class="status-badge status-${bill.paymentStatus === '已缴费' ? 'completed' : 'pending'}">${bill.paymentStatus}</span></div>
                    <div>${bill.feeType}</div>
                    <div>¥${bill.shouldPay.toFixed(2)}</div>
                    <div>¥${(bill.paid || 0).toFixed(2)}</div>
                    <div>¥${bill.arrears.toFixed(2)}</div>
                `;
          billsContainer.appendChild(billRow);
        });

        // 绑定复选框事件
        if (typeof window.bindBillCheckboxEvents === 'function') {
          window.bindBillCheckboxEvents();
        }

        // 初始计算应缴金额
        if (typeof window.updateTotalShouldPay === 'function') {
          window.updateTotalShouldPay();
        }
      };

      // 绑定收费表单的级联事件
      window.bindPaymentFormCascadeEvents = function () {
        const users =
          JSON.parse(localStorage.getItem('idh_heating_users')) || [];

        // 小区名称变化事件
        document
          .getElementById('paymentCommunity')
          .addEventListener('change', function () {
            const community = this.value;
            const buildingSelect = document.getElementById('paymentBuilding');

            // 清空并重置后续下拉框
            buildingSelect.innerHTML = '<option value="">请选择楼号</option>';
            document.getElementById('paymentUnit').innerHTML =
              '<option value="">请选择单元</option>';
            document.getElementById('paymentRoom').innerHTML =
              '<option value="">请选择房号</option>';

            // 清空用户信息
            document.getElementById('paymentArea').value = '';
            document.getElementById('paymentOwner').value = '';
            document.getElementById('paymentPhone').value = '';

            // 清空账单信息
            window.fillPaymentBillInfo(null);

            if (community) {
              // 过滤该小区的楼号
              const buildings = [
                ...new Set(
                  users
                    .filter((user) => user.community === community)
                    .map((user) => user.building),
                ),
              ];
              buildingSelect.innerHTML += buildings
                .map(
                  (building) =>
                    `<option value="${building}">${building}</option>`,
                )
                .join('');

              // 设置该小区的单价
              // 从独立的存储中获取小区单价
              const communityUnitPrices =
                JSON.parse(
                  localStorage.getItem('idh_heating_community_unit_prices'),
                ) || {};
              const unitPrice =
                parseFloat(communityUnitPrices[community]) || 5.8;
              document.getElementById('paymentUnitPrice').value =
                unitPrice.toFixed(2);
            }

            // 重新计算应缴金额
            window.calculatePaymentAmount();
          });

        // 楼号变化事件
        document
          .getElementById('paymentBuilding')
          .addEventListener('change', function () {
            const community = document.getElementById('paymentCommunity').value;
            const building = this.value;
            const unitSelect = document.getElementById('paymentUnit');

            // 清空并重置后续下拉框
            unitSelect.innerHTML = '<option value="">请选择单元</option>';
            document.getElementById('paymentRoom').innerHTML =
              '<option value="">请选择房号</option>';

            // 清空用户信息
            document.getElementById('paymentArea').value = '';
            document.getElementById('paymentOwner').value = '';
            document.getElementById('paymentPhone').value = '';

            if (community && building) {
              // 过滤该小区该楼的单元
              const units = [
                ...new Set(
                  users
                    .filter(
                      (user) =>
                        user.community === community &&
                        user.building === building,
                    )
                    .map((user) => user.unit),
                ),
              ];
              unitSelect.innerHTML += units
                .map((unit) => `<option value="${unit}">${unit}</option>`)
                .join('');
            }

            // 重新计算应缴金额
            window.calculatePaymentAmount();
          });

        // 单元变化事件
        document
          .getElementById('paymentUnit')
          .addEventListener('change', function () {
            const community = document.getElementById('paymentCommunity').value;
            const building = document.getElementById('paymentBuilding').value;
            const unit = this.value;
            const roomSelect = document.getElementById('paymentRoom');

            // 清空房号下拉框
            roomSelect.innerHTML = '<option value="">请选择房号</option>';

            // 清空用户信息
            document.getElementById('paymentArea').value = '';
            document.getElementById('paymentOwner').value = '';
            document.getElementById('paymentPhone').value = '';

            if (community && building && unit) {
              // 过滤该小区该楼该单元的房号
              const rooms = [
                ...new Set(
                  users
                    .filter(
                      (user) =>
                        user.community === community &&
                        user.building === building &&
                        user.unit === unit,
                    )
                    .map((user) => user.room),
                ),
              ];
              roomSelect.innerHTML += rooms
                .map((room) => `<option value="${room}">${room}</option>`)
                .join('');
            }

            // 重新计算应缴金额
            window.calculatePaymentAmount();
          });

        // 房号变化事件
        document
          .getElementById('paymentRoom')
          .addEventListener('change', function () {
            const community = document.getElementById('paymentCommunity').value;
            const building = document.getElementById('paymentBuilding').value;
            const unit = document.getElementById('paymentUnit').value;
            const room = this.value;

            if (community && building && unit && room) {
              // 查找对应的用户信息
              const users =
                JSON.parse(localStorage.getItem('idh_heating_users')) || [];
              const user = users.find(
                (u) =>
                  u.community === community &&
                  u.building === building &&
                  u.unit === unit &&
                  u.room === room,
              );

              if (user) {
                document.getElementById('paymentArea').value = user.area || '';
                document.getElementById('paymentOwner').value =
                  user.owner || '';
                document.getElementById('paymentPhone').value =
                  user.phone || '';

                // 填充账单信息
                window.fillPaymentBillInfo(user);

                return; // 已在fillPaymentBillInfo中处理应缴金额
              }
            } else {
              // 清空账单信息
              window.fillPaymentBillInfo(null);
            }

            // 如果没有找到对应的用户信息或账单信息，使用面积和单价计算应缴金额
            window.calculatePaymentAmount();
          });

        // 移除不再需要的事件监听器
        // 供暖面积变化事件 - 不再需要，因为应缴金额从账单中计算
        // 单价变化事件 - 不再需要，因为单价已设置为只读

        // 实缴金额变化事件 - 使用防抖优化，减少计算频率
        let actualPayDebounceTimer;
        document
          .getElementById('paymentActualPay')
          .addEventListener('input', function () {
            clearTimeout(actualPayDebounceTimer);
            actualPayDebounceTimer = setTimeout(calculatePaymentAmount, 100);
          });

        // 绑定账单复选框事件
        window.bindBillCheckboxEvents = function () {
          const checkboxes = document.querySelectorAll('.bill-checkbox');
          checkboxes.forEach((checkbox) => {
            checkbox.addEventListener('change', updateTotalShouldPay);
          });
        };

        // 更新总应缴金额
        window.updateTotalShouldPay = function () {
          // 只计算未被禁用的已勾选复选框，确保只计算未缴费账单
          const checkedCheckboxes = document.querySelectorAll(
            '.bill-checkbox:checked',
          );
          console.log('当前选中的账单数量：' + checkedCheckboxes.length);
          let totalShouldPay = 0;
          let heatingSeasons = [];

          checkedCheckboxes.forEach((checkbox) => {
            totalShouldPay += parseFloat(checkbox.dataset.shouldPay) || 0;
            heatingSeasons.push(checkbox.dataset.heatingSeason);
          });

          // 更新应缴金额输入框
          document.getElementById('paymentShouldPay').value =
            totalShouldPay.toFixed(2);

          // 更新大写金额
          const uppercaseAmount = convertToChineseAmount(totalShouldPay);
          document.getElementById('paymentShouldPayUppercase').textContent =
            uppercaseAmount;

          // 更新供暖季：从选中的账单中获取，如多选账单，选择最近的供暖季显示
          if (heatingSeasons.length > 0) {
            // 排序供暖季，选择最近的（降序排列）
            const sortedSeasons = heatingSeasons.sort((a, b) => {
              // 供暖季格式为 "YYYY-YYYY"，如 "2023-2024"
              const yearA = parseInt(a.split('-')[0]);
              const yearB = parseInt(b.split('-')[0]);
              return yearB - yearA;
            });
            document.getElementById('paymentHeatingSeason').value =
              sortedSeasons[0];
          } else {
            // 如果没有选中账单，清空供暖季
            document.getElementById('paymentHeatingSeason').value = '';
          }

          // 处理实收金额
          const paymentMethod = document.getElementById('paymentMethod').value;
          const actualPay = document.getElementById('paymentActualPay');

          if (checkedCheckboxes.length > 0) {
            // 如果有选中的账单
            if (
              paymentMethod === '微信支付' ||
              paymentMethod === '支付宝' ||
              paymentMethod === '银行卡'
            ) {
              // 电子支付方式，自动填充为应缴金额
              actualPay.value = totalShouldPay.toFixed(2);
            }
          } else {
            // 如果没有选中的账单，清空实收金额
            actualPay.value = '';
          }

          // 重新计算找零
          calculatePaymentAmount();

          // 生成二维码
          generatePaymentQrCode();
        };

        // 修改计算缴费金额函数，使其使用勾选账单的应缴金额
        window.calculatePaymentAmount = function () {
          // 不再调用updateTotalShouldPay，避免无限递归
          const shouldPay =
            parseFloat(document.getElementById('paymentShouldPay').value) || 0;
          const actualPay =
            parseFloat(document.getElementById('paymentActualPay').value) || 0;

          // 计算实缴金额：无论如何，实缴都等于应缴
          let paid = shouldPay;

          // 计算应找金额: 实收 - 实缴 = 应找
          const change = actualPay - paid;

          // 计算实找金额：1-5分舍去，6-9分进位1角
          let actualChange = 0;
          if (change > 0) {
            // 只有当应找金额为正数时，才进行分位处理
            // 将金额转换为分，方便处理
            // 使用Math.round()避免浮点数精度问题，例如0.04元应该是4分而不是3分
            const changeInCents = Math.round(change * 100);

            // 获取角位和分位
            const cents = changeInCents % 10;
            const dollars = Math.floor(changeInCents / 10);

            // 根据分位处理：1-5分舍去，6-9分进位1角
            let finalDollars = dollars;
            if (cents >= 6) {
              // 6-9分：进位1角
              finalDollars += 1;
            }
            // 1-5分：舍去

            // 转换回元
            actualChange = finalDollars / 10;
          }

          // 计算找零损耗
          const changeLoss = change - actualChange;

          // 更新实缴金额
          document.getElementById('paymentPaid').value = paid.toFixed(2);

          // 更新应找金额
          document.getElementById('paymentChange').value = change.toFixed(2);

          // 更新实找金额
          document.getElementById('paymentActualChange').value =
            actualChange.toFixed(2);

          // 更新找零损耗
          document.getElementById('paymentChangeLoss').value =
            changeLoss.toFixed(2);

          // 生成二维码，确保二维码金额与实收金额一致
          window.generatePaymentQrCode();
        };

        // 移除不再需要的供暖季变化事件监听器
        // 移除不再需要的费用类型变化事件监听器
      };

      // 金额转大写
      function convertToChineseAmount(amount) {
        const digit = [
          '零',
          '壹',
          '贰',
          '叁',
          '肆',
          '伍',
          '陆',
          '柒',
          '捌',
          '玖',
        ];
        const unit = [
          '',
          '拾',
          '佰',
          '仟',
          '万',
          '拾',
          '佰',
          '仟',
          '亿',
          '拾',
          '佰',
          '仟',
        ];
        const decimal = ['角', '分'];

        amount = parseFloat(amount).toFixed(2);
        const parts = amount.split('.');
        const integerPart = parts[0];
        const decimalPart = parts[1];

        let result = '';

        // 处理整数部分
        if (parseInt(integerPart) === 0) {
          result = '零元';
        } else {
          const digits = integerPart.split('').reverse();
          for (let i = 0; i < digits.length; i++) {
            const d = parseInt(digits[i]);
            const u = unit[i];

            if (d === 0) {
              // 如果当前位是0，且前一位不是0，添加零
              if (i > 0 && parseInt(digits[i - 1]) !== 0) {
                result = '零' + result;
              }
              // 处理万位
              if (i === 4 && result !== '') {
                result = '万' + result;
              }
              // 处理亿位
              if (i === 8) {
                result = '亿' + result;
              }
            } else {
              result = digit[d] + u + result;
            }
          }
          result += '元';
        }

        // 处理小数部分
        if (parseInt(decimalPart) === 0) {
          result += '整';
        } else {
          for (let i = 0; i < decimalPart.length; i++) {
            const d = parseInt(decimalPart[i]);
            if (d !== 0) {
              result += digit[d] + decimal[i];
            }
          }
        }

        return result;
      }

      // 工单导出
      document
        .getElementById('exportTicketBtn')
        .addEventListener('click', function () {
          exportTickets();
        });

      // 查询按钮
      document
        .getElementById('searchBtn')
        .addEventListener('click', function () {
          const filter = {
            community: document.getElementById('searchCommunity').value,
            building: document.getElementById('searchBuilding').value,
            unit: document.getElementById('searchUnit').value,
            room: document.getElementById('searchRoom').value,
            owner: document.getElementById('searchOwner').value,
            phone: document.getElementById('searchPhone').value,
            paymentStatus: document.getElementById('searchPaymentStatus').value,
            ticketType: document.getElementById('searchTicketType').value,
            status: document.getElementById('searchTicketStatus').value,
          };
          loadTickets(filter);
        });

      // 导入小区用户信息
      function importUsers() {
        // 创建文件输入元素
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';

        input.onchange = function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
              try {
                const users = JSON.parse(event.target.result);
                saveUsers(users);
                alert(
                  '小区用户信息导入成功！共导入 ' + users.length + ' 条记录。',
                );
                // 更新查询下拉框选项
                updateSearchOptions();
              } catch (error) {
                alert('JSON格式错误，请检查文件内容。');
                console.error('导入失败:', error);
              }
            };
            reader.readAsText(file);
          }
        };

        input.click();
      }

      // 导入工单信息
      function importTickets() {
        // 创建文件输入元素
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';

        input.onchange = function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
              try {
                const tickets = JSON.parse(event.target.result);
                saveTickets(tickets);
                alert(
                  '工单信息导入成功！共导入 ' + tickets.length + ' 条记录。',
                );
                // 更新工单列表
                loadTickets();
              } catch (error) {
                alert('JSON格式错误，请检查文件内容。');
                console.error('导入失败:', error);
              }
            };
            reader.readAsText(file);
          }
        };

        input.click();
      }

      // 导出工单信息
      function exportTickets() {
        try {
          // 获取当前查询表单中的小区名称
          const communitySelect = document.getElementById('searchCommunity');
          const selectedCommunity = communitySelect
            ? communitySelect.value
            : '';

          // 构建文件名前缀
          const communityPrefix = selectedCommunity
            ? `${selectedCommunity}_`
            : '';

          // 获取工单数据
          const tickets = getTickets();
          if (tickets.length === 0) {
            alert('没有工单数据可以导出！');
            return;
          }

          // 过滤工单数据，只导出当前筛选条件下的数据
          let filteredTickets = [...tickets];

          // 应用与loadTickets相同的筛选逻辑
          if (selectedCommunity) {
            filteredTickets = filteredTickets.filter((ticket) => {
              const ticketCommunity = String(ticket.community || '');
              return ticketCommunity === selectedCommunity;
            });
          }

          // 默认过滤：过滤掉已删除、已撤销、已关闭的工单
          filteredTickets = filteredTickets.filter((ticket) => {
            const status = ticket.status || '';
            return !['已删除', '已撤销', '已关闭'].includes(status);
          });

          const dataStr = JSON.stringify(filteredTickets, null, 2);
          const dataBlob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(dataBlob);

          const link = document.createElement('a');
          link.href = url;
          // 使用东八区时间生成文件名
          const localDate = new Date();
          const year = localDate.getFullYear();
          const month = String(localDate.getMonth() + 1).padStart(2, '0');
          const day = String(localDate.getDate()).padStart(2, '0');
          const localDateStr = `${year}-${month}-${day}`;
          link.download = `${communityPrefix}工单数据_${localDateStr}.json`;
          link.click();

          URL.revokeObjectURL(url);

          alert('工单导出成功！共导出 ' + filteredTickets.length + ' 条记录。');
        } catch (error) {
          alert('导出失败：' + error.message);
        }
      }

      // 线下缴费导出
      function exportPayments() {
        try {
          // 获取当前小区选择
          const communitySelect = document.getElementById('communitySelect');
          const selectedCommunity = communitySelect
            ? communitySelect.value
            : '';

          // 从localStorage获取收费记录
          const allPayments =
            JSON.parse(localStorage.getItem('idh_heating_payments')) || [];

          // 根据选中的小区筛选收费记录
          const filteredPayments = selectedCommunity
            ? allPayments.filter(
                (payment) => payment.community === selectedCommunity,
              )
            : allPayments;

          if (filteredPayments.length === 0) {
            alert('没有符合条件的收费记录可以导出！');
            return;
          }

          // 构建文件名前缀
          const communityPrefix = selectedCommunity
            ? `${selectedCommunity}_`
            : '';

          // 将收费记录转换为JSON字符串，带缩进格式
          const jsonData = JSON.stringify(filteredPayments, null, 2);

          // 创建Blob对象
          const blob = new Blob([jsonData], { type: 'application/json' });

          // 创建下载链接
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          // 使用东八区时间生成文件名
          const localDate = new Date();
          const year = localDate.getFullYear();
          const month = String(localDate.getMonth() + 1).padStart(2, '0');
          const day = String(localDate.getDate()).padStart(2, '0');
          const localDateStr = `${year}-${month}-${day}`;
          a.download = `${communityPrefix}收费记录_${localDateStr}.json`;

          // 触发下载
          document.body.appendChild(a);
          a.click();

          // 清理
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          alert(
            '收费记录导出成功！共导出 ' + filteredPayments.length + ' 条记录。',
          );
        } catch (error) {
          alert('导出失败：' + error.message);
        }
      }

      // 线下缴费导入
      function importPayments() {
        try {
          // 创建文件输入元素
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';

          input.onchange = function (e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function (event) {
                try {
                  const payments = JSON.parse(event.target.result);

                  if (!Array.isArray(payments)) {
                    alert('导入失败：文件格式不正确，必须是JSON数组！');
                    return;
                  }

                  // 获取现有收费记录
                  const existingPayments =
                    JSON.parse(localStorage.getItem('idh_heating_payments')) ||
                    [];

                  // 合并收费记录
                  const mergedPayments = [...existingPayments, ...payments];

                  // 保存到localStorage
                  localStorage.setItem(
                    'idh_heating_payments',
                    JSON.stringify(mergedPayments),
                  );

                  alert(
                    '收费记录导入成功！共导入 ' + payments.length + ' 条记录。',
                  );

                  // 更新线下缴费页面
                  if (
                    document.querySelector('.tab-content.active').id ===
                    'cash-tab'
                  ) {
                    renderPaymentsTable();
                    updateStats();
                  }
                } catch (error) {
                  alert('导入失败：' + error.message);
                }
              };
              reader.readAsText(file);
            }
          };
          input.click();
        } catch (error) {
          alert('导入失败：' + error.message);
        }
      }

      // 打开默认小区设置模态框
      function openDefaultCommunityModal() {
        // 获取模态框元素
        const modal = document.getElementById('defaultCommunityModal');
        const select = document.getElementById('defaultCommunitySelect');

        // 获取小区数据
        const users = getUsers();
        const communities = [...new Set(users.map((user) => user.community))];

        // 填充小区选择下拉框
        select.innerHTML = '<option value="">请选择小区</option>';
        communities.forEach((community) => {
          const option = document.createElement('option');
          option.value = community;
          option.textContent = community;
          select.appendChild(option);
        });

        // 设置当前选中的默认小区（如果有）
        const defaultCommunity = localStorage.getItem('idh_default_community');
        if (defaultCommunity) {
          select.value = defaultCommunity;
        }

        // 显示模态框
        modal.style.display = 'flex';
      }

      // 关闭默认小区设置模态框
      function closeDefaultCommunityModal() {
        const modal = document.getElementById('defaultCommunityModal');
        modal.style.display = 'none';
      }

      // 保存默认小区设置
      function saveDefaultCommunity() {
        const select = document.getElementById('defaultCommunitySelect');
        const defaultCommunity = select.value;

        // 保存到localStorage
        localStorage.setItem('idh_default_community', defaultCommunity);

        // 关闭模态框
        closeDefaultCommunityModal();

        // 应用默认小区到所有小区下拉框
        applyDefaultCommunity(defaultCommunity);

        alert('默认小区设置已保存！');
      }

      // 从localStorage加载默认小区
      function loadDefaultCommunity() {
        return localStorage.getItem('idh_default_community') || '';
      }

      // 应用默认小区到所有小区下拉框
      function applyDefaultCommunity(defaultCommunity = '') {
        // 如果未提供默认小区，从localStorage加载
        if (!defaultCommunity) {
          defaultCommunity = loadDefaultCommunity();
        }

        // 应用到所有小区下拉框
        const communitySelectors = [
          'searchCommunity', // 工单查询小区选择
          'community', // 新建工单小区选择
          'paymentCommunity', // 新建收费小区选择
          'cashSearchCommunity', // 线下缴费查询小区选择
          'communitySelect', // 线下缴费小区选择
        ];

        communitySelectors.forEach((selectorId) => {
          const selectElement = document.getElementById(selectorId);
          if (selectElement) {
            // 特殊处理cashSearchCommunity，确保它的选项已经初始化
            if (selectorId === 'cashSearchCommunity') {
              // 确保现金查询小区下拉框有数据
              const users =
                JSON.parse(localStorage.getItem('idh_heating_users')) || [];
              if (users.length > 0 && selectElement.options.length <= 1) {
                // 如果下拉框只有一个"全部"选项，重新初始化它
                const communities = [
                  ...new Set(users.map((user) => user.community)),
                ];
                selectElement.innerHTML = '<option value="">全部</option>';
                communities.forEach((community) => {
                  const option = document.createElement('option');
                  option.value = community;
                  option.textContent = community;
                  selectElement.appendChild(option);
                });
              }
            }

            // 检查选项中是否存在该小区值
            const hasOption = [...selectElement.options].some(
              (option) => option.value === defaultCommunity,
            );
            if (hasOption) {
              selectElement.value = defaultCommunity;
              // 触发change事件，确保相关依赖的下拉框更新
              selectElement.dispatchEvent(new Event('change'));
            }
          }
        });
      }

      // 更新查询下拉框选项
      function updateSearchOptions() {
        const users = getUsers();

        // 更新小区名称下拉框
        const communitySelect = document.getElementById('searchCommunity');
        const communities = [...new Set(users.map((user) => user.community))];
        communitySelect.innerHTML =
          '<option value="">全部</option>' +
          communities
            .map(
              (community) =>
                `<option value="${community}">${community}</option>`,
            )
            .join('');

        // 清空其他下拉框
        resetCascadeSelects();

        // 绑定级联事件
        bindCascadeEvents();

        // 应用默认小区设置
        applyDefaultCommunity();
      }

      // 重置级联下拉框
      function resetCascadeSelects() {
        // 清空楼号下拉框
        const buildingSelect = document.getElementById('searchBuilding');
        buildingSelect.innerHTML = '<option value="">全部</option>';

        // 清空单元下拉框
        const unitSelect = document.getElementById('searchUnit');
        unitSelect.innerHTML = '<option value="">全部</option>';

        // 清空房号下拉框
        const roomSelect = document.getElementById('searchRoom');
        roomSelect.innerHTML = '<option value="">全部</option>';
      }

      // 绑定级联事件
      function bindCascadeEvents() {
        const users = getUsers();

        // 重置业主信息的函数
        function resetOwnerInfo() {
          document.getElementById('searchOwner').value = '';
          document.getElementById('searchPhone').value = '';
        }

        // 小区名称变化事件
        document
          .getElementById('searchCommunity')
          .addEventListener('change', function () {
            const community = this.value;
            const buildingSelect = document.getElementById('searchBuilding');

            // 清空并重置后续下拉框和业主信息
            buildingSelect.innerHTML = '<option value="">全部</option>';
            document.getElementById('searchUnit').innerHTML =
              '<option value="">全部</option>';
            document.getElementById('searchRoom').innerHTML =
              '<option value="">全部</option>';
            resetOwnerInfo();

            if (community) {
              // 过滤该小区的楼号
              const buildings = [
                ...new Set(
                  users
                    .filter((user) => user.community === community)
                    .map((user) => user.building),
                ),
              ];
              buildingSelect.innerHTML += buildings
                .map(
                  (building) =>
                    `<option value="${building}">${building}</option>`,
                )
                .join('');
            }
          });

        // 楼号变化事件
        document
          .getElementById('searchBuilding')
          .addEventListener('change', function () {
            const community = document.getElementById('searchCommunity').value;
            const building = this.value;
            const unitSelect = document.getElementById('searchUnit');

            // 清空并重置后续下拉框和业主信息
            unitSelect.innerHTML = '<option value="">全部</option>';
            document.getElementById('searchRoom').innerHTML =
              '<option value="">全部</option>';
            resetOwnerInfo();

            if (community && building) {
              // 过滤该小区该楼的单元
              const units = [
                ...new Set(
                  users
                    .filter(
                      (user) =>
                        user.community === community &&
                        user.building === building,
                    )
                    .map((user) => user.unit),
                ),
              ];
              unitSelect.innerHTML += units
                .map((unit) => `<option value="${unit}">${unit}</option>`)
                .join('');
            }
          });

        // 单元变化事件
        document
          .getElementById('searchUnit')
          .addEventListener('change', function () {
            const community = document.getElementById('searchCommunity').value;
            const building = document.getElementById('searchBuilding').value;
            const unit = this.value;
            const roomSelect = document.getElementById('searchRoom');

            // 清空房号下拉框和业主信息
            roomSelect.innerHTML = '<option value="">全部</option>';
            resetOwnerInfo();

            if (community && building && unit) {
              // 过滤该小区该楼该单元的房号
              const rooms = [
                ...new Set(
                  users
                    .filter(
                      (user) =>
                        user.community === community &&
                        user.building === building &&
                        user.unit === unit,
                    )
                    .map((user) => user.room),
                ),
              ];
              roomSelect.innerHTML += rooms
                .map((room) => `<option value="${room}">${room}</option>`)
                .join('');
            }
          });

        // 房号变化事件
        document
          .getElementById('searchRoom')
          .addEventListener('change', function () {
            const community = document.getElementById('searchCommunity').value;
            const building = document.getElementById('searchBuilding').value;
            const unit = document.getElementById('searchUnit').value;
            const room = this.value;

            // 重置业主信息
            resetOwnerInfo();

            if (community && building && unit && room) {
              // 根据选择的小区、楼号、单元和房号查找对应的业主信息
              const user = users.find(
                (user) =>
                  user.community === community &&
                  user.building === building &&
                  user.unit === unit &&
                  user.room === room,
              );

              if (user) {
                // 自动填充业主姓名和电话
                document.getElementById('searchOwner').value = user.owner || '';
                document.getElementById('searchPhone').value = user.phone || '';
              }
            }
          });
      }

      // 编辑工单
      function editTicket(ticketId) {
        const tickets = getTickets();
        const ticket = tickets.find((t) => t.id === ticketId);

        if (ticket) {
          // 显示编辑模态框
          document.getElementById('createTicketModal').style.display = 'flex';

          // 修改模态框标题为"编辑工单"
          const modalTitle = document.querySelector('#createTicketModal h4');
          modalTitle.innerHTML = '<i class="fas fa-edit"></i> 编辑工单';

          // 填充表单数据
          document.getElementById('ticketNumber').value = ticket.id;
          document.getElementById('createTime').value = ticket.createTime;

          // 填充用户信息，并设置为不可编辑
          const communitySelect = document.getElementById('community');
          // 确保下拉框中有对应的小区选项
          if (
            ![...communitySelect.options].some(
              (opt) => opt.value === ticket.community,
            )
          ) {
            const option = document.createElement('option');
            option.value = ticket.community;
            option.textContent = ticket.community;
            communitySelect.appendChild(option);
          }
          communitySelect.value = ticket.community;
          communitySelect.disabled = true;

          const buildingSelect = document.getElementById('building');
          // 确保下拉框中有对应的楼号选项
          if (
            ![...buildingSelect.options].some(
              (opt) => opt.value === ticket.building,
            )
          ) {
            const option = document.createElement('option');
            option.value = ticket.building;
            option.textContent = ticket.building;
            buildingSelect.appendChild(option);
          }
          buildingSelect.value = ticket.building;
          buildingSelect.disabled = true;

          const unitSelect = document.getElementById('unit');
          // 确保下拉框中有对应的单元选项
          if (
            ![...unitSelect.options].some((opt) => opt.value === ticket.unit)
          ) {
            const option = document.createElement('option');
            option.value = ticket.unit;
            option.textContent = ticket.unit;
            unitSelect.appendChild(option);
          }
          unitSelect.value = ticket.unit;
          unitSelect.disabled = true;

          const roomSelect = document.getElementById('room');
          // 确保下拉框中有对应的房号选项
          if (
            ![...roomSelect.options].some((opt) => opt.value === ticket.room)
          ) {
            const option = document.createElement('option');
            option.value = ticket.room;
            option.textContent = ticket.room;
            roomSelect.appendChild(option);
          }
          roomSelect.value = ticket.room;
          roomSelect.disabled = true;

          // 从小区用户信息中获取最新的用户数据
          const users = getUsers();
          const user = users.find(
            (u) =>
              u.community === ticket.community &&
              u.building === ticket.building &&
              u.unit === ticket.unit &&
              u.room === ticket.room,
          );

          // 使用最新的用户信息，如果没有找到则使用工单中存储的信息
          const areaInput = document.getElementById('area');
          areaInput.value = user ? user.area : ticket.area || '';
          areaInput.disabled = true;

          document.getElementById('owner').value = user
            ? user.owner
            : ticket.owner;
          document.getElementById('phone').value = user
            ? user.phone
            : ticket.phone;

          // 填充工单信息
          document.getElementById('creator').value = ticket.creator || '';
          document.getElementById('processor').value = ticket.processor || '';
          document.getElementById('ticketType').value =
            ticket.ticketType || '咨询';
          document.getElementById('ticketStatus').value = ticket.status;
          document.getElementById('description').value = ticket.description;

          // 如果有用户信息，自动填充账单
          if (user && user.bills) {
            fillBillInfo(user.bills);
          }
        }
      }

      // 查看工单详情
      function viewTicketDetail(ticketId) {
        const tickets = getTickets();
        const ticket = tickets.find((t) => t.id === ticketId);

        if (ticket) {
          // 显示编辑模态框（复用）
          const modal = document.getElementById('createTicketModal');
          modal.style.display = 'flex';

          // 修改模态框标题为"工单详情"
          const modalTitle = document.querySelector('#createTicketModal h4');
          modalTitle.innerHTML = '<i class="fas fa-info-circle"></i> 工单详情';

          // 填充表单数据
          document.getElementById('ticketNumber').value = ticket.id;
          document.getElementById('createTime').value = ticket.createTime;

          // 填充用户信息，并设置为不可编辑
          const communitySelect = document.getElementById('community');
          // 确保下拉框中有对应的小区选项
          if (
            ![...communitySelect.options].some(
              (opt) => opt.value === ticket.community,
            )
          ) {
            const option = document.createElement('option');
            option.value = ticket.community;
            option.textContent = ticket.community;
            communitySelect.appendChild(option);
          }
          communitySelect.value = ticket.community;
          communitySelect.disabled = true;

          const buildingSelect = document.getElementById('building');
          // 确保下拉框中有对应的楼号选项
          if (
            ![...buildingSelect.options].some(
              (opt) => opt.value === ticket.building,
            )
          ) {
            const option = document.createElement('option');
            option.value = ticket.building;
            option.textContent = ticket.building;
            buildingSelect.appendChild(option);
          }
          buildingSelect.value = ticket.building;
          buildingSelect.disabled = true;

          const unitSelect = document.getElementById('unit');
          // 确保下拉框中有对应的单元选项
          if (
            ![...unitSelect.options].some((opt) => opt.value === ticket.unit)
          ) {
            const option = document.createElement('option');
            option.value = ticket.unit;
            option.textContent = ticket.unit;
            unitSelect.appendChild(option);
          }
          unitSelect.value = ticket.unit;
          unitSelect.disabled = true;

          const roomSelect = document.getElementById('room');
          // 确保下拉框中有对应的房号选项
          if (
            ![...roomSelect.options].some((opt) => opt.value === ticket.room)
          ) {
            const option = document.createElement('option');
            option.value = ticket.room;
            option.textContent = ticket.room;
            roomSelect.appendChild(option);
          }
          roomSelect.value = ticket.room;
          roomSelect.disabled = true;

          // 从小区用户信息中获取最新的用户数据
          const users = getUsers();
          const user = users.find(
            (u) =>
              u.community === ticket.community &&
              u.building === ticket.building &&
              u.unit === ticket.unit &&
              u.room === ticket.room,
          );

          // 使用最新的用户信息，如果没有找到则使用工单中存储的信息
          const areaInput = document.getElementById('area');
          areaInput.value = user ? user.area : ticket.area || '';
          areaInput.disabled = true;

          document.getElementById('owner').value = user
            ? user.owner
            : ticket.owner;
          document.getElementById('phone').value = user
            ? user.phone
            : ticket.phone;

          // 填充工单信息
          document.getElementById('creator').value = ticket.creator || '';
          document.getElementById('processor').value = ticket.processor || '';
          document.getElementById('ticketType').value =
            ticket.ticketType || '咨询';
          document.getElementById('ticketStatus').value = ticket.status;
          document.getElementById('description').value = ticket.description;

          // 如果有用户信息，自动填充账单
          if (user && user.bills) {
            fillBillInfo(user.bills);
          }

          // 设置所有工单信息字段为不可编辑
          document.getElementById('creator').disabled = true;
          document.getElementById('processor').disabled = true;
          document.getElementById('ticketType').disabled = true;
          document.getElementById('ticketStatus').disabled = true;
          document.getElementById('description').disabled = true;
          document.getElementById('owner').disabled = true;
          document.getElementById('phone').disabled = true;
          document.getElementById('paymentStatus').disabled = true;

          // 设置所有账单信息字段为不可编辑
          setTimeout(() => {
            // 等待账单信息加载完成
            const billsContainer = document.querySelector('.bills-container');
            if (billsContainer) {
              // 设置所有select元素为不可编辑
              const selects = billsContainer.querySelectorAll('select');
              selects.forEach((select) => {
                select.disabled = true;
              });

              // 设置所有input元素为不可编辑
              const inputs = billsContainer.querySelectorAll('input');
              inputs.forEach((input) => {
                input.disabled = true;
              });
            }
          }, 100);

          // 禁用保存按钮，只保留取消按钮
          const saveBtn = document.querySelector(
            '#createTicketModal button[type="submit"]',
          );
          saveBtn.disabled = true;
          saveBtn.style.display = 'none';

          // 显示取消按钮，并修改为蓝色关闭按钮（仅工单详情模式）
          const cancelBtn = document.getElementById('cancelTicketBtn');
          cancelBtn.style.display = 'inline-block';
          // 修改按钮样式为蓝色
          cancelBtn.className = 'btn btn-danger';
          // 修改按钮文本为关闭
          cancelBtn.textContent = '关闭';

          // 重置表单时恢复字段可编辑状态
          const resetForm = () => {
            // 设置字段为可编辑
            document.getElementById('community').disabled = false;
            document.getElementById('building').disabled = false;
            document.getElementById('unit').disabled = false;
            document.getElementById('room').disabled = false;
            document.getElementById('area').disabled = false;
            document.getElementById('creator').disabled = false;
            document.getElementById('processor').disabled = false;
            document.getElementById('ticketType').disabled = false;
            document.getElementById('ticketStatus').disabled = false;
            document.getElementById('description').disabled = false;
            document.getElementById('owner').disabled = false;
            document.getElementById('phone').disabled = false;
            document.getElementById('paymentStatus').disabled = false;

            // 恢复保存按钮
            saveBtn.disabled = false;
            saveBtn.style.display = 'inline-block';

            // 恢复取消按钮的原始状态（红色"取消"按钮）
            cancelBtn.className = 'btn btn-danger';
            cancelBtn.textContent = '取消';
          };

          // 绑定取消按钮事件，恢复表单状态
          cancelBtn.addEventListener('click', resetForm);

          // 绑定模态框关闭事件，恢复表单状态
          const closeBtn = document.querySelector('#createTicketModal .close');
          closeBtn.addEventListener('click', resetForm);
        }
      }
      // 线下缴费功能 - 开始
      document.addEventListener('DOMContentLoaded', function () {
        // 初始化变量
        let payments =
          JSON.parse(localStorage.getItem('idh_heating_payments')) || [];
        const paymentForm = document.getElementById('paymentForm');
        const paymentsTableBody = document.getElementById('paymentsTableBody');
        const noDataMessage = document.getElementById('noDataMessage');
        const searchInput = document.getElementById('searchInput');
        const filterStatus = document.getElementById('filterStatus');
        const communitySelect = document.getElementById('communitySelect');

        // 从localStorage读取小区用户信息
        let users = JSON.parse(localStorage.getItem('idh_heating_users')) || [];

        // 获取当前登录用户信息
        const currentUser = sessionStorage.getItem('currentUser');
        const username = currentUser
          ? JSON.parse(currentUser).username
          : '系统管理员';

        // 设置默认日期为今天
        if (document.getElementById('paymentDate')) {
          document.getElementById('paymentDate').valueAsDate = new Date();
        }

        // 设置创建人和办理人为当前登录用户
        if (document.getElementById('paymentCreator')) {
          document.getElementById('paymentCreator').value = username;
        }
        if (document.getElementById('paymentProcessor')) {
          document.getElementById('paymentProcessor').value = username;
        }

        // 获取表单元素
        const heatingAreaInput = document.getElementById('heatingArea');
        const unitPriceInput = document.getElementById('unitPrice');
        const actualAmountInput = document.getElementById('actualAmount');
        const changeAmountInput = document.getElementById('changeAmount');

        // 实时计算零钱
        function calculateChange() {
          if (
            !heatingAreaInput ||
            !unitPriceInput ||
            !actualAmountInput ||
            !changeAmountInput
          )
            return;

          const heatingArea = parseFloat(heatingAreaInput.value) || 0;
          const unitPrice = parseFloat(unitPriceInput.value) || 0;
          const actualAmount = parseFloat(actualAmountInput.value) || 0;
          const totalAmount = heatingArea * unitPrice;

          // 计算零钱：实收金额 - 应缴金额
          const change = actualAmount - totalAmount;
          changeAmountInput.value = change >= 0 ? change.toFixed(2) : '0.00';
        }

        // 为相关输入框添加事件监听器，实时计算零钱
        if (heatingAreaInput) {
          heatingAreaInput.addEventListener('input', calculateChange);
        }
        if (unitPriceInput) {
          unitPriceInput.addEventListener('input', calculateChange);
        }
        if (actualAmountInput) {
          actualAmountInput.addEventListener('input', calculateChange);
        }

        // 初始化小区选择下拉菜单
        function initCommunitySelect() {
          if (!communitySelect) return;

          // 获取所有小区名称
          const communities = [...new Set(users.map((user) => user.community))];

          // 清空下拉菜单，保留第一个选项
          communitySelect.innerHTML = '<option value="">请选择小区</option>';

          // 添加小区选项
          communities.forEach((community) => {
            const option = document.createElement('option');
            option.value = community;
            option.textContent = community;
            communitySelect.appendChild(option);
          });

          // 应用默认小区设置
          applyDefaultCommunity();
        }

        // 重置支付表单状态 - 暴露到全局作用域
        window.resetPaymentForm = function () {
          const modal = document.getElementById('createPaymentModal');
          const modalTitle = modal.querySelector('.modal-header h4');
          const paymentForm = document.getElementById('paymentCreateForm');

          // 恢复窗口标题为"新建收费"
          modalTitle.innerHTML = '<i class="fas fa-plus-circle"></i> 新建收费';

          // 重置表单
          paymentForm.reset();

          // 隐藏二维码
          document.getElementById('paymentQrCodeSection').style.display =
            'none';

          // 设置所有字段为可编辑
          const formControls = paymentForm.querySelectorAll('.form-control');
          formControls.forEach((control) => {
            control.readOnly = false;
            control.disabled = false;
          });

          // 恢复保存和取消按钮
          const saveButton = document.querySelector(
            '#createPaymentModal button[type="submit"]',
          );
          const cancelButton = document.getElementById('cancelPaymentBtn');
          if (saveButton) saveButton.style.display = '';
          if (cancelButton) cancelButton.textContent = '取消';

          // 重置编辑标志
          const editFlag = document.getElementById('editPaymentFlag');
          if (editFlag) editFlag.value = 'false';

          // 清空账单信息
          const billsContainer = document.getElementById('paymentBillRow');
          if (billsContainer) {
            billsContainer.innerHTML = '';
          }
        };

        // 初始化查询表单
        function initSearchForm() {
          // 只处理当前标签页的查询表单
          const currentTab = document.querySelector('.tab-content.active').id;
          if (currentTab !== 'cash-tab') return;

          // 重新从localStorage读取小区用户信息，确保使用最新数据
          users = JSON.parse(localStorage.getItem('idh_heating_users')) || [];

          // 初始化小区名称选择
          const searchCommunity = document.getElementById(
            'cashSearchCommunity',
          );
          if (searchCommunity) {
            // 检查users数组是否为空
            if (users.length === 0) {
              searchCommunity.innerHTML =
                '<option value="">全部</option><option value="">无数据</option>';
            } else {
              const communities = [
                ...new Set(users.map((user) => user.community)),
              ];
              searchCommunity.innerHTML = '<option value="">全部</option>';
              communities.forEach((community) => {
                const option = document.createElement('option');
                option.value = community;
                option.textContent = community;
                searchCommunity.appendChild(option);
              });
            }
          }

          // 初始化供暖季选择
          const searchHeatingSeason = document.getElementById(
            'cashSearchHeatingSeason',
          );
          if (searchHeatingSeason) {
            // 从缴费记录中提取所有供暖季
            const heatingSeasons = [
              ...new Set(
                payments
                  .map((p) => p.heatingSeason || '')
                  .filter((season) => season),
              ),
            ];
            // 清空现有选项
            searchHeatingSeason.innerHTML = '<option value="">全部</option>';
            heatingSeasons.forEach((season) => {
              const option = document.createElement('option');
              option.value = season;
              option.textContent = season;
              searchHeatingSeason.appendChild(option);
            });
          }

          // 绑定查询表单的级联事件
          bindSearchFormCascadeEvents();

          // 应用默认小区设置
          applyDefaultCommunity();
        }

        // 绑定查询表单的级联事件
        function bindSearchFormCascadeEvents() {
          // 只处理当前标签页的查询表单
          const currentTab = document.querySelector('.tab-content.active').id;
          if (currentTab !== 'cash-tab') return;

          // 重新从localStorage读取小区用户信息，确保使用最新数据
          users = JSON.parse(localStorage.getItem('idh_heating_users')) || [];

          // 获取表单元素
          const searchCommunity = document.getElementById(
            'cashSearchCommunity',
          );
          const searchBuilding = document.getElementById('cashSearchBuilding');
          const searchUnit = document.getElementById('cashSearchUnit');
          const searchRoom = document.getElementById('cashSearchRoom');
          const searchHouseholder = document.getElementById(
            'cashSearchHouseholder',
          );
          const searchPhone = document.getElementById('cashSearchPhone');

          if (
            !searchCommunity ||
            !searchBuilding ||
            !searchUnit ||
            !searchRoom ||
            !searchHouseholder ||
            !searchPhone
          )
            return;

          // 先移除现有的事件监听器，避免重复绑定
          // 这里需要先移除，因为我们可能多次调用这个函数
          // 由于无法直接获取已绑定的事件监听器，我们使用一种替代方案：
          // 先克隆元素，然后替换原元素，这样会移除所有事件监听器
          const newSearchCommunity = searchCommunity.cloneNode(true);
          const newSearchBuilding = searchBuilding.cloneNode(true);
          const newSearchUnit = searchUnit.cloneNode(true);
          const newSearchRoom = searchRoom.cloneNode(true);

          // 替换原元素
          searchCommunity.parentNode.replaceChild(
            newSearchCommunity,
            searchCommunity,
          );
          searchBuilding.parentNode.replaceChild(
            newSearchBuilding,
            searchBuilding,
          );
          searchUnit.parentNode.replaceChild(newSearchUnit, searchUnit);
          searchRoom.parentNode.replaceChild(newSearchRoom, searchRoom);

          // 更新引用
          const sc = newSearchCommunity;
          const sb = newSearchBuilding;
          const su = newSearchUnit;
          const sr = newSearchRoom;

          // 重置业主信息的函数
          function resetOwnerInfo() {
            searchHouseholder.value = '';
            searchPhone.value = '';
          }

          // 小区选择变化事件
          sc.addEventListener('change', function () {
            const community = this.value;

            // 重置后续下拉框和业主信息
            sb.innerHTML = '<option value="">全部</option>';
            su.innerHTML = '<option value="">全部</option>';
            sr.innerHTML = '<option value="">全部</option>';
            resetOwnerInfo();

            if (community) {
              // 获取该小区的所有楼号
              const buildings = [
                ...new Set(
                  users
                    .filter((user) => user.community === community)
                    .map((user) => user.building),
                ),
              ];
              buildings.forEach((building) => {
                const option = document.createElement('option');
                option.value = building;
                option.textContent = building;
                sb.appendChild(option);
              });
            }
          });

          // 楼号选择变化事件
          sb.addEventListener('change', function () {
            const community = sc.value;
            const building = this.value;

            // 重置后续下拉框和业主信息
            su.innerHTML = '<option value="">全部</option>';
            sr.innerHTML = '<option value="">全部</option>';
            resetOwnerInfo();

            if (community && building) {
              // 获取该小区该楼的所有单元
              const units = [
                ...new Set(
                  users
                    .filter(
                      (user) =>
                        user.community === community &&
                        user.building === building,
                    )
                    .map((user) => user.unit),
                ),
              ];
              units.forEach((unit) => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit;
                su.appendChild(option);
              });
            }
          });

          // 单元选择变化事件
          su.addEventListener('change', function () {
            const community = sc.value;
            const building = sb.value;
            const unit = this.value;

            // 重置后续下拉框和业主信息
            sr.innerHTML = '<option value="">全部</option>';
            resetOwnerInfo();

            if (community && building && unit) {
              // 获取该小区该楼该单元的所有房号
              const rooms = [
                ...new Set(
                  users
                    .filter(
                      (user) =>
                        user.community === community &&
                        user.building === building &&
                        user.unit === unit,
                    )
                    .map((user) => user.room),
                ),
              ];
              rooms.forEach((room) => {
                const option = document.createElement('option');
                option.value = room;
                option.textContent = room;
                sr.appendChild(option);
              });
            }
          });

          // 房号选择变化事件
          sr.addEventListener('change', function () {
            const community = sc.value;
            const building = sb.value;
            const unit = su.value;
            const room = this.value;

            // 重置业主信息
            resetOwnerInfo();

            if (community && building && unit && room) {
              // 根据选择的小区、楼号、单元和房号查找对应的业主信息
              const user = users.find(
                (user) =>
                  user.community === community &&
                  user.building === building &&
                  user.unit === unit &&
                  user.room === room,
              );

              if (user) {
                // 自动填充业主姓名和电话
                searchHouseholder.value = user.owner || '';
                searchPhone.value = user.phone || '';
              }
            }
          });
        }

        // 根据选择的小区统计总住户数
        function getTotalHouseholdsByCommunity(community) {
          if (!community || community === '全部' || community === '未设置') {
            return users.length;
          }
          return users.filter((user) => user.community === community).length;
        }

        // 根据选择的小区获取零钱余额
        function getCommunityChange(community) {
          if (!community || community === '全部' || community === '未设置') {
            // 如果没有指定小区或小区为"全部"或"未设置"，小区配置中的零钱默认为0
            return 0;
          }
          // 从独立的存储中获取指定小区的初始零钱
          const communityChange =
            JSON.parse(localStorage.getItem('idh_heating_community_change')) ||
            {};
          return parseFloat(communityChange[community]) || 0;
        }

        // 更新小区零钱显示
        function updateCommunityChangeDisplay() {
          const selectedCommunity = communitySelect.value;
          const change = getCommunityChange(selectedCommunity);
          const changeDisplay = document.getElementById('communityChange');
          if (changeDisplay) {
            changeDisplay.textContent = `¥${change.toFixed(2)}`;
          }
        }

        // 根据选择的小区获取单价
        function getCommunityUnitPrice(community) {
          if (!community) {
            return 5.8; // 默认单价
          }
          // 从独立的存储中获取小区单价
          const communityUnitPrices =
            JSON.parse(
              localStorage.getItem('idh_heating_community_unit_prices'),
            ) || {};
          return parseFloat(communityUnitPrices[community]) || 5.8;
        }

        // 更新小区单价显示
        function updateCommunityUnitPriceDisplay() {
          const selectedCommunity = communitySelect.value;
          const unitPrice = getCommunityUnitPrice(selectedCommunity);
          const unitPriceDisplay =
            document.getElementById('communityUnitPrice');
          if (unitPriceDisplay) {
            unitPriceDisplay.textContent = `¥${unitPrice.toFixed(2)}`;
          }
        }

        // 添加标签页切换事件监听器
        const navbarLinks = document.querySelectorAll('.navbar a[data-tab]');
        navbarLinks.forEach((link) => {
          link.addEventListener('click', function () {
            setTimeout(() => {
              const currentTab = document.querySelector(
                '.tab-content.active',
              ).id;
              if (currentTab === 'cash-tab') {
                initSearchForm();
              }
            }, 0);
          });
        });

        // 小区选择变化事件
        if (communitySelect) {
          communitySelect.addEventListener('change', function () {
            updateStats();
            updateCommunityChangeDisplay();
            updateCommunityUnitPriceDisplay();
          });
        }

        // 搜索按钮事件
        const searchBtn = document.getElementById('searchBtn');
        const cashSearchBtn = document.getElementById('cashSearchBtn');
        if (searchBtn) {
          searchBtn.addEventListener('click', renderPaymentsTable);
        }
        if (cashSearchBtn) {
          cashSearchBtn.addEventListener('click', renderPaymentsTable);
        }

        // 初始化页面
        initCommunitySelect();
        initSearchForm();
        updateStats();
        updateCommunityChangeDisplay();
        updateCommunityUnitPriceDisplay();

        // 重置搜索表单事件
        const resetSearchBtn = document.getElementById('resetSearchBtn');
        if (resetSearchBtn) {
          resetSearchBtn.addEventListener('click', function () {
            // 重置所有查询表单元素
            const searchElements = document.querySelectorAll(
              '.advanced-search input, .advanced-search select',
            );
            searchElements.forEach((element) => {
              if (element.type === 'checkbox' || element.type === 'radio') {
                element.checked = false;
              } else {
                element.value =
                  element.id === 'searchPaymentStatus' ? 'all' : '';
              }
            });
            renderPaymentsTable();
          });
        }

        // 初始化零钱模态框事件处理
        const changeModal = document.getElementById('changeModal');
        const initChangeModalBtn =
          document.getElementById('initChangeModalBtn');
        const closeChangeModalBtn = document.querySelector(
          '#changeModal .close',
        );
        const cancelChangeBtn = document.getElementById('cancelChangeBtn');
        const saveChangeBtn = document.getElementById('saveChangeBtn');

        // 打开初始化零钱模态框
        if (initChangeModalBtn) {
          initChangeModalBtn.addEventListener('click', function () {
            const selectedCommunity = communitySelect.value;
            if (!selectedCommunity) {
              alert('请先选择一个小区！');
              return;
            }
            if (changeModal) {
              changeModal.style.display = 'flex';

              // 自动加载当前小区的零钱余额
              const changeAmountInput =
                document.getElementById('changeAmountInput');
              const currentChange = getCommunityChange(selectedCommunity);
              if (changeAmountInput) {
                changeAmountInput.value = currentChange.toFixed(2);
              }
            }
          });
        }

        // 关闭初始化零钱模态框
        function closeChangeModal() {
          if (changeModal) {
            changeModal.style.display = 'none';
          }
        }

        // 点击模态框外部关闭
        window.addEventListener('click', function (e) {
          if (changeModal && e.target === changeModal) {
            closeChangeModal();
          }
        });

        if (closeChangeModalBtn) {
          closeChangeModalBtn.addEventListener('click', closeChangeModal);
        }

        if (cancelChangeBtn) {
          cancelChangeBtn.addEventListener('click', closeChangeModal);
        }

        // 保存初始零钱
        if (saveChangeBtn) {
          saveChangeBtn.addEventListener('click', function () {
            const selectedCommunity = communitySelect.value;
            if (!selectedCommunity) {
              alert('请先选择一个小区！');
              return;
            }

            const changeAmountInput =
              document.getElementById('changeAmountInput');
            const changeAmount = parseFloat(changeAmountInput.value) || 0;

            // 从独立的存储中获取初始零钱
            const communityChange =
              JSON.parse(
                localStorage.getItem('idh_heating_community_change'),
              ) || {};

            // 保存初始零钱到独立的存储
            communityChange[selectedCommunity] = changeAmount;
            localStorage.setItem(
              'idh_heating_community_change',
              JSON.stringify(communityChange),
            );

            // 如果有旧的初始零钱记录，从payments数组中移除
            const oldChangeIndex = payments.findIndex(
              (p) =>
                p.community === selectedCommunity &&
                p.status === 'change' &&
                p.remarks === '初始零钱记录',
            );

            if (oldChangeIndex >= 0) {
              payments.splice(oldChangeIndex, 1);
              localStorage.setItem(
                'idh_heating_payments',
                JSON.stringify(payments),
              );
            }

            updateCommunityChangeDisplay();
            updateStats();
            renderPaymentsTable();

            closeChangeModal();
            alert('初始零钱设置成功！');
          });
        }

        // 初始化小区单价模态框事件处理
        const unitPriceModal = document.getElementById('unitPriceModal');
        const initUnitPriceModalBtn = document.getElementById(
          'initUnitPriceModalBtn',
        );
        const closeUnitPriceModalBtn = document.querySelector(
          '#unitPriceModal .close',
        );
        const cancelUnitPriceBtn =
          document.getElementById('cancelUnitPriceBtn');
        const saveUnitPriceBtn = document.getElementById('saveUnitPriceBtn');

        // 打开初始化小区单价模态框
        if (initUnitPriceModalBtn) {
          initUnitPriceModalBtn.addEventListener('click', function () {
            const selectedCommunity = communitySelect.value;
            if (!selectedCommunity) {
              alert('请先选择一个小区！');
              return;
            }
            if (unitPriceModal) {
              unitPriceModal.style.display = 'flex';
              // 显示当前小区的单价
              const unitPriceAmountInput = document.getElementById(
                'unitPriceAmountInput',
              );
              if (unitPriceAmountInput) {
                unitPriceAmountInput.value =
                  getCommunityUnitPrice(selectedCommunity).toFixed(2);
              }
            }
          });
        }

        // 关闭初始化小区单价模态框
        function closeUnitPriceModal() {
          if (unitPriceModal) {
            unitPriceModal.style.display = 'none';
          }
        }

        // 点击模态框外部关闭
        window.addEventListener('click', function (e) {
          if (unitPriceModal && e.target === unitPriceModal) {
            closeUnitPriceModal();
          }
        });

        if (closeUnitPriceModalBtn) {
          closeUnitPriceModalBtn.addEventListener('click', closeUnitPriceModal);
        }

        if (cancelUnitPriceBtn) {
          cancelUnitPriceBtn.addEventListener('click', closeUnitPriceModal);
        }

        // 保存小区单价
        if (saveUnitPriceBtn) {
          saveUnitPriceBtn.addEventListener('click', function () {
            const selectedCommunity = communitySelect.value;
            if (!selectedCommunity) {
              alert('请先选择一个小区！');
              return;
            }

            const unitPriceAmountInput = document.getElementById(
              'unitPriceAmountInput',
            );
            const unitPriceAmount = parseFloat(unitPriceAmountInput.value) || 0;

            // 从独立的存储中获取小区单价
            const communityUnitPrices =
              JSON.parse(
                localStorage.getItem('idh_heating_community_unit_prices'),
              ) || {};

            // 保存小区单价到独立的存储
            communityUnitPrices[selectedCommunity] = unitPriceAmount;
            localStorage.setItem(
              'idh_heating_community_unit_prices',
              JSON.stringify(communityUnitPrices),
            );

            updateCommunityUnitPriceDisplay();
            updateStats();
            renderPaymentsTable();

            closeUnitPriceModal();
            alert('小区单价设置成功！');
          });
        }

        // 表单提交事件
        if (paymentForm) {
          paymentForm.addEventListener('submit', function (e) {
            e.preventDefault();

            // 获取表单数据
            const houseNumber = document.getElementById('houseNumber').value;
            const householder = document.getElementById('householder').value;
            const heatingArea = parseFloat(
              document.getElementById('heatingArea').value,
            );
            const unitPrice = parseFloat(
              document.getElementById('unitPrice').value,
            );
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentMethod =
              document.getElementById('paymentMethod').value;
            const remarks = document.getElementById('remarks').value;

            // 计算总金额
            const totalAmount = heatingArea * unitPrice;

            // 获取实收金额和零钱
            const actualAmount =
              parseFloat(document.getElementById('actualAmount').value) ||
              totalAmount;
            const changeAmount =
              parseFloat(document.getElementById('changeAmount').value) || 0;

            // 创建收费记录对象
            const paymentRecord = {
              id: Date.now(), // 使用时间戳作为唯一ID
              community: communitySelect.value, // 添加小区字段
              houseNumber,
              householder,
              heatingArea,
              unitPrice,
              totalAmount,
              actualAmount,
              changeAmount,
              paymentDate,
              paymentMethod,
              remarks,
              status: 'paid',
              createdAt: new Date().toISOString(),
            };

            // 添加到数组并保存到本地存储
            payments.push(paymentRecord);
            localStorage.setItem(
              'idh_heating_payments',
              JSON.stringify(payments),
            );

            // 更新页面
            updateStats();
            renderPaymentsTable();

            // 重置表单
            paymentForm.reset();
            if (document.getElementById('paymentDate')) {
              document.getElementById('paymentDate').valueAsDate = new Date();
            }
            if (document.getElementById('unitPrice')) {
              document.getElementById('unitPrice').value = '25.00';
            }

            // 显示成功消息
            alert('收费记录保存成功！');
          });
        }

        // 重置表单按钮
        if (document.getElementById('resetForm')) {
          document
            .getElementById('resetForm')
            .addEventListener('click', function () {
              if (paymentForm) {
                paymentForm.reset();
              }
              if (document.getElementById('paymentDate')) {
                document.getElementById('paymentDate').valueAsDate = new Date();
              }
              if (document.getElementById('unitPrice')) {
                document.getElementById('unitPrice').value = '25.00';
              }
              if (document.getElementById('actualAmount')) {
                document.getElementById('actualAmount').value = '';
              }
              if (document.getElementById('changeAmount')) {
                document.getElementById('changeAmount').value = '';
              }

              // 设置创建人和办理人为当前登录用户
              const currentUser = sessionStorage.getItem('currentUser');
              const username = currentUser
                ? JSON.parse(currentUser).username
                : '系统管理员';
              if (document.getElementById('paymentCreator')) {
                document.getElementById('paymentCreator').value = username;
              }
              if (document.getElementById('paymentProcessor')) {
                document.getElementById('paymentProcessor').value = username;
              }
            });
        }

        // 搜索功能
        if (searchInput) {
          searchInput.addEventListener('input', renderPaymentsTable);
        }
        if (filterStatus) {
          filterStatus.addEventListener('change', renderPaymentsTable);
        }

        // 导出数据
        if (document.getElementById('exportData')) {
          document
            .getElementById('exportData')
            .addEventListener('click', function () {
              const dataStr = JSON.stringify(payments, null, 2);
              const dataBlob = new Blob([dataStr], {
                type: 'application/json',
              });

              const downloadLink = document.createElement('a');
              downloadLink.href = URL.createObjectURL(dataBlob);
              downloadLink.download = `供暖费收费记录_${new Date().toISOString().slice(0, 10)}.json`;
              downloadLink.click();
            });
        }

        // 导入数据
        if (document.getElementById('importData')) {
          document
            .getElementById('importData')
            .addEventListener('click', function () {
              document.getElementById('fileInput').click();
            });
        }

        if (document.getElementById('fileInput')) {
          document
            .getElementById('fileInput')
            .addEventListener('change', function (e) {
              const file = e.target.files[0];
              if (!file) return;

              const reader = new FileReader();
              reader.onload = function (event) {
                try {
                  const importedData = JSON.parse(event.target.result);

                  if (
                    confirm(
                      `将导入 ${importedData.length} 条记录。是否合并到现有数据？`,
                    )
                  ) {
                    // 合并数据，避免重复ID
                    const existingIds = payments.map((p) => p.id);
                    const newRecords = importedData.filter(
                      (item) => !existingIds.includes(item.id),
                    );

                    payments = [...payments, ...newRecords];
                    localStorage.setItem(
                      'idh_heating_payments',
                      JSON.stringify(payments),
                    );

                    updateStats();
                    renderPaymentsTable();

                    alert(`成功导入 ${newRecords.length} 条新记录！`);
                  }
                } catch (error) {
                  alert('导入失败：文件格式不正确');
                }
              };
              reader.readAsText(file);

              // 重置文件输入，允许重复导入同一文件
              e.target.value = '';
            });
        }

        // 清空所有数据
        if (document.getElementById('clearAllData')) {
          document
            .getElementById('clearAllData')
            .addEventListener('click', function () {
              if (confirm('确定要清空所有收费记录吗？此操作不可恢复！')) {
                payments = [];
                localStorage.setItem(
                  'idh_heating_payments',
                  JSON.stringify(payments),
                );
                updateStats();
                renderPaymentsTable();
                alert('所有数据已清空！');
              }
            });
        }

        // 更新统计数据
        function updateStats() {
          // 每次都从localStorage重新读取数据，确保数据是最新的
          payments =
            JSON.parse(localStorage.getItem('idh_heating_payments')) || [];
          users = JSON.parse(localStorage.getItem('idh_heating_users')) || [];

          // 优先使用默认小区，如果没有默认小区则显示"未设置"并统计全部小区数据
          const defaultCommunity =
            localStorage.getItem('idh_default_community') || '未设置';
          const totalHouseholds =
            getTotalHouseholdsByCommunity(defaultCommunity);

          // 获取今天的日期（格式：YYYY-MM-DD）
          const today = new Date().toISOString().split('T')[0];

          // 根据默认小区筛选缴费记录
          let filteredPayments = payments;
          if (
            defaultCommunity &&
            defaultCommunity !== '全部' &&
            defaultCommunity !== '未设置'
          ) {
            filteredPayments = payments.filter(
              (p) => p.community === defaultCommunity,
            );
          }

          // 筛选出正常缴费记录
          const normalPayments = filteredPayments.filter(
            (p) => p.status !== 'change',
          );

          // 计算已缴费数、收费总额
          const totalPaid = normalPayments.filter(
            (p) => p.status === 'paid',
          ).length;
          const totalAmount = normalPayments.reduce(
            (sum, p) => sum + parseFloat(p.paid || 0),
            0,
          );

          // 计算正常缴费记录的零钱总和
          const paymentsChange = normalPayments.reduce(
            (sum, p) => sum + parseFloat(p.change || 0),
            0,
          );

          // 计算零钱总额
          let totalChange = 0;
          if (
            defaultCommunity &&
            defaultCommunity !== '全部' &&
            defaultCommunity !== '未设置'
          ) {
            // 如果有默认小区，获取该小区的初始零钱
            const communityChange =
              JSON.parse(
                localStorage.getItem('idh_heating_community_change'),
              ) || {};
            totalChange = parseFloat(communityChange[defaultCommunity]) || 0;
          } else {
            // 如果没有默认小区，计算所有小区的零钱之和
            const communityChange =
              JSON.parse(
                localStorage.getItem('idh_heating_community_change'),
              ) || {};
            totalChange = Object.values(communityChange).reduce(
              (sum, change) => sum + parseFloat(change || 0),
              0,
            );
          }

          // 计算今日缴费数和今日收费总额
          const todayPayments = normalPayments.filter(
            (p) => p.paymentDate === today && p.status === 'paid',
          );
          const todayPaid = todayPayments.length;
          const todayAmount = todayPayments.reduce(
            (sum, p) => sum + parseFloat(p.paid || 0),
            0,
          );

          // 更新当前小区显示
          if (document.getElementById('currentCommunity')) {
            document.getElementById('currentCommunity').textContent =
              defaultCommunity;
          }

          // 更新页面显示
          if (document.getElementById('totalHouseholds')) {
            document.getElementById('totalHouseholds').textContent =
              totalHouseholds;
          }
          if (document.getElementById('totalPaid')) {
            document.getElementById('totalPaid').textContent = totalPaid;
          }
          if (document.getElementById('totalAmount')) {
            document.getElementById('totalAmount').textContent =
              `¥${totalAmount.toFixed(2)}`;
          }
          if (document.getElementById('changeAmount')) {
            document.getElementById('changeAmount').textContent =
              `¥${totalChange.toFixed(2)}`;
          }
          if (document.getElementById('todayPaid')) {
            document.getElementById('todayPaid').textContent = todayPaid;
          }
          if (document.getElementById('todayAmount')) {
            document.getElementById('todayAmount').textContent =
              `¥${todayAmount.toFixed(2)}`;
          }
        }

        // 暴露到全局作用域
        window.updateStats = updateStats;

        // 收费记录分页状态变量
        let currentPaymentPage = 1;
        let paymentPageSize = 10;
        let totalPaymentPages = 1;
        let totalPaymentRecords = 0;
        let currentPaymentFilter = {};

        // 渲染收费记录表格
        function renderPaymentsTable(filter) {
          // 如果没有提供筛选条件，使用空对象作为默认值
          if (filter === undefined) {
            filter = {};
          } else {
            // 保存当前筛选条件
            currentPaymentFilter = filter;
          }

          if (!paymentsTableBody) return;

          // 每次都从localStorage重新读取数据，确保数据是最新的
          payments =
            JSON.parse(localStorage.getItem('idh_heating_payments')) || [];
          const users =
            JSON.parse(localStorage.getItem('idh_heating_users')) || [];

          // 获取顶部小区选择器的筛选条件
          const selectedCommunity = communitySelect
            ? communitySelect.value
            : '';

          // 获取高级查询条件
          const searchCommunity =
            document.getElementById('cashSearchCommunity')?.value || '';
          const searchBuilding =
            document.getElementById('cashSearchBuilding')?.value || '';
          const searchUnit =
            document.getElementById('cashSearchUnit')?.value || '';
          const searchRoom =
            document.getElementById('cashSearchRoom')?.value || '';
          const searchHouseholder =
            document
              .getElementById('cashSearchHouseholder')
              ?.value.toLowerCase() || '';
          const searchPhone =
            document.getElementById('cashSearchPhone')?.value || '';
          const searchHeatingSeason =
            document.getElementById('cashSearchHeatingSeason')?.value || '';
          const searchPaymentStatus =
            document.getElementById('cashSearchPaymentStatus')?.value || '';
          const searchFeeType =
            document.getElementById('cashSearchFeeType')?.value || '';
          const searchPaymentMethod =
            document.getElementById('cashSearchPaymentMethod')?.value || '';

          // 筛选数据
          let filteredPayments = payments;

          // 根据顶部选择的小区筛选
          if (selectedCommunity) {
            filteredPayments = filteredPayments.filter(
              (p) => p.community === selectedCommunity,
            );
          }

          // 应用高级查询条件
          if (searchCommunity) {
            filteredPayments = filteredPayments.filter(
              (p) => p.community === searchCommunity,
            );
          }

          if (searchBuilding) {
            filteredPayments = filteredPayments.filter(
              (p) => p.building === searchBuilding,
            );
          }

          if (searchUnit) {
            filteredPayments = filteredPayments.filter(
              (p) => p.unit === searchUnit,
            );
          }

          if (searchRoom) {
            filteredPayments = filteredPayments.filter(
              (p) => p.room === searchRoom,
            );
          }

          // 提前获取用户信息用于筛选
          const paymentWithUserInfo = filteredPayments.map((payment) => {
            const user = users.find(
              (u) =>
                u.community === payment.community &&
                u.building === payment.building &&
                u.unit === payment.unit &&
                u.room === payment.room,
            );
            return {
              payment,
              user,
            };
          });

          // 根据用户信息筛选
          let filteredWithUserInfo = paymentWithUserInfo;

          if (searchHouseholder) {
            filteredWithUserInfo = filteredWithUserInfo.filter((item) =>
              (item.user?.owner || item.payment.owner || '')
                .toLowerCase()
                .includes(searchHouseholder),
            );
          }

          if (searchPhone) {
            filteredWithUserInfo = filteredWithUserInfo.filter((item) =>
              (item.user?.phone || item.payment.phone || '')
                .toLowerCase()
                .includes(searchPhone),
            );
          }

          if (searchHeatingSeason) {
            filteredWithUserInfo = filteredWithUserInfo.filter((item) =>
              Array.isArray(item.payment.heatingSeason)
                ? item.payment.heatingSeason.includes(searchHeatingSeason)
                : item.payment.heatingSeason === searchHeatingSeason,
            );
          }

          if (searchPaymentStatus) {
            // 将显示文本转换为实际存储值
            let statusValue = searchPaymentStatus;
            if (searchPaymentStatus === '已缴费') {
              statusValue = 'paid';
            } else if (searchPaymentStatus === '欠费') {
              statusValue = 'pending';
            }
            filteredWithUserInfo = filteredWithUserInfo.filter(
              (item) => item.payment.status === statusValue,
            );
          }

          if (searchFeeType) {
            // 将显示文本转换为实际存储值
            let feeTypeValue = searchFeeType;
            if (searchFeeType === '全费') {
              feeTypeValue = 'heating';
            } else if (searchFeeType === '空置费') {
              feeTypeValue = 'vacant';
            }
            filteredWithUserInfo = filteredWithUserInfo.filter(
              (item) =>
                item.payment.feeType === feeTypeValue ||
                (feeTypeValue === 'heating' && !item.payment.feeType),
            );
          }

          // 支付方式筛选
          if (searchPaymentMethod) {
            filteredWithUserInfo = filteredWithUserInfo.filter(
              (item) => item.payment.paymentMethod === searchPaymentMethod,
            );
          }

          // 清空表格
          paymentsTableBody.innerHTML = '';

          // 如果没有数据，显示提示消息
          if (noDataMessage) {
            if (filteredWithUserInfo.length === 0) {
              noDataMessage.style.display = 'block';
              return;
            } else {
              noDataMessage.style.display = 'none';
            }
          }

          // 保存过滤后的总记录数
          totalPaymentRecords = filteredWithUserInfo.length;

          // 按日期倒序排序（最新记录在前）
          filteredWithUserInfo.sort(
            (a, b) =>
              new Date(b.payment.paymentDate) - new Date(a.payment.paymentDate),
          );

          // 应用分页
          const startIndex = (currentPaymentPage - 1) * paymentPageSize;
          const endIndex = startIndex + paymentPageSize;
          const paginatedPayments = filteredWithUserInfo.slice(
            startIndex,
            endIndex,
          );

          // 计算总页数
          totalPaymentPages = Math.ceil(
            filteredWithUserInfo.length / paymentPageSize,
          );

          // 填充表格数据
          paginatedPayments.forEach(({ payment, user }) => {
            const row = document.createElement('tr');

            // 根据记录类型和用户账单状态设置不同的样式和状态
            let statusClass = 'status-paid';
            let statusText = '已缴费';

            if (payment.status === 'change') {
              statusClass = 'status-pending';
              statusText = '初始零钱';
            } else if (user) {
              // 根据用户账单状态实时计算缴费状态
              const hasUnpaidBills =
                user.bills &&
                user.bills.some(
                  (bill) =>
                    bill.paymentStatus === 'pending' || bill.arrears > 0,
                );
              if (hasUnpaidBills) {
                statusClass = 'status-pending';
                statusText = '欠费';
              }
            }

            // 从用户信息中获取最新数据，若用户信息不存在则使用payment中的数据
            const community = user?.community || payment.community || '';
            const building = user?.building || payment.building || '';
            const unit = user?.unit || payment.unit || '';
            const room = user?.room || payment.room || '';
            const owner = user?.owner || payment.owner || '';
            const phone = user?.phone || payment.phone || '';

            row.innerHTML = `
                        <td>${payment.id || ''}</td>
                        <td>${community}</td>
                        <td>${building}</td>
                        <td>${unit}</td>
                        <td>${room}</td>
                        <td>${owner}</td>
                        <td>${phone}</td>
                        <td>¥${(payment.shouldPay || 0).toFixed(2)}</td>
                        <td>¥${(payment.actualPay || 0).toFixed(2)}</td>
                        <td>¥${(payment.change || 0).toFixed(2)}</td>
                        <td>¥${(payment.actualChange || 0).toFixed(2)}</td>
                        <td>${formatDate(payment.paymentDate)}</td>
                        <td>${payment.paymentMethod || ''}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-success btn-sm" onclick="viewPaymentDetail('${payment.id}')" title="明细">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="editPayment('${payment.id}')" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="viewReceipt('${payment.id}')" title="收据">
                                    <i class="fas fa-receipt"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deletePayment('${payment.id}')" title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;

            paymentsTableBody.appendChild(row);
          });

          // 更新分页UI
          updatePaymentPaginationUI();
        }

        // 更新收费记录分页UI
        function updatePaymentPaginationUI() {
          // 更新页面信息
          document.getElementById('paymentCurrentPage').textContent =
            currentPaymentPage;
          document.getElementById('paymentTotalPages').textContent =
            totalPaymentPages;
          document.getElementById('paymentTotalRecords').textContent =
            totalPaymentRecords;

          // 更新每页显示数量
          document.getElementById('paymentPageSize').value = paymentPageSize;

          // 更新按钮状态
          document.getElementById('paymentFirstPage').disabled =
            currentPaymentPage === 1;
          document.getElementById('paymentPrevPage').disabled =
            currentPaymentPage === 1;
          document.getElementById('paymentNextPage').disabled =
            currentPaymentPage === totalPaymentPages;
          document.getElementById('paymentLastPage').disabled =
            currentPaymentPage === totalPaymentPages;
        }

        // 绑定收费记录分页事件监听器
        function bindPaymentPaginationEvents() {
          // 首页按钮
          document
            .getElementById('paymentFirstPage')
            .addEventListener('click', function () {
              currentPaymentPage = 1;
              renderPaymentsTable();
            });

          // 上一页按钮
          document
            .getElementById('paymentPrevPage')
            .addEventListener('click', function () {
              if (currentPaymentPage > 1) {
                currentPaymentPage--;
                renderPaymentsTable();
              }
            });

          // 下一页按钮
          document
            .getElementById('paymentNextPage')
            .addEventListener('click', function () {
              if (currentPaymentPage < totalPaymentPages) {
                currentPaymentPage++;
                renderPaymentsTable();
              }
            });

          // 末页按钮
          document
            .getElementById('paymentLastPage')
            .addEventListener('click', function () {
              currentPaymentPage = totalPaymentPages;
              renderPaymentsTable();
            });

          // 每页显示数量变化
          document
            .getElementById('paymentPageSize')
            .addEventListener('change', function () {
              paymentPageSize = parseInt(this.value);
              currentPaymentPage = 1; // 重置到第一页
              renderPaymentsTable();
            });
        }

        // 绑定查询事件监听器
        function bindPaymentSearchEvents() {
          // 高级查询按钮
          const cashSearchBtn = document.getElementById('cashSearchBtn');
          if (cashSearchBtn) {
            cashSearchBtn.addEventListener('click', function () {
              // 重置到第一页
              currentPaymentPage = 1;
              // 重新渲染表格，会自动应用最新的查询条件
              renderPaymentsTable();
            });
          }
        }

        // 初始化事件绑定
        bindPaymentPaginationEvents();
        bindPaymentSearchEvents();

        // 暴露到全局作用域
        window.renderPaymentsTable = renderPaymentsTable;

        // 初始化页面，渲染收费记录表格
        renderPaymentsTable();

        // 打印收据
        window.printReceipt = function (id) {
          const payment = payments.find((p) => p.id === id);
          if (!payment) return;

          // 调用viewReceipt先显示收据
          window.viewReceipt(id);

          // 延迟执行打印，确保收据已渲染完成
          setTimeout(function () {
            // 获取交款单位和款项内容用于文件名
            const payer = `${payment.community || ''} ${payment.building || ''}-${payment.unit || ''}-${payment.room || ''} ${payment.owner || ''}`;
            const item = `${payment.heatingSeason || ''}供暖费${payment.feeType || ''}`;

            // 清理文件名中的非法字符
            const sanitizedPayer = payer.replace(/[\\/:*?"<>|]/g, '_');
            const sanitizedItem = item.replace(/[\\/:*?"<>|]/g, '_');

            // 设置打印样式中的标题，有些浏览器会使用它作为文件名建议
            const style = document.createElement('style');
            style.innerHTML = `
                        @page {
                            @top-center {
                                content: "${sanitizedPayer} ${sanitizedItem}";
                                display: none;
                            }
                        }
                    `;
            document.head.appendChild(style);

            // 执行打印
            window.print();

            // 移除临时样式
            document.head.removeChild(style);

            // 关闭收据模态框
            const modal = document.getElementById('receiptModal');
            modal.style.display = 'none';
          }, 500);
        };

        // 查看收据
        window.viewReceipt = function (id) {
          const payment = payments.find((p) => p.id === id);
          if (!payment) return;

          // 获取用户信息
          const users =
            JSON.parse(localStorage.getItem('idh_heating_users')) || [];
          const user = users.find(
            (u) =>
              u.community === payment.community &&
              u.building === payment.building &&
              u.unit === payment.unit &&
              u.room === payment.room,
          );

          // 从用户信息中获取最新数据，若不存在则使用payment中的数据
          const community = user?.community || payment.community || '';
          const building = user?.building || payment.building || '';
          const unit = user?.unit || payment.unit || '';
          const room = user?.room || payment.room || '';
          const owner = user?.owner || payment.owner || '';

          const receiptContent = document.getElementById('receiptContent');
          if (!receiptContent) return;

          // 解析日期
          const paymentDate = new Date(payment.paymentDate);
          const year = paymentDate.getFullYear();
          const month = paymentDate.getMonth() + 1;
          const day = paymentDate.getDate();

          // 生成收据HTML，完全照搬receipt.html格式
          receiptContent.innerHTML = `
                    <div class="receipt-header">
                        <div class="receipt-company">陕西合智泽熙新能源科技有限公司收据</div>
                        <div class="receipt-title">收    据</div>
                    </div>
                    
                    <div class="receipt-info-row receipt-info-row-mb-20">
                        <span class="receipt-field">${year}</span>
                        <span>年</span>
                        <span class="receipt-field">${month}</span>
                        <span>月</span>
                        <span class="receipt-field">${day}</span>
                        <span>日</span>
                        <span>No</span>
                        <span class="receipt-field">${payment.receiptNumber}</span>
                    </div>
                    
                    <div class="receipt-info-row receipt-info-row-mt-15 receipt-info-row-gap-67">
                        <span>交款单位</span>
                        <span class="receipt-field">${community} ${building}-${unit}-${room} ${owner}</span>
                        <span>收款方式</span>
                        <span class="receipt-field">${payment.paymentMethod || ''}</span>
                    </div>  
                    
                    <div class="receipt-info-row receipt-info-row-mt-15">
                        <span>款项内容</span>
                        <span class="receipt-field receipt-field-81pct receipt-field-left">${payment.heatingSeason || ''} 供暖费 ${payment.feeType}</span>
                    </div>
                    
                    <div class="receipt-info-row receipt-info-row-mt-15 receipt-info-row-gap-29">
                        <span>人民币（大写）</span>
                        <span class="receipt-field receipt-field-bold">${convertToChineseAmount(payment.paid)}</span>
                        <span class="receipt-amount-symbol">￥</span>
                        <span class="receipt-field receipt-field-bold">${payment.paid.toFixed(2)}</span>
                    </div>
                    
                    <div class="receipt-info-row receipt-info-row-mt-15">
                        <span>备注：</span>
                        <span class="receipt-field receipt-field-81pct receipt-field-left">${payment.remarks || '无'}</span>
                    </div>
                    
                    <div class="receipt-footer">
                        <div class="receipt-footer-item">
                            <div class="receipt-footer-label">单位盖章</div>
                        </div>
                        <div class="receipt-footer-item">
                            <div class="receipt-footer-label">主管领导：</div>
                        </div>
                        <div class="receipt-footer-item">
                            <div class="receipt-footer-label">会计：</div>
                        </div>
                        <div class="receipt-footer-item">
                            <div class="receipt-footer-label">出纳：</div>
                        </div>
                        <div class="receipt-footer-item">
                            <div class="receipt-footer-label">经办：${payment.processor || ''}</div>
                        </div>
                    </div>
                `;

          // 显示模态框
          const modal = document.getElementById('receiptModal');
          modal.style.display = 'flex';

          // 绑定关闭事件
          const closeBtn = modal.querySelector('.close-modal');
          const closeReceiptBtn = document.getElementById('closeReceipt');

          // 点击模态框关闭按钮（如果存在）
          if (closeBtn) {
            closeBtn.addEventListener('click', function () {
              modal.style.display = 'none';
            });
          }

          // 点击关闭按钮
          if (closeReceiptBtn) {
            closeReceiptBtn.addEventListener('click', function () {
              modal.style.display = 'none';
            });
          }
        };

        // 查看收费明细
        window.viewPaymentDetail = function (id) {
          const payment = payments.find((p) => p.id === id);
          if (!payment) return;

          // 获取用户信息
          const users =
            JSON.parse(localStorage.getItem('idh_heating_users')) || [];
          const user = users.find(
            (u) =>
              u.community === payment.community &&
              u.building === payment.building &&
              u.unit === payment.unit &&
              u.room === payment.room,
          );

          const modal = document.getElementById('createPaymentModal');
          const modalTitle = modal.querySelector('.modal-header h4');

          // 设置窗口标题为"收费明细"
          modalTitle.innerHTML = '<i class="fas fa-info-circle"></i> 收费明细';

          // 填充表单数据
          document.getElementById('paymentNumber').value = payment.id || '';
          document.getElementById('receiptNumber').value =
            payment.receiptNumber || '';
          document.getElementById('paymentCreateTime').value =
            payment.createTime || new Date().toLocaleString();

          // 初始化小区名称下拉框
          const communitySelect = document.getElementById('paymentCommunity');
          if (communitySelect.children.length <= 1) {
            // 只包含默认选项
            const communities = [
              ...new Set(users.map((user) => user.community)),
            ];
            communitySelect.innerHTML = '<option value="">请选择小区</option>';
            communitySelect.innerHTML += communities
              .map(
                (community) =>
                  `<option value="${community}">${community}</option>`,
              )
              .join('');
          }

          // 初始化楼号下拉框
          const buildingSelect = document.getElementById('paymentBuilding');
          const community = payment.community || '';
          if (community) {
            const buildings = [
              ...new Set(
                users
                  .filter((user) => user.community === community)
                  .map((user) => user.building),
              ),
            ];
            buildingSelect.innerHTML = '<option value="">请选择楼号</option>';
            buildingSelect.innerHTML += buildings
              .map(
                (building) =>
                  `<option value="${building}">${building}</option>`,
              )
              .join('');
          }

          // 初始化单元下拉框
          const unitSelect = document.getElementById('paymentUnit');
          const building = payment.building || '';
          if (community && building) {
            const units = [
              ...new Set(
                users
                  .filter(
                    (user) =>
                      user.community === community &&
                      user.building === building,
                  )
                  .map((user) => user.unit),
              ),
            ];
            unitSelect.innerHTML = '<option value="">请选择单元</option>';
            unitSelect.innerHTML += units
              .map((unit) => `<option value="${unit}">${unit}</option>`)
              .join('');
          }

          // 初始化房号下拉框
          const roomSelect = document.getElementById('paymentRoom');
          const unit = payment.unit || '';
          if (community && building && unit) {
            const rooms = [
              ...new Set(
                users
                  .filter(
                    (user) =>
                      user.community === community &&
                      user.building === building &&
                      user.unit === unit,
                  )
                  .map((user) => user.room),
              ),
            ];
            roomSelect.innerHTML = '<option value="">请选择房号</option>';
            roomSelect.innerHTML += rooms
              .map((room) => `<option value="${room}">${room}</option>`)
              .join('');
          }

          // 设置用户信息
          document.getElementById('paymentCommunity').value =
            user?.community || payment.community || '';
          document.getElementById('paymentBuilding').value =
            user?.building || payment.building || '';
          document.getElementById('paymentUnit').value =
            user?.unit || payment.unit || '';
          document.getElementById('paymentRoom').value =
            user?.room || payment.room || '';
          document.getElementById('paymentArea').value =
            user?.area || payment.area || '';
          document.getElementById('paymentOwner').value =
            user?.owner || payment.owner || '';
          document.getElementById('paymentPhone').value =
            user?.phone || payment.phone || '';

          // 设置收费信息
          document.getElementById('paymentShouldPay').value =
            payment.shouldPay || '';
          document.getElementById('paymentActualPay').value =
            payment.actualPay || '';
          document.getElementById('paymentPaid').value = payment.paid || '';
          document.getElementById('paymentChange').value = payment.change || '';
          document.getElementById('paymentActualChange').value =
            payment.actualChange || '';
          document.getElementById('paymentChangeLoss').value =
            payment.changeLoss || '';
          document.getElementById('paymentUnitPrice').value =
            payment.unitPrice || '';
          document.getElementById('paymentDate').value =
            payment.paymentDate || '';
          document.getElementById('paymentHeatingSeason').value = Array.isArray(
            payment.heatingSeason,
          )
            ? payment.heatingSeason.join(', ')
            : payment.heatingSeason || '';
          document.getElementById('paymentMethod').value =
            payment.paymentMethod || '';
          document.getElementById('paymentCreator').value =
            payment.creator || '';
          document.getElementById('paymentProcessor').value =
            payment.processor || '';
          document.getElementById('paymentRemarks').value =
            payment.remarks || '';

          // 设置大写金额
          const shouldPay = parseFloat(payment.shouldPay || 0);
          const uppercaseAmount = convertToChineseAmount(shouldPay);
          document.getElementById('paymentShouldPayUppercase').textContent =
            uppercaseAmount;

          // 显示模态框
          modal.style.display = 'flex';

          // 设置所有字段为只读
          const formControls = modal.querySelectorAll('.form-control');
          formControls.forEach((control) => {
            control.readOnly = true;
            control.disabled = true;
          });

          // 使用fillPaymentBillInfo函数填充账单信息
          window.fillPaymentBillInfo(user);

          // 根据原始收费记录的供暖季和费用类型勾选对应的账单复选框
          // 首先清除所有已勾选状态，并设置为不可编辑
          const allCheckboxes = document.querySelectorAll('.bill-checkbox');
          allCheckboxes.forEach((checkbox) => {
            checkbox.checked = false;
            checkbox.disabled = true;
          });

          // 然后勾选与当前收费记录相关的账单
          if (user && user.bills) {
            user.bills.forEach((bill) => {
              // 检查当前账单的供暖季是否在缴费记录的供暖季列表中
              const isPaid = Array.isArray(payment.heatingSeason)
                ? payment.heatingSeason.includes(bill.heatingSeason)
                : payment.heatingSeason === bill.heatingSeason;

              if (isPaid) {
                // 查找对应的复选框并勾选
                const checkbox = document.querySelector(
                  `.bill-checkbox[data-bill-id="${bill.heatingSeason}-${bill.feeType}"]`,
                );
                if (checkbox) {
                  checkbox.checked = true;
                }
              }
            });
          }

          // 隐藏保存按钮，只显示取消按钮
          const saveButton = document.querySelector(
            '#createPaymentModal button[type="submit"]',
          );
          const cancelButton = document.getElementById('cancelPaymentBtn');
          if (saveButton) saveButton.style.display = 'none';
          if (cancelButton) cancelButton.textContent = '关闭';

          // 移除编辑标志
          const editFlag = document.getElementById('editPaymentFlag');
          if (editFlag) editFlag.value = 'false';

          // 关闭按钮事件
          modal.querySelector('.close').addEventListener('click', function () {
            modal.style.display = 'none';
            // 恢复表单状态
            window.resetPaymentForm();
          });

          // 取消按钮事件
          cancelButton.addEventListener('click', function () {
            modal.style.display = 'none';
            // 恢复表单状态
            window.resetPaymentForm();
          });

          // 绑定级联事件，确保后续修改能正常工作
          if (typeof window.bindPaymentFormCascadeEvents === 'function') {
            window.bindPaymentFormCascadeEvents();
          }

          // 重新计算应缴金额
          if (typeof window.updateTotalShouldPay === 'function') {
            window.updateTotalShouldPay();
          }
        };

        // 编辑记录
        window.editPayment = function (id) {
          const payment = payments.find((p) => p.id === id);
          if (!payment) return;

          // 显示编辑模态框，复用新建收费窗口
          const modal = document.getElementById('createPaymentModal');
          const modalTitle = modal.querySelector('.modal-header h4');
          const paymentForm = document.getElementById('paymentCreateForm');

          // 设置窗口标题为"编辑记录"
          modalTitle.innerHTML = '<i class="fas fa-edit"></i> 编辑记录';

          // 显示模态框
          modal.style.display = 'flex';

          // 初始化小区、楼号、单元、房号下拉框
          const users =
            JSON.parse(localStorage.getItem('idh_heating_users')) || [];

          // 初始化小区下拉框
          const communitySelect = document.getElementById('paymentCommunity');
          communitySelect.innerHTML = '<option value="">请选择小区</option>';
          const communities = [...new Set(users.map((user) => user.community))];
          communitySelect.innerHTML += communities
            .map(
              (community) =>
                `<option value="${community}">${community}</option>`,
            )
            .join('');

          // 设置小区值
          communitySelect.value = payment.community || '';

          // 初始化楼号下拉框
          const buildingSelect = document.getElementById('paymentBuilding');
          buildingSelect.innerHTML = '<option value="">请选择楼号</option>';
          if (payment.community) {
            const buildings = [
              ...new Set(
                users
                  .filter((user) => user.community === payment.community)
                  .map((user) => user.building),
              ),
            ];
            buildingSelect.innerHTML += buildings
              .map(
                (building) =>
                  `<option value="${building}">${building}</option>`,
              )
              .join('');
          }

          // 设置楼号值
          buildingSelect.value = payment.building || '';

          // 初始化单元下拉框
          const unitSelect = document.getElementById('paymentUnit');
          unitSelect.innerHTML = '<option value="">请选择单元</option>';
          if (payment.community && payment.building) {
            const units = [
              ...new Set(
                users
                  .filter(
                    (user) =>
                      user.community === payment.community &&
                      user.building === payment.building,
                  )
                  .map((user) => user.unit),
              ),
            ];
            unitSelect.innerHTML += units
              .map((unit) => `<option value="${unit}">${unit}</option>`)
              .join('');
          }

          // 设置单元值
          unitSelect.value = payment.unit || '';

          // 初始化房号下拉框
          const roomSelect = document.getElementById('paymentRoom');
          roomSelect.innerHTML = '<option value="">请选择房号</option>';
          if (payment.community && payment.building && payment.unit) {
            const rooms = [
              ...new Set(
                users
                  .filter(
                    (user) =>
                      user.community === payment.community &&
                      user.building === payment.building &&
                      user.unit === payment.unit,
                  )
                  .map((user) => user.room),
              ),
            ];
            roomSelect.innerHTML += rooms
              .map((room) => `<option value="${room}">${room}</option>`)
              .join('');
          }

          // 设置房号值
          roomSelect.value = payment.room || '';

          // 填充表单数据
          document.getElementById('paymentNumber').value = payment.id;
          document.getElementById('receiptNumber').value =
            payment.receiptNumber || '';
          document.getElementById('paymentCreateTime').value =
            payment.createTime || new Date().toLocaleString();

          // 查找对应的用户信息
          const matchingUser = users.find(
            (user) =>
              user.community === payment.community &&
              user.building === payment.building &&
              user.unit === payment.unit &&
              user.room === payment.room,
          );

          // 设置其他字段 - 优先从用户信息中获取
          document.getElementById('paymentArea').value =
            matchingUser?.area || payment.area || '';
          document.getElementById('paymentOwner').value =
            matchingUser?.owner || payment.owner || '';
          document.getElementById('paymentPhone').value =
            matchingUser?.phone || payment.phone || '';
          document.getElementById('paymentShouldPay').value =
            payment.shouldPay || '';
          document.getElementById('paymentActualPay').value =
            payment.actualPay || '';
          document.getElementById('paymentPaid').value = payment.paid || '';
          document.getElementById('paymentChange').value = payment.change || '';
          document.getElementById('paymentActualChange').value =
            payment.actualChange || '';
          document.getElementById('paymentChangeLoss').value =
            payment.changeLoss || '';
          document.getElementById('paymentUnitPrice').value =
            payment.unitPrice || '';
          document.getElementById('paymentDate').value =
            payment.paymentDate || '';
          document.getElementById('paymentHeatingSeason').value = Array.isArray(
            payment.heatingSeason,
          )
            ? payment.heatingSeason.join(', ')
            : payment.heatingSeason || '';
          document.getElementById('paymentMethod').value =
            payment.paymentMethod || '';
          document.getElementById('paymentCreator').value =
            payment.creator || '';
          document.getElementById('paymentProcessor').value =
            payment.processor || '';
          document.getElementById('paymentRemarks').value =
            payment.remarks || '';

          // 设置大写金额
          const shouldPay = parseFloat(payment.shouldPay || 0);
          const uppercaseAmount = convertToChineseAmount(shouldPay);
          document.getElementById('paymentShouldPayUppercase').textContent =
            uppercaseAmount;

          // 添加一个隐藏字段来标识这是编辑操作
          let editFlagField = document.getElementById('editPaymentFlag');
          if (!editFlagField) {
            editFlagField = document.createElement('input');
            editFlagField.type = 'hidden';
            editFlagField.id = 'editPaymentFlag';
            paymentForm.appendChild(editFlagField);
          }
          editFlagField.value = 'true';

          // 设置字段的可编辑状态
          // 收据编号、收费日期、办理人、业主姓名、电话可以编辑，其他都不可编辑
          const editableFields = [
            'receiptNumber',
            'paymentDate',
            'paymentProcessor',
            'paymentOwner',
            'paymentPhone',
          ];
          const allFields = [
            'paymentNumber',
            'paymentCreateTime',
            'paymentCommunity',
            'paymentBuilding',
            'paymentUnit',
            'paymentRoom',
            'paymentArea',
            'paymentOwner',
            'paymentPhone',
            'paymentShouldPay',
            'paymentActualPay',
            'paymentPaid',
            'paymentChange',
            'paymentActualChange',
            'paymentChangeLoss',
            'paymentUnitPrice',
            'paymentMethod',
            'paymentCreator',
            'paymentRemarks',
            'receiptNumber',
            'paymentDate',
            'paymentProcessor',
          ];

          allFields.forEach((fieldId) => {
            const field = document.getElementById(fieldId);
            if (field) {
              if (editableFields.includes(fieldId)) {
                field.removeAttribute('readonly');
                field.removeAttribute('disabled');
              } else {
                field.setAttribute('readonly', 'readonly');
                field.setAttribute('disabled', 'disabled');
              }
            }
          });

          // 特殊处理下拉框
          const selectFields = [
            'paymentCommunity',
            'paymentBuilding',
            'paymentUnit',
            'paymentRoom',
            'paymentMethod',
          ];
          selectFields.forEach((fieldId) => {
            const field = document.getElementById(fieldId);
            if (field) {
              if (editableFields.includes(fieldId)) {
                field.removeAttribute('disabled');
              } else {
                field.setAttribute('disabled', 'disabled');
              }
            }
          });

          // 记录原始ID，用于更新时查找
          let originalIdField = document.getElementById('originalPaymentId');
          if (!originalIdField) {
            originalIdField = document.createElement('input');
            originalIdField.type = 'hidden';
            originalIdField.id = 'originalPaymentId';
            paymentForm.appendChild(originalIdField);
          }
          originalIdField.value = id;

          // 填充账单信息
          window.fillPaymentBillInfo(matchingUser);

          // 根据原始收费记录的供暖季和费用类型勾选对应的账单复选框
          // 首先清除所有已勾选状态，并设置为不可编辑
          const allCheckboxes = document.querySelectorAll('.bill-checkbox');
          allCheckboxes.forEach((checkbox) => {
            checkbox.checked = false;
            checkbox.disabled = true;
          });

          // 然后勾选与原始收费记录匹配的账单
          const checkboxes = document.querySelectorAll('.bill-checkbox');
          checkboxes.forEach((checkbox) => {
            const heatingSeason = checkbox.dataset.heatingSeason;
            const feeType = checkbox.dataset.feeType;

            // 如果当前收费记录的供暖季和费用类型与账单匹配，勾选该账单
            if (
              heatingSeason === payment.heatingSeason &&
              feeType === payment.feeType
            ) {
              checkbox.checked = true;
            }
          });

          // 绑定级联事件，确保后续修改能正常工作
          if (typeof window.bindPaymentFormCascadeEvents === 'function') {
            window.bindPaymentFormCascadeEvents();
          }

          // 重新计算应缴金额
          if (typeof window.updateTotalShouldPay === 'function') {
            window.updateTotalShouldPay();
          }
        };

        // 删除记录
        window.deletePayment = function (id) {
          if (confirm('确定要删除此收费记录吗？')) {
            // 先找到要删除的记录
            const paymentToDelete = payments.find((p) => p.id === id);

            // 如果找到记录，且有找零损耗，则还原到零钱余额中
            if (paymentToDelete) {
              const changeLoss = parseFloat(paymentToDelete.changeLoss) || 0;
              const community = paymentToDelete.community;

              if (community) {
                // 从localStorage获取当前的零钱余额
                const communityChange =
                  JSON.parse(
                    localStorage.getItem('idh_heating_community_change'),
                  ) || {};
                const currentChange =
                  parseFloat(communityChange[community]) || 0;

                // 计算新的零钱余额：新余额 = 当前余额 - 找零损耗
                const newChange = currentChange - changeLoss;

                // 保存更新后的零钱余额到localStorage
                communityChange[community] = newChange;
                localStorage.setItem(
                  'idh_heating_community_change',
                  JSON.stringify(communityChange),
                );
              }
            }

            // 删除记录
            payments = payments.filter((p) => p.id !== id);
            localStorage.setItem(
              'idh_heating_payments',
              JSON.stringify(payments),
            );

            updateStats();
            renderPaymentsTable();

            alert('记录已删除');
          }
        };

        // 关闭收据模态框
        if (document.querySelector('.close-modal')) {
          document
            .querySelector('.close-modal')
            .addEventListener('click', function () {
              if (document.getElementById('receiptModal')) {
                document.getElementById('receiptModal').style.display = 'none';
              }
            });
        }

        if (document.getElementById('closeReceipt')) {
          document
            .getElementById('closeReceipt')
            .addEventListener('click', function () {
              if (document.getElementById('receiptModal')) {
                document.getElementById('receiptModal').style.display = 'none';
              }
            });
        }

        // 点击模态框外部关闭
        window.addEventListener('click', function (e) {
          const modal = document.getElementById('receiptModal');
          if (modal && e.target === modal) {
            modal.style.display = 'none';
          }
        });

        // 打印收据
        if (document.getElementById('printReceipt')) {
          document
            .getElementById('printReceipt')
            .addEventListener('click', function () {
              window.print();
            });
        }

        // 辅助函数：格式化日期
        function formatDate(dateString) {
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
          });
        }

        // 辅助函数：数字转中文大写
        function numberToChinese(num) {
          const chineseNumbers = [
            '零',
            '壹',
            '贰',
            '叁',
            '肆',
            '伍',
            '陆',
            '柒',
            '捌',
            '玖',
          ];
          const chineseUnits = [
            '',
            '拾',
            '佰',
            '仟',
            '万',
            '拾',
            '佰',
            '仟',
            '亿',
          ];

          // 将数字转为字符串并处理小数部分
          let str = num.toFixed(2);
          let integerPart = parseInt(str.split('.')[0]);
          let decimalPart = parseInt(str.split('.')[1]);

          let result = '';

          // 处理整数部分
          if (integerPart === 0) {
            result = '零';
          } else {
            let integerStr = integerPart.toString();
            let unitIndex = 0;

            for (let i = integerStr.length - 1; i >= 0; i--) {
              let digit = parseInt(integerStr[i]);
              let unit = chineseUnits[unitIndex];

              if (digit === 0) {
                // 处理连续的零
                if (result.charAt(0) !== '零') {
                  result = '零' + result;
                }
              } else {
                result = chineseNumbers[digit] + unit + result;
              }

              unitIndex++;
            }

            // 移除多余的零
            result = result.replace(/零+/g, '零').replace(/零$/, '');
          }

          result += '元';

          // 处理小数部分
          if (decimalPart > 0) {
            let jiao = Math.floor(decimalPart / 10);
            let fen = decimalPart % 10;

            if (jiao > 0) {
              result += chineseNumbers[jiao] + '角';
            }

            if (fen > 0) {
              result += chineseNumbers[fen] + '分';
            }
          } else {
            result += '整';
          }

          return result;
        }
      });
      // 线下缴费功能 - 结束

      // 统计分析功能 - 开始
      // 使用客服工单现有的getTickets()函数获取数据，避免全局变量冲突

      let communities = JSON.parse(localStorage.getItem('idh_heating_users'))
        ? [
            ...new Set(
              JSON.parse(localStorage.getItem('idh_heating_users')).map(
                (user) => user.community,
              ),
            ),
          ].map((name, index) => ({
            id: index + 1,
            name: name,
            buildings: 10, // 默认值，实际数据可从用户信息中统计
          }))
        : [
            { id: 1, name: '阳光小区', buildings: 15 },
            { id: 2, name: '温馨家园', buildings: 12 },
            { id: 3, name: '和谐社区', buildings: 20 },
            { id: 4, name: '幸福里', buildings: 8 },
            { id: 5, name: '金色家园', buildings: 18 },
          ];
      let systemSettings = JSON.parse(localStorage.getItem('idhSettings')) || {
        systemName: 'IDH智慧供热客服系统',
        defaultTimeRange: 7,
        backupFrequency: 'weekly',
      };

      // 统计分析初始化函数 - 用于在现有DOMContentLoaded事件中调用
      function initAnalysisModule() {
        loadCommunities();
        updateAnalysisStats();
        initCharts();
        // 统计分析模块的事件监听器已整合到客服工单的setupEventListeners函数中

        // 每5秒刷新一次工单数据，确保数据实时更新
        setInterval(function () {
          updateAnalysisStats();
        }, 5000);
      }

      // 加载小区数据到下拉框
      function loadCommunities() {
        const communitySelects = [
          document.getElementById('filterCommunity'),
          document.getElementById('analysisCommunity'),
          document.getElementById('modalCommunity'),
        ];

        communitySelects.forEach((select) => {
          if (!select) return;

          // 清空选项（保留第一个选项）
          while (select.options.length > 1) {
            select.remove(1);
          }

          // 添加小区选项
          communities.forEach((community) => {
            const option = document.createElement('option');
            option.value = community.name;
            option.textContent = community.name;
            select.appendChild(option);
          });
        });
      }

      // 更新统计数据
      function updateAnalysisStats() {
        // 使用客服工单现有的getTickets()函数获取数据，避免全局变量冲突
        const workOrders = getTickets();
        console.log('开始更新统计数据，当前工单数量:', workOrders.length);

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // 计算总工单数
        const totalWorkOrders = workOrders.length;
        console.log('总工单数:', totalWorkOrders);

        // 计算今日工单
        const todayWorkOrders = workOrders.filter((order) => {
          // 适配不同的数据结构
          const orderDate = new Date(
            order.createdAt ||
              order.createTime ||
              order.create_date ||
              Date.now(),
          );
          orderDate.setHours(0, 0, 0, 0);
          return orderDate.getTime() === today.getTime();
        }).length;
        console.log('今日工单:', todayWorkOrders);

        // 计算未开始工单
        const pendingWorkOrders = workOrders.filter(
          (order) =>
            order.status === '未开始' ||
            order.status === 'pending' ||
            order.status === 'new',
        ).length;
        console.log('未开始:', pendingWorkOrders);

        // 计算进行中工单
        const progressWorkOrders = workOrders.filter(
          (order) => order.status === '进行中' || order.status === 'processing',
        ).length;
        console.log('进行中:', progressWorkOrders);

        // 计算已办结工单
        const completedWorkOrders = workOrders.filter(
          (order) =>
            order.status === '已办结' ||
            order.status === 'resolved' ||
            order.status === 'closed',
        ).length;
        console.log('已办结:', completedWorkOrders);

        // 更新统计卡片
        const elements = {
          totalWorkOrders: document.getElementById('totalWorkOrders'),
          todayWorkOrders: document.getElementById('todayWorkOrders'),
          pendingWorkOrders: document.getElementById('pendingWorkOrders'),
          progressWorkOrders: document.getElementById('progressWorkOrders'),
          completedWorkOrders: document.getElementById('completedWorkOrders'),
        };

        // 更新数据
        if (elements.totalWorkOrders) {
          elements.totalWorkOrders.textContent = totalWorkOrders;
        }
        if (elements.todayWorkOrders) {
          elements.todayWorkOrders.textContent = todayWorkOrders;
        }
        if (elements.pendingWorkOrders) {
          elements.pendingWorkOrders.textContent = pendingWorkOrders;
        }
        if (elements.progressWorkOrders) {
          elements.progressWorkOrders.textContent = progressWorkOrders;
        }
        if (elements.completedWorkOrders) {
          elements.completedWorkOrders.textContent = completedWorkOrders;
        }
      }

      // 初始化图表
      function initCharts() {
        initTrendChart();
        initStatusChart();
        initCommunityChart();
        initBuildingChart();
        initTimeChart();
        initPaymentStatusChart();
        initTicketTypeChart();
        initUserWorkOrderChart();
        initDailyPaymentChart();
        initPaymentMethodChart();
        initCommunityPaymentChart();
        initAmountRangeChart();
      }

      // 初始化趋势图
      function initTrendChart() {
        const ctx = document.getElementById('trendChart');
        if (!ctx) return;

        // 使用客服工单现有的getTickets()函数获取数据
        let workOrders = getTickets();

        // 过滤掉无效状态的工单
        workOrders = workOrders.filter((order) => {
          const status = order.status || '';
          return !['已删除', '已撤销', '已关闭'].includes(status);
        });

        if (workOrders.length === 0) {
          // 如果没有工单数据，不绘制图表
          return;
        }

        // 处理工单数据，按日期分组
        const dateGroups = {};
        let firstDate, lastDate;

        // 对工单按创建时间排序，获取最早的创建时间
        const sortedWorkOrders = [...workOrders].sort((a, b) => {
          const dateA = new Date(
            a.createdAt ||
              a.createTime ||
              a.create_date ||
              a.date ||
              Date.now(),
          );
          const dateB = new Date(
            b.createdAt ||
              b.createTime ||
              b.create_date ||
              b.date ||
              Date.now(),
          );
          return dateA - dateB;
        });

        // 如果有工单，使用第一个工单的创建时间作为firstDate
        if (sortedWorkOrders.length > 0) {
          const firstOrderDate = new Date(
            sortedWorkOrders[0].createdAt ||
              sortedWorkOrders[0].createTime ||
              sortedWorkOrders[0].create_date ||
              sortedWorkOrders[0].date ||
              Date.now(),
          );
          firstDate = firstOrderDate;
        } else {
          // 如果没有工单，使用当前日期
          firstDate = new Date();
        }

        // 遍历工单数据，构建日期分组
        workOrders.forEach((order) => {
          // 尝试不同的日期字段，确保能获取到正确的创建日期
          const orderDate =
            order.createdAt ||
            order.createTime ||
            order.create_date ||
            order.date ||
            Date.now();
          const date = new Date(orderDate);
          const dateStr = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;

          // 更新最晚日期
          if (!lastDate || date > lastDate) {
            lastDate = date;
          }

          if (!dateGroups[dateStr]) {
            dateGroups[dateStr] = 0;
          }
          dateGroups[dateStr]++;
        });

        // 如果没有设置lastDate（没有工单），使用当前日期
        if (!lastDate) {
          lastDate = new Date();
        }

        // 设置时间为零点，避免时间部分影响比较
        firstDate.setHours(0, 0, 0, 0);

        // 使用第一条工单的创建时间作为开始时间
        const startDate = firstDate;
        // 使用当前日期作为结束日期
        const endDate = new Date();
        endDate.setHours(0, 0, 0, 0);

        // 生成从开始日期到结束日期的所有日期
        const allDates = [];
        const currentDate = new Date(startDate);

        while (currentDate <= endDate) {
          const dateStr = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}-${currentDate.getDate().toString().padStart(2, '0')}`;
          allDates.push(dateStr);
          currentDate.setDate(currentDate.getDate() + 1);
        }

        // 转换为图表数据格式，包含所有日期
        const labels = allDates;
        const data = allDates.map((dateStr) => dateGroups[dateStr] || 0);

        // 创建图表
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: '工单数量',
                data: data,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                title: {
                  display: true,
                  text: '日期',
                },
                // 如果日期太多，设置自动旋转标签
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                },
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: '工单数量',
                },
                ticks: {
                  stepSize: 1,
                },
              },
            },
          },
        });
      }

      // 初始化状态分布饼图
      function initStatusChart() {
        const ctx = document.getElementById('statusChart');
        if (!ctx) return;

        // 使用客服工单现有的getTickets()函数获取数据
        const workOrders = getTickets();

        // 统计不同状态的工单数量
        const statusCounts = {
          未开始: 0,
          进行中: 0,
          已办结: 0,
          其他: 0,
        };

        workOrders.forEach((order) => {
          if (
            order.status === '未开始' ||
            order.status === 'pending' ||
            order.status === 'new'
          ) {
            statusCounts['未开始']++;
          } else if (
            order.status === '进行中' ||
            order.status === 'processing'
          ) {
            statusCounts['进行中']++;
          } else if (
            order.status === '已办结' ||
            order.status === 'resolved' ||
            order.status === 'closed'
          ) {
            statusCounts['已办结']++;
          } else {
            statusCounts['其他']++;
          }
        });

        // 创建图表
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels: Object.keys(statusCounts),
            datasets: [
              {
                data: Object.values(statusCounts),
                backgroundColor: [
                  'rgba(255, 99, 132, 0.8)',
                  'rgba(54, 162, 235, 0.8)',
                  'rgba(75, 192, 192, 0.8)',
                  'rgba(255, 206, 86, 0.8)',
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
          },
        });
      }

      // 初始化小区工单分布柱状图
      function initCommunityChart() {
        const ctx = document.getElementById('communityChart');
        if (!ctx) return;

        // 使用客服工单现有的getTickets()函数获取数据
        let workOrders = getTickets();

        // 过滤掉无效状态的工单
        workOrders = workOrders.filter((order) => {
          const status = order.status || '';
          return !['已删除', '已撤销', '已关闭'].includes(status);
        });

        // 统计每个小区的工单数量
        const communityCounts = {};

        workOrders.forEach((order) => {
          const community = order.community || '未知小区';
          if (!communityCounts[community]) {
            communityCounts[community] = 0;
          }
          communityCounts[community]++;
        });

        // 创建图表
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(communityCounts),
            datasets: [
              {
                label: '工单数量',
                data: Object.values(communityCounts),
                backgroundColor: 'rgba(153, 102, 255, 0.8)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                },
              },
            },
          },
        });
      }

      // 初始化楼栋工单分布柱状图
      function initBuildingChart() {
        const ctx = document.getElementById('buildingChart');
        if (!ctx) return;

        // 使用客服工单现有的getTickets()函数获取数据
        let workOrders = getTickets();

        // 过滤掉无效状态的工单
        workOrders = workOrders.filter((order) => {
          const status = order.status || '';
          return !['已删除', '已撤销', '已关闭'].includes(status);
        });

        // 统计每个楼栋的工单数量
        const buildingCounts = {};

        workOrders.forEach((order) => {
          const community = order.community || '未知小区';
          const building = order.building || '未知楼栋';
          const buildingKey = `${community}-${building}`;

          if (!buildingCounts[buildingKey]) {
            buildingCounts[buildingKey] = 0;
          }
          buildingCounts[buildingKey]++;
        });

        // 创建图表
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(buildingCounts),
            datasets: [
              {
                label: '工单数量',
                data: Object.values(buildingCounts),
                backgroundColor: 'rgba(255, 159, 64, 0.8)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                title: {
                  display: true,
                  text: '楼栋',
                },
                // 如果楼栋数量太多，设置自动旋转标签
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                },
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: '工单数量',
                },
                ticks: {
                  stepSize: 1,
                },
              },
            },
          },
        });
      }

      // 初始化处理时效分析图
      function initTimeChart() {
        const ctx = document.getElementById('timeChart');
        if (!ctx) return;

        // 使用客服工单现有的getTickets()函数获取数据
        let workOrders = getTickets();

        // 过滤掉无效状态的工单
        workOrders = workOrders.filter((order) => {
          const status = order.status || '';
          return !['已删除', '已撤销', '已关闭'].includes(status);
        });

        // 简化处理：显示不同状态的工单数量
        const statusCounts = {
          未开始: 0,
          进行中: 0,
          已办结: 0,
        };

        workOrders.forEach((order) => {
          if (
            order.status === '未开始' ||
            order.status === 'pending' ||
            order.status === 'new'
          ) {
            statusCounts['未开始']++;
          } else if (
            order.status === '进行中' ||
            order.status === 'processing'
          ) {
            statusCounts['进行中']++;
          } else if (
            order.status === '已办结' ||
            order.status === 'resolved' ||
            order.status === 'closed'
          ) {
            statusCounts['已办结']++;
          }
        });

        // 创建图表
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(statusCounts),
            datasets: [
              {
                data: Object.values(statusCounts),
                backgroundColor: [
                  'rgba(255, 99, 132, 0.8)',
                  'rgba(54, 162, 235, 0.8)',
                  'rgba(75, 192, 192, 0.8)',
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
          },
        });
      }

      // 初始化缴费状态分布图表
      function initPaymentStatusChart() {
        const ctx = document.getElementById('paymentStatusChart');
        if (!ctx) return;

        // 使用客服工单现有的getTickets()函数获取数据
        let workOrders = getTickets();

        // 过滤掉无效状态的工单
        workOrders = workOrders.filter((order) => {
          const status = order.status || '';
          return !['已删除', '已撤销', '已关闭'].includes(status);
        });

        // 统计缴费状态分布
        const paymentStatusCounts = {
          已缴费: 0,
          欠费: 0,
          未设置: 0,
        };

        workOrders.forEach((order) => {
          const status = order.paymentStatus || '未设置';
          if (paymentStatusCounts.hasOwnProperty(status)) {
            paymentStatusCounts[status]++;
          } else {
            paymentStatusCounts['未设置']++;
          }
        });

        // 创建图表
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels: Object.keys(paymentStatusCounts),
            datasets: [
              {
                label: '缴费状态',
                data: Object.values(paymentStatusCounts),
                backgroundColor: [
                  'rgba(75, 192, 192, 0.8)',
                  'rgba(255, 99, 132, 0.8)',
                  'rgba(201, 203, 207, 0.8)',
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
              },
            },
          },
        });
      }

      // 初始化工单类型分布图表
      function initTicketTypeChart() {
        const ctx = document.getElementById('ticketTypeChart');
        if (!ctx) return;

        // 使用客服工单现有的getTickets()函数获取数据
        let workOrders = getTickets();

        // 过滤掉无效状态的工单
        workOrders = workOrders.filter((order) => {
          const status = order.status || '';
          return !['已删除', '已撤销', '已关闭'].includes(status);
        });

        // 统计工单类型分布
        const ticketTypeCounts = {};

        workOrders.forEach((order) => {
          const type = order.ticketType || '未设置';
          ticketTypeCounts[type] = (ticketTypeCounts[type] || 0) + 1;
        });

        // 创建图表
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels: Object.keys(ticketTypeCounts),
            datasets: [
              {
                label: '工单类型',
                data: Object.values(ticketTypeCounts),
                backgroundColor: [
                  'rgba(255, 99, 132, 0.8)',
                  'rgba(54, 162, 235, 0.8)',
                  'rgba(255, 206, 86, 0.8)',
                  'rgba(75, 192, 192, 0.8)',
                  'rgba(153, 102, 255, 0.8)',
                  'rgba(255, 159, 64, 0.8)',
                  'rgba(201, 203, 207, 0.8)',
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
              },
            },
          },
        });
      }

      // 初始化用户工单排行图表
      function initUserWorkOrderChart() {
        const ctx = document.getElementById('userWorkOrderChart');
        if (!ctx) return;

        // 使用客服工单现有的getTickets()函数获取数据
        let workOrders = getTickets();

        // 过滤掉无效状态的工单
        workOrders = workOrders.filter((order) => {
          const status = order.status || '';
          return !['已删除', '已撤销', '已关闭'].includes(status);
        });

        // 统计每个用户的工单数量
        const userTicketCounts = {};

        workOrders.forEach((order) => {
          // 使用小区+楼号+单元+房号+业主姓名+电话作为用户唯一标识
          const userKey = `${order.community || ''}-${order.building || ''}-${order.unit || ''}-${order.room || ''}-${order.owner || ''}-${order.phone || ''}`;
          // 简化用户显示名称
          const userDisplay = `${order.community || '未知小区'}-${order.building || ''}-${order.unit || ''}-${order.room || ''}`;

          if (!userTicketCounts[userKey]) {
            userTicketCounts[userKey] = {
              display: userDisplay,
              count: 0,
            };
          }

          userTicketCounts[userKey].count++;
        });

        // 转换为数组并按工单数量降序排序
        const sortedUsers = Object.values(userTicketCounts)
          .sort((a, b) => b.count - a.count)
          // 取前30名
          .slice(0, 30);

        // 提取标签和数据
        const labels = sortedUsers.map((user) => user.display);
        const data = sortedUsers.map((user) => user.count);

        // 创建图表
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: '工单数量',
                data: data,
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: '用户',
                },
                // 如果标签太多，设置自动旋转
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                },
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: '工单数量',
                },
                ticks: {
                  stepSize: 1,
                },
              },
            },
            plugins: {
              legend: {
                display: false,
              },
            },
          },
        });
      }

      // 打开新建工单模态框
      function openNewWorkOrderModal() {
        if (document.getElementById('workOrderModal')) {
          document.getElementById('workOrderModal').style.display = 'flex';
          document.getElementById('modalTitle').textContent = '新建工单';
          document.getElementById('workOrderForm').reset();
          document.getElementById('modalWorkOrderId').value = '';
        }
      }

      // 关闭模态框
      function closeModal() {
        if (document.getElementById('workOrderModal')) {
          document.getElementById('workOrderModal').style.display = 'none';
        }
      }

      // 保存工单
      function saveWorkOrder(e) {
        e.preventDefault();

        // 获取表单数据
        const community = document.getElementById('modalCommunity').value;
        const building = document.getElementById('modalBuilding').value;
        const unit = document.getElementById('modalUnit').value;
        const room = document.getElementById('modalRoom').value;
        const contact = document.getElementById('modalContact').value;
        const phone = document.getElementById('modalPhone').value;
        const type = document.getElementById('modalType').value;
        const priority = document.getElementById('modalPriority').value;
        const description = document.getElementById('modalDescription').value;
        const status = document.getElementById('modalStatus').value;
        const workOrderId = document.getElementById('modalWorkOrderId').value;

        // 创建工单对象
        const workOrder = {
          id: workOrderId || `WO${Date.now()}`,
          community,
          building,
          unit,
          room,
          contact,
          phone,
          type,
          priority,
          description,
          status,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
        };

        // 保存到localStorage
        const existingOrders =
          JSON.parse(localStorage.getItem('idh_heating_tickets')) || [];

        if (workOrderId) {
          // 更新现有工单
          const index = existingOrders.findIndex(
            (order) => order.id === workOrderId,
          );
          if (index > -1) {
            existingOrders[index] = workOrder;
          }
        } else {
          // 添加新工单
          existingOrders.push(workOrder);
        }

        localStorage.setItem(
          'idh_heating_tickets',
          JSON.stringify(existingOrders),
        );

        // 更新数据和界面
        initWorkOrders();
        updateStats();
        closeModal();

        alert('工单保存成功！');
      }

      // 切换筛选器显示
      function toggleFilter() {
        const filterContainer = document.getElementById('workorderFilter');
        if (filterContainer) {
          filterContainer.style.display =
            filterContainer.style.display === 'none' ? 'flex' : 'none';
        }
      }

      // 应用筛选
      function applyFilter() {
        // 实现筛选逻辑
        const status = document.getElementById('filterStatus').value;
        const community = document.getElementById('filterCommunity').value;
        const timeRange = document.getElementById('filterTimeRange').value;

        // 根据筛选条件更新表格
        renderWorkOrderTable({
          status,
          community,
          timeRange,
        });
      }

      // 重置筛选
      function resetFilter() {
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterCommunity').value = '';
        document.getElementById('filterTimeRange').value = '';

        renderWorkOrderTable();
      }

      // 渲染工单表格
      function renderWorkOrderTable(filter = {}) {
        const tbody = document.getElementById('workOrderTableBody');
        const noDataMessage = document.getElementById('noWorkOrderMessage');

        if (!tbody || !noDataMessage) return;

        // 清空表格
        tbody.innerHTML = '';

        // 筛选工单
        let filteredOrders = [...workOrders];

        if (filter.status) {
          filteredOrders = filteredOrders.filter(
            (order) => order.status === filter.status,
          );
        }

        if (filter.community) {
          filteredOrders = filteredOrders.filter(
            (order) => order.community === filter.community,
          );
        }

        if (filter.timeRange) {
          const now = new Date();
          const startDate = new Date();

          switch (filter.timeRange) {
            case 'today':
              startDate.setHours(0, 0, 0, 0);
              break;
            case 'week':
              startDate.setDate(now.getDate() - 7);
              break;
            case 'month':
              startDate.setMonth(now.getMonth() - 1);
              break;
          }

          filteredOrders = filteredOrders.filter((order) => {
            const orderDate = new Date(order.createdAt);
            return orderDate >= startDate;
          });
        }

        // 按创建时间倒序排序
        filteredOrders.sort(
          (a, b) => new Date(b.createdAt) - new Date(a.createdAt),
        );

        // 如果没有数据，显示提示消息
        if (filteredOrders.length === 0) {
          noDataMessage.style.display = 'block';
          return;
        }

        noDataMessage.style.display = 'none';

        // 填充表格数据
        filteredOrders.forEach((order) => {
          const row = document.createElement('tr');

          row.innerHTML = `
                    <td>${order.id}</td>
                    <td>${order.community}</td>
                    <td>${order.building}-${order.unit}-${order.room}</td>
                    <td>${order.type}</td>
                    <td><span class="status-badge status-${order.status}">${order.status}</span></td>
                    <td>${new Date(order.createdAt).toLocaleString()}</td>
                    <td>${new Date(order.updatedAt).toLocaleString()}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="editWorkOrder('${order.id}')">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                        </div>
                    </td>
                `;

          tbody.appendChild(row);
        });
      }

      // 编辑工单
      function editWorkOrder(id) {
        const order = workOrders.find((order) => order.id === id);
        if (!order) return;

        // 填充表单
        document.getElementById('modalCommunity').value = order.community;
        document.getElementById('modalBuilding').value = order.building;
        document.getElementById('modalUnit').value = order.unit;
        document.getElementById('modalRoom').value = order.room;
        document.getElementById('modalContact').value = order.contact;
        document.getElementById('modalPhone').value = order.phone;
        document.getElementById('modalType').value = order.type;
        document.getElementById('modalPriority').value = order.priority;
        document.getElementById('modalDescription').value = order.description;
        document.getElementById('modalStatus').value = order.status;
        document.getElementById('modalWorkOrderId').value = order.id;

        // 显示模态框
        document.getElementById('modalTitle').textContent = '编辑工单';
        document.getElementById('workOrderModal').style.display = 'flex';
      }

      // 生成分析
      function generateAnalysis() {
        // 获取筛选条件
        const timeRange = document.getElementById('analysisTimeRange').value;
        const community = document.getElementById('analysisCommunity').value;
        const dimension = document.getElementById('analysisDimension').value;

        // 根据筛选条件生成分析报告
        const analysisResult = analyzeData(timeRange, community, dimension);

        // 更新分析摘要
        updateAnalysisSummary(analysisResult);

        // 更新分析图表
        updateAnalysisCharts(analysisResult);
      }

      // 数据分析函数
      function analyzeData(timeRange, community, dimension) {
        // 模拟数据分析结果
        return {
          timeRange,
          community,
          dimension,
          totalWorkOrders: workOrders.length,
          todayWorkOrders: workOrders.filter((order) => {
            const orderDate = new Date(order.createdAt);
            const today = new Date();
            return orderDate.toDateString() === today.toDateString();
          }).length,
          statusDistribution: {
            未开始: workOrders.filter((order) => order.status === '未开始')
              .length,
            进行中: workOrders.filter((order) => order.status === '进行中')
              .length,
            已办结: workOrders.filter((order) => order.status === '已办结')
              .length,
          },
          communityDistribution: workOrders.reduce((acc, order) => {
            acc[order.community] = (acc[order.community] || 0) + 1;
            return acc;
          }, {}),
        };
      }

      // 更新分析摘要
      function updateAnalysisSummary(analysisResult) {
        const summary = document.getElementById('analysisSummary');
        if (!summary) return;

        summary.innerHTML = `
                <h4>分析摘要</h4>
                <ul>
                    <li><strong>时间范围：</strong>${analysisResult.timeRange}</li>
                    <li><strong>小区：</strong>${analysisResult.community || '全部'}</li>
                    <li><strong>分析维度：</strong>${analysisResult.dimension}</li>
                    <li><strong>总工单数：</strong>${analysisResult.totalWorkOrders}</li>
                    <li><strong>今日工单：</strong>${analysisResult.todayWorkOrders}</li>
                    <li><strong>未开始工单：</strong>${analysisResult.statusDistribution['未开始']}</li>
                    <li><strong>进行中工单：</strong>${analysisResult.statusDistribution['进行中']}</li>
                    <li><strong>已办结工单：</strong>${analysisResult.statusDistribution['已办结']}</li>
                </ul>
            `;
      }

      // 更新分析图表
      function updateAnalysisCharts(analysisResult) {
        // 这里可以根据分析结果更新各种图表
        console.log('更新分析图表:', analysisResult);
      }

      // 保存系统设置
      function saveSettings() {
        const settings = {
          systemName: document.getElementById('systemName').value,
          defaultTimeRange: parseInt(
            document.getElementById('defaultTimeRange').value,
          ),
          backupFrequency: document.getElementById('backupFrequency').value,
        };

        localStorage.setItem('idhSettings', JSON.stringify(settings));
        systemSettings = settings;

        alert('系统设置保存成功！');
      }

      // 导入数据
      function importData() {
        alert('数据导入功能正在开发中...');
      }

      // 导出数据
      function exportData() {
        alert('数据导出功能正在开发中...');
      }

      // 预览导出数据
      function previewExportData() {
        alert('数据预览功能正在开发中...');
      }

      // 初始化每日缴费统计图表 - 柱状图
      function initDailyPaymentChart() {
        const ctx = document.getElementById('dailyPaymentChart');
        if (!ctx) return;

        // 获取收费记录数据
        const payments =
          JSON.parse(localStorage.getItem('idh_heating_payments')) || [];

        // 过滤掉无效记录，只保留已缴费记录
        const validPayments = payments.filter((payment) => {
          return (
            payment.status === 'paid' && payment.paymentDate && payment.paid
          );
        });

        if (validPayments.length === 0) {
          // 如果没有缴费数据，不绘制图表
          return;
        }

        // 按日期分组统计
        const dailyStats = {};

        validPayments.forEach((payment) => {
          const date = payment.paymentDate;
          if (!dailyStats[date]) {
            dailyStats[date] = {
              count: 0,
              amount: 0,
            };
          }
          dailyStats[date].count++;
          dailyStats[date].amount += parseFloat(payment.paid) || 0;
        });

        // 转换为数组并按日期排序
        const dates = Object.keys(dailyStats).sort();

        // 准备图表数据
        const labels = dates;
        const countData = dates.map((date) => dailyStats[date].count);
        const amountData = dates.map((date) => dailyStats[date].amount);

        // 创建图表
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: '每日缴费数',
                data: countData,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                yAxisID: 'y',
              },
              {
                label: '每日收费总额(元)',
                data: amountData,
                backgroundColor: 'rgba(255, 206, 86, 0.6)',
                borderColor: 'rgba(255, 206, 86, 1)',
                borderWidth: 1,
                yAxisID: 'y1',
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                  display: true,
                  text: '缴费数量',
                },
                beginAtZero: true,
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                  display: true,
                  text: '收费总额(元)',
                },
                beginAtZero: true,
                grid: {
                  drawOnChartArea: false,
                },
              },
              x: {
                title: {
                  display: true,
                  text: '日期',
                },
                // 如果日期太多，设置自动旋转
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                },
              },
            },
            plugins: {
              legend: {
                position: 'top',
              },
              title: {
                display: false,
              },
            },
          },
        });
      }

      // 初始化缴费方式分布图表
      function initPaymentMethodChart() {
        const ctx = document.getElementById('paymentMethodChart');
        if (!ctx) return;

        // 获取收费记录数据
        const payments =
          JSON.parse(localStorage.getItem('idh_heating_payments')) || [];

        // 过滤掉无效记录，只保留已缴费记录
        const validPayments = payments.filter((payment) => {
          return payment.status === 'paid' && payment.paymentMethod;
        });

        if (validPayments.length === 0) {
          // 如果没有缴费数据，不绘制图表
          return;
        }

        // 统计缴费方式分布
        const methodCounts = {};

        validPayments.forEach((payment) => {
          const method = payment.paymentMethod;
          methodCounts[method] = (methodCounts[method] || 0) + 1;
        });

        // 创建图表
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels: Object.keys(methodCounts),
            datasets: [
              {
                label: '缴费方式',
                data: Object.values(methodCounts),
                backgroundColor: [
                  'rgba(255, 99, 132, 0.8)',
                  'rgba(54, 162, 235, 0.8)',
                  'rgba(255, 206, 86, 0.8)',
                  'rgba(75, 192, 192, 0.8)',
                  'rgba(153, 102, 255, 0.8)',
                  'rgba(255, 159, 64, 0.8)',
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
              },
            },
          },
        });
      }

      // 初始化小区缴费统计图表
      function initCommunityPaymentChart() {
        const ctx = document.getElementById('communityPaymentChart');
        if (!ctx) return;

        // 获取收费记录数据
        const payments =
          JSON.parse(localStorage.getItem('idh_heating_payments')) || [];

        // 过滤掉无效记录，只保留已缴费记录
        const validPayments = payments.filter((payment) => {
          return payment.status === 'paid' && payment.community && payment.paid;
        });

        if (validPayments.length === 0) {
          // 如果没有缴费数据，不绘制图表
          return;
        }

        // 按小区分组统计
        const communityStats = {};

        validPayments.forEach((payment) => {
          const community = payment.community;
          if (!communityStats[community]) {
            communityStats[community] = {
              count: 0,
              amount: 0,
            };
          }
          communityStats[community].count++;
          communityStats[community].amount += parseFloat(payment.paid) || 0;
        });

        // 转换为数组并排序
        const sortedCommunities = Object.entries(communityStats)
          .sort((a, b) => b[1].amount - a[1].amount)
          .slice(0, 10); // 只显示前10个小区

        // 准备图表数据
        const labels = sortedCommunities.map((item) => item[0]);
        const countData = sortedCommunities.map((item) => item[1].count);
        const amountData = sortedCommunities.map((item) => item[1].amount);

        // 创建图表
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: '缴费数量',
                data: countData,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                yAxisID: 'y',
              },
              {
                label: '缴费金额(元)',
                data: amountData,
                backgroundColor: 'rgba(255, 206, 86, 0.6)',
                borderColor: 'rgba(255, 206, 86, 1)',
                borderWidth: 1,
                yAxisID: 'y1',
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                  display: true,
                  text: '缴费数量',
                },
                beginAtZero: true,
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                  display: true,
                  text: '缴费金额(元)',
                },
                beginAtZero: true,
                grid: {
                  drawOnChartArea: false,
                },
              },
              x: {
                title: {
                  display: true,
                  text: '小区',
                },
                // 如果小区名称太长，设置自动旋转
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                },
              },
            },
          },
        });
      }

      // 初始化缴费金额区间分布图表
      function initAmountRangeChart() {
        const ctx = document.getElementById('amountRangeChart');
        if (!ctx) return;

        // 获取收费记录数据
        const payments =
          JSON.parse(localStorage.getItem('idh_heating_payments')) || [];

        // 过滤掉无效记录，只保留已缴费记录
        const validPayments = payments.filter((payment) => {
          return payment.status === 'paid' && payment.paid;
        });

        if (validPayments.length === 0) {
          // 如果没有缴费数据，不绘制图表
          return;
        }

        // 定义金额区间
        const ranges = [
          '0-500',
          '500-1000',
          '1000-1500',
          '1500-2000',
          '2000-2500',
          '2500-3000',
          '3000以上',
        ];

        // 统计各区间的缴费数量
        const rangeCounts = {
          '0-500': 0,
          '500-1000': 0,
          '1000-1500': 0,
          '1500-2000': 0,
          '2000-2500': 0,
          '2500-3000': 0,
          '3000以上': 0,
        };

        validPayments.forEach((payment) => {
          const amount = parseFloat(payment.paid) || 0;

          if (amount < 500) {
            rangeCounts['0-500']++;
          } else if (amount < 1000) {
            rangeCounts['500-1000']++;
          } else if (amount < 1500) {
            rangeCounts['1000-1500']++;
          } else if (amount < 2000) {
            rangeCounts['1500-2000']++;
          } else if (amount < 2500) {
            rangeCounts['2000-2500']++;
          } else if (amount < 3000) {
            rangeCounts['2500-3000']++;
          } else {
            rangeCounts['3000以上']++;
          }
        });

        // 创建图表
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ranges,
            datasets: [
              {
                label: '缴费数量',
                data: Object.values(rangeCounts),
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: '缴费数量',
                },
              },
              x: {
                title: {
                  display: true,
                  text: '金额区间(元)',
                },
              },
            },
          },
        });
      }

      // 统计分析功能 - 结束

      // 退出登录功能
      function logout() {
        try {
          // 清除sessionStorage中的当前用户信息
          sessionStorage.removeItem('currentUser');

          // 跳转到登录页面
          window.location.href = 'login.html';
        } catch (error) {
          console.error('退出登录失败：', error);
          alert('退出登录失败，请重试！');
        }
      }

      // 切换到系统设置标签页
      function switchToSettings() {
        // 获取系统设置标签页按钮
        const settingsTabBtn = document.querySelector('[data-tab="settings"]');
        if (settingsTabBtn) {
          // 触发点击事件，切换到系统设置标签页
          settingsTabBtn.click();
        }
      }

      // 检查用户是否已登录
      function checkLoginStatus() {
        const currentUser = sessionStorage.getItem('currentUser');
        if (!currentUser) {
          // 如果未登录，跳转到登录页面
          window.location.href = 'login.html';
          return false;
        }
        return true;
      }

      // 页面加载时检查登录状态
      window.addEventListener('load', function () {
        checkLoginStatus();
      });

      // 初始化银行存现模块
      function initBankDepositModule() {
        // 设置默认日期为今天
        const today = new Date().toISOString().split('T')[0];
        const depositDateInput = document.getElementById('depositDate');
        if (depositDateInput) {
          depositDateInput.value = today;
        }

        // 绑定日期变化事件
        depositDateInput.addEventListener('change', function () {
          calculateDepositInfo(this.value);
        });

        // 绑定确认存现按钮事件
        const depositActionBtn = document.getElementById('depositActionBtn');
        if (depositActionBtn) {
          depositActionBtn.addEventListener('click', function () {
            confirmDeposit();
          });
        }

        // 初始化当天的存现信息
        calculateDepositInfo(today);
      }

      // 计算存现信息
      function calculateDepositInfo(date) {
        // 获取所有收费记录
        const payments =
          JSON.parse(localStorage.getItem('idh_heating_payments')) || [];

        // 筛选出指定日期的收费记录
        const todayPayments = payments.filter(
          (p) => p.status !== 'change' && p.paymentDate === date,
        );

        // 计算当日缴费数
        const depositCount = todayPayments.length;

        // 计算当日应存金额
        const depositShouldPay = todayPayments.reduce(
          (sum, p) => sum + parseFloat(p.paid || 0),
          0,
        );

        // 计算当日实存金额：分币位四舍五入到角
        const depositActualPay = Math.round(depositShouldPay * 10) / 10;

        // 计算存现损耗
        const depositLoss = depositShouldPay - depositActualPay;

        // 获取存现状态
        const depositRecords =
          JSON.parse(localStorage.getItem('idh_heating_deposit_records')) || {};
        const depositStatus = depositRecords[date] || '未存现';

        // 更新界面显示
        document.getElementById('depositCount').value = depositCount;
        document.getElementById('depositShouldPay').value =
          depositShouldPay.toFixed(2);
        document.getElementById('depositActualPay').value =
          depositActualPay.toFixed(2);
        document.getElementById('depositLoss').value = depositLoss.toFixed(2);
        document.getElementById('depositStatus').value = depositStatus;

        // 根据存现状态和当日缴费数启用或禁用确认存现按钮
        const depositActionBtn = document.getElementById('depositActionBtn');
        if (depositActionBtn) {
          depositActionBtn.disabled =
            depositStatus === '已存现' || depositCount === 0;
        }
      }

      // 确认存现
      function confirmDeposit() {
        const depositDate = document.getElementById('depositDate').value;

        // 获取当日应存金额
        const depositAmount =
          parseFloat(document.getElementById('depositShouldPay').value) || 0;

        if (
          confirm(
            '确认要将' +
              depositDate +
              '的缴费金额（¥' +
              depositAmount.toFixed(2) +
              '）存入银行吗？',
          )
        ) {
          // 获取存现损耗
          const depositLoss =
            parseFloat(document.getElementById('depositLoss').value) || 0;

          // 更新零钱余额：零钱余额 = 零钱余额 + 存现损耗
          const communityChange =
            JSON.parse(localStorage.getItem('idh_heating_community_change')) ||
            {};
          // 获取当前选中的小区，如果没有选中则不更新
          const communitySelect = document.getElementById('communitySelect');
          const selectedCommunity = communitySelect
            ? communitySelect.value
            : '';

          if (selectedCommunity) {
            // 从localStorage获取当前的零钱余额
            const currentChange =
              parseFloat(communityChange[selectedCommunity]) || 0;

            // 计算新的零钱余额
            const newChange = currentChange + depositLoss;

            // 保存更新后的零钱余额到localStorage
            communityChange[selectedCommunity] = newChange;
            localStorage.setItem(
              'idh_heating_community_change',
              JSON.stringify(communityChange),
            );

            // 更新界面显示的零钱余额
            const changeDisplay = document.getElementById('communityChange');
            if (changeDisplay) {
              changeDisplay.textContent = `¥${newChange.toFixed(2)}`;
            }
          }

          // 保存存现状态
          const depositRecords =
            JSON.parse(localStorage.getItem('idh_heating_deposit_records')) ||
            {};
          depositRecords[depositDate] = '已存现';
          localStorage.setItem(
            'idh_heating_deposit_records',
            JSON.stringify(depositRecords),
          );

          // 重新计算并更新存现信息，包括按钮状态
          calculateDepositInfo(depositDate);

          alert('存现成功！存现状态已更新为已存现。');
        }
      }
    </script>
  </body>
</html>
